<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>TravelSync ¬∑ Âú∞ÂúñÔºãÂ§öÂÖÉ‰∫§ÈÄö</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Google Maps API Áõ¥Êé•ËºâÂÖ• -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXCOcFaB80u9FjnEkQf-DlMOPqAJyGngA&libraries=places,geometry,marker&callback=initMap&v=weekly" async defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --accent: #2CC5C2;
            --accent-dark: #0C344E;
            --bg: #f5fbfb;
            --card: #ffffff;
            --muted: #6b7b86;
            --radius: 14px;
            --member-color: #FFB347;
            --member-dark: #FF8C00;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            font-family: 'Noto Sans', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f2fbfb 0%, #ebf8f8 100%);
            min-height: 100vh;
            padding: 10px 10px 10px 70px;
            touch-action: pan-y pinch-zoom;
            transition: padding 0.3s ease;
        }

        body.fullscreen-mode {
            padding: 0;
        }

        /* ==================== ÂÅ¥ÈÇäÂ∞éËà™ ==================== */
        .side-nav {
            position: fixed;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
            width: 55px;
            border-radius: 28px;
            box-shadow: 0 10px 30px rgba(12,52,78,0.08);
            z-index: 1000;
            padding: 12px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(44, 197, 194, 0.2);
            transition: all 0.3s ease;
        }

        .side-nav.fullscreen-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-50%) translateX(-20px);
        }

        .side-nav:hover {
            width: 150px;
        }

        .nav-items {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .side-nav:hover .nav-items {
            align-items: flex-start;
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            width: 100%;
            color: var(--muted);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 28px;
            position: relative;
            overflow: hidden;
            font-size: 14px;
        }

        .side-nav:not(:hover) .nav-item {
            justify-content: center;
        }

        .nav-item:hover {
            color: var(--accent-dark);
            background: rgba(44, 197, 194, 0.1);
        }

        .nav-item:active {
            background: rgba(44, 197, 194, 0.2);
        }

        .nav-item.active {
            color: var(--accent-dark);
            font-weight: 600;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 18px;
            background: var(--accent);
            border-radius: 0 3px 3px 0;
        }

        .nav-icon {
            font-size: 18px;
            min-width: 30px;
            text-align: center;
        }

        .nav-label {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s ease 0.1s;
        }

        .side-nav:hover .nav-label {
            opacity: 1;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            padding-left: 70px;
            flex-wrap: wrap;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .header.fullscreen-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-20px);
            margin-bottom: 0;
            height: 0;
        }

        .back-btn {
            padding: 10px 18px;
            background: white;
            border: 1px solid var(--accent);
            border-radius: 10px;
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            font-size: 15px;
            -webkit-tap-highlight-color: transparent;
        }

        .back-btn:active {
            transform: scale(0.95);
        }

        .header h1 {
            font-size: 22px;
            color: var(--accent-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            height: calc(100vh - 120px);
            padding-left: 70px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .container.fullscreen-mode {
            max-width: 100%;
            height: 100vh;
            padding-left: 0;
        }

        .map-card {
            background: var(--card);
            border-radius: var(--radius);
            height: 100%;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(6, 30, 38, 0.06);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: border-radius 0.3s ease;
        }

        .map-card.fullscreen-mode {
            border-radius: 0;
        }

        .map-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            border-bottom: 1px solid #eef2f2;
            flex-wrap: wrap;
            gap: 12px;
            background: white;
            z-index: 5;
            transition: transform 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
        }

        .map-header.fullscreen-hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
            margin: 0;
            padding: 0;
            height: 0;
            border: none;
        }

        .map-header h2 {
            color: var(--accent-dark);
            font-size: 18px;
            white-space: nowrap;
        }

        /* ==================== ÂÖ®Ëû¢ÂπïÊéßÂà∂ÊåâÈàï ==================== */
        .fullscreen-control {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 2002;
            display: flex;
            gap: 8px;
        }

        .fullscreen-btn {
            width: 44px;
            height: 44px;
            background: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        .fullscreen-btn:active {
            transform: scale(0.95);
        }

        .fullscreen-btn.exit {
            background: var(--accent-dark);
            color: white;
        }

        /* ==================== Áæ§ÁµÑÈÅ∏ÊìáÂô® ==================== */
        .group-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #eef2f2;
            flex-wrap: wrap;
            transition: transform 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
        }

        .group-selector.fullscreen-hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
            margin: 0;
            padding: 0;
            height: 0;
            border: none;
        }

        .group-selector-label {
            font-size: 14px;
            color: var(--accent-dark);
            font-weight: 500;
            white-space: nowrap;
        }

        .group-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            flex: 1;
        }

        .group-badge {
            padding: 6px 14px;
            background: #f0f8f8;
            border: 1px solid #e6eef0;
            border-radius: 30px;
            color: var(--accent-dark);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            -webkit-tap-highlight-color: transparent;
        }

        .group-badge:active {
            transform: scale(0.95);
        }

        .group-badge.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .group-badge i {
            font-size: 14px;
        }

        .group-badge .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            display: inline-block;
            margin-left: 4px;
        }

        .search-container {
            flex: 1;
            max-width: 450px;
            position: relative;
        }

        .search-box {
            display: flex;
            gap: 8px;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e6eef0;
            border-radius: 30px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
            -webkit-appearance: none;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(44, 197, 194, 0.1);
        }

        .search-btn {
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            white-space: nowrap;
        }

        .search-btn:active {
            transform: scale(0.95);
        }

        .pac-container {
            border-radius: 10px;
            margin-top: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #e6eef0;
            font-family: 'Noto Sans', 'Segoe UI', Roboto, sans-serif;
            z-index: 2000;
        }

        .pac-item {
            padding: 10px 15px;
            cursor: pointer;
            border-top: 1px solid #eef2f2;
            font-size: 14px;
        }

        .map-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .map-action-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e6eef0;
            border-radius: 20px;
            color: var(--accent-dark);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            white-space: nowrap;
        }

        .map-action-btn:active {
            transform: scale(0.95);
        }

        /* ==================== ÈôÑËøëË®≠ÊñΩÊåâÈàïÁµÑ ==================== */
        .nearby-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 0;
            background: transparent;
            border-bottom: none;
        }

        .nearby-btn {
            padding: 8px 16px;
            background: #f0f8f8;
            border: 1px solid #e6eef0;
            border-radius: 30px;
            color: var(--accent-dark);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nearby-btn:active {
            transform: scale(0.95);
        }

        .nearby-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .nearby-btn i {
            font-size: 16px;
        }

        /* ==================== ÊêúÂ∞ã‰æùÊìöÈÅ∏ÊìáÂô® ==================== */
        .search-location-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0;
            background: transparent;
            border-bottom: none;
        }

        .selector-label {
            font-size: 13px;
            color: var(--accent-dark);
            font-weight: 500;
            white-space: nowrap;
        }

        .selector-radio {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-size: 13px;
            color: var(--muted);
            transition: color 0.2s ease;
            white-space: nowrap;
        }

        .selector-radio:hover {
            color: var(--accent-dark);
        }

        .selector-radio input[type="radio"] {
            cursor: pointer;
            width: 15px;
            height: 15px;
            accent-color: var(--accent);
            margin: 0;
        }

        .route-mode-group {
            display: flex;
            gap: 6px;
            background: #f0f7f9;
            padding: 4px;
            border-radius: 30px;
            margin-right: 5px;
            flex-wrap: wrap;
        }
        
        .route-mode-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 500;
            color: var(--accent-dark);
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .route-mode-btn:active {
            transform: scale(0.95);
        }
        
        .route-mode-btn.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            color: var(--accent);
        }
        
        .route-mode-btn i { font-style: normal; font-size: 16px; }

        .map-container {
            flex: 1;
            position: relative;
            min-height: 400px;
            background-color: #f0f0f0;
            touch-action: pan-y pinch-zoom;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .map-container.fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2000;
        }

        #google-map {
            width: 100%;
            height: 100%;
            min-height: 400px;
            background-color: #e8eef0;
        }

        .location-button-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
            transition: bottom 0.3s ease;
        }

        .location-button-container.fullscreen-mode {
            bottom: calc(20px + var(--safe-area-bottom));
            left: 20px;
            z-index: 2001;
        }

        .location-button {
            width: 48px;
            height: 48px;
            background: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        .location-button:active {
            transform: scale(0.95);
        }

        .location-button.sharing {
            background: var(--member-color);
            color: white;
        }

        .location-info {
            position: fixed;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            color: var(--accent-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 2001;
            display: none;
            white-space: nowrap;
            max-width: 90%;
            text-align: center;
        }

        .location-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            text-align: center;
        }

        .location-loading .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        .info-window {
            padding: 10px;
            max-width: 220px;
            font-size: 13px;
        }

        .info-window-title {
            font-weight: 700;
            color: var(--accent-dark);
            margin-bottom: 5px;
            font-size: 14px;
        }

        .info-window-address {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 8px;
            word-break: break-word;
        }

        .info-window-rating {
            font-size: 12px;
            color: #f39c12;
            margin-bottom: 5px;
        }

        .info-window-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
        }

        .info-window-btn:active {
            transform: scale(0.95);
        }

        /* ==================== Ë∑ØÁ∑öÊëòË¶ÅÂç°Áâá - ÂèØ‰∏ä‰∏ãÁßªÂãï ==================== */
        .route-summary {
            position: absolute;
            bottom: 120px;
            left: 15px;
            right: 15px;
            background: white;
            border-radius: 20px;
            padding: 15px 18px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            max-width: none;
            font-size: 13px;
            border-left: 5px solid var(--accent);
            display: none;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.98);
            pointer-events: auto;
            transition: bottom 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
            margin-bottom: var(--safe-area-bottom);
        }
        
        .route-summary.show { 
            display: block; 
        }
        
        .route-summary.fullscreen-mode {
            bottom: calc(140px + var(--safe-area-bottom));
            left: 10px;
            right: 10px;
            z-index: 2001;
        }
        
        .route-summary.collapsed {
            transform: translateY(calc(100% - 50px));
            opacity: 0.9;
        }
        
        .route-summary.collapsed .route-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }
        
        .route-summary .route-content {
            max-height: 300px;
            opacity: 1;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }
        
        .route-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 5px 0;
            user-select: none;
        }
        
        .route-summary-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .route-summary-header-left strong {
            color: var(--accent-dark);
            font-size: 14px;
        }
        
        .route-summary-arrow {
            width: 36px;
            height: 36px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            -webkit-tap-highlight-color: transparent;
        }
        
        .route-summary-arrow:active {
            transform: scale(0.95);
        }
        
        .route-summary-arrow.up {
            background: var(--accent-dark);
        }
        
        .route-summary.collapsed .route-summary-arrow {
            transform: rotate(180deg);
        }
        
        .route-summary .close-route {
            float: right;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
            color: #aaa;
            font-size: 18px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .route-summary .close-route:active { transform: scale(0.95); }
        
        .route-summary strong { color: var(--accent-dark); }
        
        .route-summary .transit-details {
            margin-top: 8px;
            border-top: 1px dashed #ccc;
            padding-top: 8px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .route-summary .transit-step {
            display: flex;
            gap: 6px;
            margin: 5px 0;
            align-items: center;
            flex-wrap: wrap;
        }

        .map-error {
            padding: 30px;
            text-align: center;
            background: white;
            border-radius: 10px;
            margin: 20px;
        }
        
        .map-error h3 {
            color: #d32f2f;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .toast-message {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-dark);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
            max-width: 90%;
            text-align: center;
            margin-bottom: var(--safe-area-bottom);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .member-count-badge {
            background: var(--member-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* ÊâãÊ©üÁâàÈüøÊáâÂºè */
        @media (max-width: 768px) {
            body {
                padding: 8px 8px 8px 60px;
            }

            .header {
                padding-left: 60px;
                margin-bottom: 10px;
            }

            .header h1 {
                font-size: 20px;
            }

            .back-btn {
                padding: 8px 16px;
                font-size: 14px;
            }

            .container {
                padding-left: 60px;
                height: calc(100vh - 100px);
            }

            .map-header {
                padding: 10px 12px;
                flex-direction: column;
                align-items: stretch;
            }

            .map-header h2 {
                font-size: 16px;
                margin-bottom: 5px;
            }

            .search-container {
                max-width: 100%;
                width: 100%;
            }

            .search-box {
                width: 100%;
            }

            .search-input {
                padding: 10px 14px;
                font-size: 14px;
            }

            .search-btn {
                padding: 10px 18px;
                font-size: 14px;
            }

            .map-actions {
                width: 100%;
                justify-content: space-between;
            }

            .route-mode-group {
                flex: 1;
                justify-content: space-around;
            }

            .route-mode-btn {
                padding: 6px 10px;
                font-size: 13px;
            }

            .map-action-btn {
                padding: 8px 14px;
                font-size: 13px;
            }

            .group-selector {
                padding: 8px 12px;
            }

            .group-selector-label {
                font-size: 13px;
            }

            .group-badge {
                padding: 5px 12px;
                font-size: 12px;
            }

            .button-row {
                padding: 8px 12px !important;
            }

            .nearby-btn {
                padding: 7px 14px;
                font-size: 12px;
            }

            .search-location-selector {
                gap: 10px;
            }

            .selector-label {
                font-size: 12px;
            }

            .selector-radio {
                font-size: 12px;
            }

            .selector-radio input[type="radio"] {
                width: 14px;
                height: 14px;
            }

            .map-container {
                min-height: 450px;
            }

            #google-map {
                min-height: 450px;
            }

            .location-button {
                width: 48px;
                height: 48px;
                font-size: 24px;
            }

            .route-summary {
                bottom: 100px;
                left: 10px;
                right: 10px;
                padding: 12px 15px;
            }
            
            .route-summary.fullscreen-mode {
                bottom: calc(120px + var(--safe-area-bottom));
            }
            
            .route-summary-arrow {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }

            .group-badges {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 5px;
            }

            .group-badge {
                flex-shrink: 0;
            }
        }

        @media (max-width: 480px) {
            .map-header h2 {
                font-size: 16px;
            }

            .route-mode-btn {
                padding: 5px 8px;
                font-size: 12px;
            }

            .route-mode-btn i {
                font-size: 14px;
            }

            .nearby-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .nearby-btn i {
                font-size: 14px;
            }

            .search-input {
                padding: 8px 12px;
                font-size: 13px;
            }

            .search-btn {
                padding: 8px 16px;
                font-size: 13px;
            }

            .map-action-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .map-container {
                min-height: 400px;
            }

            #google-map {
                min-height: 400px;
            }

            .location-button {
                width: 44px;
                height: 44px;
                font-size: 22px;
            }

            .group-badge {
                padding: 4px 10px;
                font-size: 12px;
            }

            .selector-label {
                font-size: 12px;
            }

            .selector-radio {
                font-size: 12px;
            }

            .member-count-badge {
                font-size: 11px;
                padding: 2px 6px;
            }

            .route-summary {
                bottom: 90px;
            }
            
            .route-summary.fullscreen-mode {
                bottom: calc(110px + var(--safe-area-bottom));
            }
            
            .route-summary-arrow {
                width: 30px;
                height: 30px;
                font-size: 16px;
            }
        }

        @media (max-width: 375px) {
            .route-mode-btn {
                padding: 4px 6px;
                font-size: 11px;
            }

            .route-mode-btn i {
                font-size: 13px;
            }

            .nearby-btn {
                padding: 5px 10px;
                font-size: 11px;
            }

            .nearby-btn i {
                font-size: 13px;
            }

            .search-input {
                padding: 7px 10px;
                font-size: 12px;
            }

            .search-btn {
                padding: 7px 14px;
                font-size: 12px;
            }

            .map-action-btn {
                padding: 5px 10px;
                font-size: 11px;
            }

            .group-badge {
                padding: 3px 8px;
                font-size: 11px;
            }

            .selector-label {
                font-size: 11px;
            }

            .selector-radio {
                font-size: 11px;
            }

            .selector-radio input[type="radio"] {
                width: 13px;
                height: 13px;
            }

            .map-container {
                min-height: 350px;
            }

            #google-map {
                min-height: 350px;
            }

            .route-summary {
                bottom: 80px;
            }
            
            .route-summary.fullscreen-mode {
                bottom: calc(100px + var(--safe-area-bottom));
            }
        }

        /* iOS ÂÆâÂÖ®ÂçÄÂüüÊîØÊè¥ */
        @supports (padding: max(0px)) {
            .route-summary.fullscreen-mode {
                bottom: max(140px, calc(120px + env(safe-area-inset-bottom)));
            }
            
            .location-button-container.fullscreen-mode {
                bottom: max(20px, env(safe-area-inset-bottom));
            }
            
            @media (max-width: 768px) {
                .route-summary.fullscreen-mode {
                    bottom: max(120px, calc(100px + env(safe-area-inset-bottom)));
                }
            }
            
            @media (max-width: 480px) {
                .route-summary.fullscreen-mode {
                    bottom: max(110px, calc(90px + env(safe-area-inset-bottom)));
                }
            }
            
            @media (max-width: 375px) {
                .route-summary.fullscreen-mode {
                    bottom: max(100px, calc(80px + env(safe-area-inset-bottom)));
                }
            }
        }
    </style>
</head>
<body>
    <!-- ÂÅ¥ÈÇäÂ∞éËà™ -->
    <div class="side-nav" id="sideNav">
        <div class="nav-items">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">‰∏ªÈ†Å</span>
            </a>
            <a href="map.html" class="nav-item active">
                <span class="nav-icon">üó∫Ô∏è</span>
                <span class="nav-label">Âú∞Âúñ</span>
            </a>
            <a href="groups.html" class="nav-item">
                <span class="nav-icon">üë•</span>
                <span class="nav-label">Áæ§ÁµÑ</span>
            </a>
            <a href="ChatMessage.html" class="nav-item">
                <span class="nav-icon">üí¨</span>
                <span class="nav-label">ËÅäÂ§©</span>
            </a>
            <a href="profile.html" class="nav-item">
                <span class="nav-icon">üë§</span>
                <span class="nav-label">Â∏≥Ëôü</span>
            </a>
        </div>
    </div>

    <div class="header" id="header">
        <a href="index.html" class="back-btn">‚Üê ËøîÂõû</a>
        <h1>Âú∞Âúñ ¬∑ Â§öÂÖÉ‰∫§ÈÄö</h1>
    </div>

    <!-- Âú∞ÁêÜ‰ΩçÁΩÆËºâÂÖ•ÊèêÁ§∫ -->
    <div class="location-loading" id="locationLoading">
        <div class="spinner"></div>
        <p>Ê≠£Âú®Áç≤ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆ...</p>
        <p style="font-size: 12px; color: var(--muted); margin-top: 10px;">Ë´ãÂÖÅË®±ÁÄèË¶ΩÂô®Â≠òÂèñ‰ΩçÁΩÆ</p>
    </div>

    <!-- ‰ΩçÁΩÆË≥áË®äÈ°ØÁ§∫ -->
    <div class="location-info" id="locationInfo"></div>

    <div class="container" id="container">
        <div class="map-card" id="mapCard">
            <div class="map-header" id="mapHeader">
                <h2>üó∫Ô∏è Âç≥ÊôÇÂú∞Âúñ <span id="memberCountBadge" class="member-count-badge" style="display: none;">0 ‰∫∫Âú®Á∑ö</span></h2>
                
                <!-- ÊêúÂ∞ãÂàó -->
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" 
                               class="search-input" 
                               id="searchInput" 
                               placeholder="ÊêúÂ∞ãÂú∞Èªû„ÄÅÂú∞ÂùÄÊàñÂú∞Ê®ô..."
                               autocomplete="off">
                        <button class="search-btn" onclick="searchPlace()">ÊêúÂ∞ã</button>
                    </div>
                </div>

                <div class="map-actions">
                    <!-- ‰∫§ÈÄöÊ®°ÂºèÂàáÊèõ -->
                    <div class="route-mode-group" id="routeModeGroup">
                        <button class="route-mode-btn active" data-mode="DRIVING" onclick="setTravelMode('DRIVING')"><i>üöó</i> ÈñãËªä</button>
                        <button class="route-mode-btn" data-mode="TRANSIT" onclick="setTravelMode('TRANSIT')"><i>üöÜ</i> Â§ßÁúæÈÅãËº∏</button>
                        <button class="route-mode-btn" data-mode="WALKING" onclick="setTravelMode('WALKING')"><i>üö∂</i> Ê≠•Ë°å</button>
                        <button class="route-mode-btn" data-mode="BICYCLING" onclick="setTravelMode('BICYCLING')"><i>üö≤</i> ÂñÆËªä</button>
                    </div>
                    <button class="map-action-btn" onclick="window.location.href='meeting.html'">üéØ Âª∫Á´ãÊúÉÂêàÈªû</button>
                    <button class="map-action-btn" onclick="window.location.href='weather.html'">‚òÄÔ∏è Â§©Ê∞£Êü•Ë©¢</button>
                </div>
            </div>

            <!-- Áæ§ÁµÑÈÅ∏ÊìáÂô® -->
            <div class="group-selector" id="groupSelector">
                <span class="group-selector-label">ÊàëÁöÑÁæ§ÁµÑÔºö</span>
                <div class="group-badges" id="groupBadges">
                    <div class="group-badge loading-badge">
                        <div class="spinner small" style="width: 16px; height: 16px; margin: 0;"></div>
                        ËºâÂÖ•‰∏≠...
                    </div>
                </div>
            </div>

            <!-- ÈôÑËøëË®≠ÊñΩÊåâÈàïÂàó + ÊêúÂ∞ã‰æùÊìöÔºàÂêå‰∏ÄË°åÔºâ -->
            <div class="button-row" id="buttonRow" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: white; border-bottom: 1px solid #eef2f2; flex-wrap: wrap; gap: 10px;">
                <!-- Â∑¶ÂÅ¥ÔºöÈôÑËøëË®≠ÊñΩÊåâÈàï -->
                <div class="nearby-buttons" style="display: flex; gap: 8px; flex-wrap: wrap; padding: 0; border-bottom: none; flex: 1;">
                    <button class="nearby-btn" onclick="searchNearby('restaurant')" id="btnRestaurant">
                        <i>üçΩÔ∏è</i> È§êÂª≥
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('hotel')" id="btnHotel">
                        <i>üè®</i> ÈÖíÂ∫ó
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('convenience_store')" id="btnStore">
                        <i>üè™</i> ‰æøÂà©Â∫ó
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('cafe')" id="btnCafe">
                        <i>‚òï</i> ÂíñÂï°Âª≥
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('gas_station')" id="btnGas">
                        <i>‚õΩ</i> Âä†Ê≤πÁ´ô
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('parking')" id="btnParking">
                        <i>üÖøÔ∏è</i> ÂÅúËªäÂ†¥
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('hospital')" id="btnHospital">
                        <i>üè•</i> ÈÜ´Èô¢
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('atm')" id="btnATM">
                        <i>üèß</i> ÊèêÊ¨æÊ©ü
                    </button>
                </div>
                
                <!-- Âè≥ÂÅ¥ÔºöÊêúÂ∞ã‰æùÊìö -->
                <div class="search-location-selector" style="display: flex; align-items: center; gap: 15px; padding: 0; border-bottom: none;">
                    <span class="selector-label" style="font-size: 13px; color: var(--accent-dark); font-weight: 500; white-space: nowrap;">ÊêúÂ∞ã‰æùÊìöÔºö</span>
                    <label class="selector-radio" style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px; color: var(--muted); white-space: nowrap;">
                        <input type="radio" name="searchLocation" value="center" checked onchange="updateSearchLocation()" style="accent-color: var(--accent);">
                        <span>üìç Âú∞Âúñ‰∏≠ÂøÉ</span>
                    </label>
                    <label class="selector-radio" style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px; color: var(--muted); white-space: nowrap;">
                        <input type="radio" name="searchLocation" value="current" onchange="updateSearchLocation()" style="accent-color: var(--accent);">
                        <span>üìç ÊàëÁöÑ‰ΩçÁΩÆ</span>
                    </label>
                </div>
            </div>
            
            <!-- Âú∞ÂúñÂÆπÂô® -->
            <div class="map-container" id="mapContainer">
                <!-- ÂÖ®Ëû¢ÂπïÊéßÂà∂ÊåâÈàï -->
                <div class="fullscreen-control">
                    <button class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()" title="ÂÖ®Ëû¢ÂπïÈ°ØÁ§∫Âú∞Âúñ">
                        <span>‚õ∂</span>
                    </button>
                </div>
                <div id="google-map"></div>
                
                <!-- Ë∑ØÁ∑öÊëòË¶ÅÂç°Áâá -->
                <div class="route-summary" id="routeSummary">
                    <div class="route-summary-header" onclick="toggleRouteCollapse()">
                        <div class="route-summary-header-left">
                            <strong>üìç ÊúÄ‰Ω≥Ë∑ØÁ∑ö</strong>
                        </div>
                        <button class="route-summary-arrow" id="routeArrow" onclick="event.stopPropagation(); toggleRouteCollapse()">
                            ‚ñº
                        </button>
                    </div>
                    <div class="route-content" id="routeContent">
                        <span class="close-route" onclick="closeRoutePanel()">‚úï</span>
                        <div id="routeSummaryContent"></div>
                        <div id="transitDetailed" class="transit-details"></div>
                    </div>
                </div>
            </div>
            
            <!-- ÂÆö‰ΩçÊåâÈàïÂÆπÂô® -->
            <div class="location-button-container" id="locationButtonContainer">
                <button class="location-button" onclick="getCurrentLocationAndCenter()" title="È°ØÁ§∫ÊàëÁöÑ‰ΩçÁΩÆ">
                    <span>üìç</span>
                </button>
                <button class="location-button" id="shareLocationBtn" onclick="toggleLocationSharing()" title="ÂàÜ‰∫´‰ΩçÁΩÆÁµ¶ÊâÄÈÅ∏Áæ§ÁµÑ" style="display: none;">
                    <span>üë•</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase ÈÖçÁΩÆ
        const firebaseConfig = {
            apiKey: "AIzaSyBhvbTPl-hGv1MWtrua55LuvIUpdabqy4M",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "project-221c4",
            storageBucket: "project-221c4.firebasestorage.app",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Âú∞ÂúñËÆäÊï∏
        let map;
        let geocoder;
        let placesService;
        let autocomplete;
        let searchMarker;
        let currentLocationMarker;
        let userLocationCircle;
        let meetingLocationMarker;
        let meetingInfoWindow;
        let directionsService;
        let directionsRenderer;
        let currentDestinationPosition = null;
        let lastOriginPosition = null;
        let currentTravelMode = 'DRIVING';
        let isMapInitialized = false;
        let resizeTimer;
        let currentInfoWindow = null;
        let nearbyMarkers = [];
        
        // Áæ§ÁµÑ‰ΩçÁΩÆÂàÜ‰∫´ËÆäÊï∏
        let searchLocationType = 'center';
        let currentUserLocation = null;
        let selectedGroupId = null;
        let userGroups = [];
        let isSharingLocation = false;
        let locationShareInterval = null;
        let groupMembersMarkers = [];
        let unsubscribeLocations = null;
        let unsubscribeGroupLocations = null;

        // ÂÖ®Ëû¢ÂπïÁãÄÊÖã
        let isFullscreen = false;
        
        // Ë∑ØÁ∑öÊëòË¶ÅÊäòÁñäÁãÄÊÖã
        let isRouteCollapsed = false;

        // È°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ÂàáÊèõË∑ØÁ∑öÊëòË¶ÅÊäòÁñäÁãÄÊÖã
        window.toggleRouteCollapse = function() {
            const routeSummary = document.getElementById('routeSummary');
            const routeArrow = document.getElementById('routeArrow');
            
            isRouteCollapsed = !isRouteCollapsed;
            
            if (isRouteCollapsed) {
                routeSummary.classList.add('collapsed');
                routeArrow.classList.add('up');
                routeArrow.innerHTML = '‚ñ≤';
            } else {
                routeSummary.classList.remove('collapsed');
                routeArrow.classList.remove('up');
                routeArrow.innerHTML = '‚ñº';
            }
        };

        // ÂàáÊèõÂÖ®Ëû¢ÂπïÊ®°Âºè
        window.toggleFullscreen = function() {
            isFullscreen = !isFullscreen;
            
            const body = document.body;
            const sideNav = document.getElementById('sideNav');
            const header = document.getElementById('header');
            const container = document.getElementById('container');
            const mapCard = document.getElementById('mapCard');
            const mapHeader = document.getElementById('mapHeader');
            const groupSelector = document.getElementById('groupSelector');
            const buttonRow = document.getElementById('buttonRow');
            const mapContainer = document.getElementById('mapContainer');
            const locationButtonContainer = document.getElementById('locationButtonContainer');
            const routeSummary = document.getElementById('routeSummary');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            if (isFullscreen) {
                body.classList.add('fullscreen-mode');
                sideNav.classList.add('fullscreen-hidden');
                header.classList.add('fullscreen-hidden');
                container.classList.add('fullscreen-mode');
                mapCard.classList.add('fullscreen-mode');
                mapHeader.classList.add('fullscreen-hidden');
                groupSelector.classList.add('fullscreen-hidden');
                buttonRow.classList.add('fullscreen-hidden');
                mapContainer.classList.add('fullscreen-mode');
                locationButtonContainer.classList.add('fullscreen-mode');
                routeSummary.classList.add('fullscreen-mode');
                fullscreenBtn.classList.add('exit');
                fullscreenBtn.innerHTML = '<span>‚úï</span>';
                fullscreenBtn.title = 'ÈÄÄÂá∫ÂÖ®Ëû¢Âπï';
                
                // Ëß∏ÁôºÂú∞Âúñ resize ‰∫ã‰ª∂
                setTimeout(() => {
                    if (map) {
                        google.maps.event.trigger(map, 'resize');
                    }
                }, 100);
            } else {
                body.classList.remove('fullscreen-mode');
                sideNav.classList.remove('fullscreen-hidden');
                header.classList.remove('fullscreen-hidden');
                container.classList.remove('fullscreen-mode');
                mapCard.classList.remove('fullscreen-mode');
                mapHeader.classList.remove('fullscreen-hidden');
                groupSelector.classList.remove('fullscreen-hidden');
                buttonRow.classList.remove('fullscreen-hidden');
                mapContainer.classList.remove('fullscreen-mode');
                locationButtonContainer.classList.remove('fullscreen-mode');
                routeSummary.classList.remove('fullscreen-mode');
                fullscreenBtn.classList.remove('exit');
                fullscreenBtn.innerHTML = '<span>‚õ∂</span>';
                fullscreenBtn.title = 'ÂÖ®Ëû¢ÂπïÈ°ØÁ§∫Âú∞Âúñ';
                
                // Ëß∏ÁôºÂú∞Âúñ resize ‰∫ã‰ª∂
                setTimeout(() => {
                    if (map) {
                        google.maps.event.trigger(map, 'resize');
                    }
                }, 100);
            }
        };

        // Google Âú∞ÂúñÂàùÂßãÂåñ
        window.initMap = function() {
            console.log('initMap ÈñãÂßãÂü∑Ë°å');
            
            const mapElement = document.getElementById("google-map");
            if (!mapElement) {
                console.error("Êâæ‰∏çÂà∞Âú∞ÂúñÂÆπÂô®");
                return;
            }

            try {
                map = new google.maps.Map(mapElement, {
                    center: { lat: 25.0330, lng: 121.5654 },
                    zoom: 12,
                    mapTypeControl: true,
                    fullscreenControl: false, // ÈóúÈñâÂÖßÂª∫ÂÖ®Ëû¢ÂπïÔºå‰ΩøÁî®Ëá™Ë®Ç
                    streetViewControl: true,
                    zoomControl: true,
                    gestureHandling: 'greedy',
                    mapId: 'YOUR_MAP_ID'
                });

                console.log("Âú∞ÂúñÂª∫Á´ãÊàêÂäü");

                geocoder = new google.maps.Geocoder();
                placesService = new google.maps.places.PlacesService(map);
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: false,
                    preserveViewport: false,
                    polylineOptions: {
                        strokeColor: "#2CC5C2",
                        strokeWeight: 5,
                        strokeOpacity: 0.8
                    }
                });

                initAutocomplete();
                
                isMapInitialized = true;
                console.log("ÊâÄÊúâÊúçÂãôÂàùÂßãÂåñÂÆåÊàê");
                
                showMeetingLocationFromStorage();
                
                // Âú∞Âúñ‰∏≠ÂøÉÈªûËÆäÊõ¥ÊôÇÊõ¥Êñ∞Ë≥áË®ä
                google.maps.event.addListener(map, 'center_changed', function() {
                    if (searchLocationType === 'center') {
                        console.log('Âú∞Âúñ‰∏≠ÂøÉÈªûÂ∑≤ÁßªÂãï');
                    }
                });
                
                // ËºâÂÖ•Áî®Êà∂Áæ§ÁµÑ
                loadUserGroups();
                
            } catch (error) {
                console.error("Âú∞ÂúñÂàùÂßãÂåñÈåØË™§:", error);
                mapElement.innerHTML = `<div class="map-error">
                    <h3>Âú∞ÂúñËºâÂÖ•Â§±Êïó</h3>
                    <p>${error.message}</p>
                    <p>Ë´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢</p>
                </div>`;
            }
        };

        // ËôïÁêÜÊâãÊ©üÊóãËΩâÊôÇÂú∞ÂúñÂ§ßÂ∞èË™øÊï¥
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                }
            }, 250);
        });

        // ÂàùÂßãÂåñ Google Places Ëá™ÂãïÂÆåÊàê
        function initAutocomplete() {
            const input = document.getElementById('searchInput');
            if (!input) return;
            
            autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['establishment', 'geocode'],
                fields: ['place_id', 'name', 'formatted_address', 'geometry']
            });

            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                if (place && place.geometry) {
                    handlePlaceSelected(place);
                }
            });
        }

        // Ê∏ÖÈô§ÊâÄÊúâÈôÑËøëË®≠ÊñΩÊ®ôË®ò
        function clearNearbyMarkers() {
            nearbyMarkers.forEach(marker => marker.setMap(null));
            nearbyMarkers = [];
            document.querySelectorAll('.nearby-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        // Êõ¥Êñ∞ÊêúÂ∞ã‰æùÊìö
        window.updateSearchLocation = function() {
            const radios = document.getElementsByName('searchLocation');
            for (let radio of radios) {
                if (radio.checked) {
                    searchLocationType = radio.value;
                    break;
                }
            }
            
            console.log(`ÊêúÂ∞ã‰æùÊìöÂàáÊèõÁÇ∫Ôºö${searchLocationType === 'center' ? 'Âú∞Âúñ‰∏≠ÂøÉÈªû' : 'ÊàëÁöÑ‰ΩçÁΩÆ'}`);
            
            if (searchLocationType === 'current' && !currentUserLocation) {
                showToast('Ë´ãÂÖàÈªûÊìäÂÆö‰ΩçÊåâÈàïÁç≤ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆ');
            }
        }

        // ËºâÂÖ•Áî®Êà∂ÁöÑÊâÄÊúâÁæ§ÁµÑ
        async function loadUserGroups() {
            const user = auth.currentUser;
            if (!user) return;
            
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists && userDoc.data().groups) {
                    const groups = userDoc.data().groups;
                    
                    // ËΩâÊèõÁÇ∫Èô£Âàó
                    if (Array.isArray(groups)) {
                        userGroups = groups;
                    } else if (typeof groups === 'object') {
                        userGroups = Object.values(groups);
                    }
                    
                    if (userGroups.length > 0) {
                        // Áç≤ÂèñÁæ§ÁµÑË©≥Á¥∞Ë≥áË®äÂíåÁ∑ö‰∏ä‰∫∫Êï∏
                        await loadGroupDetails();
                        
                        // È†êË®≠ÈÅ∏ÊìáÁ¨¨‰∏ÄÂÄãÁæ§ÁµÑ
                        if (!selectedGroupId && userGroups.length > 0) {
                            selectedGroupId = userGroups[0].groupId;
                        }
                        
                        renderGroupBadges();
                        
                        // Â¶ÇÊûúÂ∑≤ÈÅ∏ÊìáÁæ§ÁµÑÔºåÈñãÂßãÁõ£ËÅΩË©≤Áæ§ÁµÑÁöÑ‰ΩçÁΩÆ
                        if (selectedGroupId) {
                            document.getElementById('shareLocationBtn').style.display = 'flex';
                            listenSelectedGroupLocation();
                        }
                    } else {
                        document.getElementById('groupBadges').innerHTML = '<div class="group-badge" style="background: transparent; border: 1px dashed #e6eef0;">Â∞öÊú™Âä†ÂÖ•Áæ§ÁµÑ</div>';
                    }
                } else {
                    document.getElementById('groupBadges').innerHTML = '<div class="group-badge" style="background: transparent; border: 1px dashed #e6eef0;">Â∞öÊú™Âä†ÂÖ•Áæ§ÁµÑ</div>';
                }
            } catch (error) {
                console.error('ËºâÂÖ•Áæ§ÁµÑÈåØË™§:', error);
                document.getElementById('groupBadges').innerHTML = '<div class="group-badge" style="background: #ff5a5f; color: white;">ËºâÂÖ•Â§±Êïó</div>';
            }
        }

        // ËºâÂÖ•Áæ§ÁµÑË©≥Á¥∞Ë≥áË®ä
        async function loadGroupDetails() {
            const promises = userGroups.map(async (group) => {
                try {
                    const groupDoc = await db.collection('groups').doc(group.groupId).get();
                    if (groupDoc.exists) {
                        group.groupName = groupDoc.data().name || 'Êú™ÂëΩÂêçÁæ§ÁµÑ';
                        
                        // Áç≤ÂèñË©≤Áæ§ÁµÑÁöÑÁ∑ö‰∏ä‰∫∫Êï∏
                        const locationsSnapshot = await db.collection('groups')
                            .doc(group.groupId)
                            .collection('locations')
                            .get();
                        
                        group.onlineCount = locationsSnapshot.size;
                    }
                } catch (error) {
                    console.error('ËºâÂÖ•Áæ§ÁµÑË©≥Á¥∞Ë≥áË®äÈåØË™§:', error);
                    group.groupName = group.groupName || 'Êú™Áü•Áæ§ÁµÑ';
                    group.onlineCount = 0;
                }
            });
            
            await Promise.all(promises);
        }

        // Ê∏≤ÊüìÁæ§ÁµÑÊ®ôÁ±§
        function renderGroupBadges() {
            const container = document.getElementById('groupBadges');
            
            if (userGroups.length === 0) {
                container.innerHTML = '<div class="group-badge" style="background: transparent; border: 1px dashed #e6eef0;">Â∞öÊú™Âä†ÂÖ•Áæ§ÁµÑ</div>';
                return;
            }
            
            container.innerHTML = userGroups.map(group => {
                const isSelected = group.groupId === selectedGroupId;
                const onlineCount = group.onlineCount || 0;
                const displayName = group.groupName && group.groupName.length > 12 ? group.groupName.substring(0, 10) + '‚Ä¶' : (group.groupName || 'Áæ§ÁµÑ');
                
                return `
                    <div class="group-badge ${isSelected ? 'active' : ''}" 
                         onclick="selectGroup('${group.groupId}')"
                         title="Á∑ö‰∏äÊàêÂì°: ${onlineCount}‰∫∫">
                        <i>üë•</i>
                        ${displayName}
                        ${onlineCount > 0 ? `<span class="online-indicator"></span>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ÈÅ∏ÊìáÁæ§ÁµÑ
        window.selectGroup = function(groupId) {
            if (selectedGroupId === groupId) return;
            
            // Â¶ÇÊûúÊ≠£Âú®ÂàÜ‰∫´‰ΩçÁΩÆÔºåÂÖàÂÅúÊ≠¢
            if (isSharingLocation) {
                stopSharingLocation();
            }
            
            // Ê∏ÖÈô§ËàäÁöÑÁæ§ÁµÑÊàêÂì°Ê®ôË®ò
            clearGroupMembersMarkers();
            
            // ÂèñÊ∂àË®ÇÈñ±ËàäÁöÑÁõ£ËÅΩ
            if (unsubscribeGroupLocations) {
                unsubscribeGroupLocations();
            }
            
            selectedGroupId = groupId;
            
            // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
            renderGroupBadges();
            
            // È°ØÁ§∫ÂàÜ‰∫´ÊåâÈàï
            document.getElementById('shareLocationBtn').style.display = 'flex';
            
            // Áõ£ËÅΩÊñ∞Áæ§ÁµÑÁöÑ‰ΩçÁΩÆ
            listenSelectedGroupLocation();
            
            showToast(`Â∑≤ÂàáÊèõÂà∞ÊâÄÈÅ∏Áæ§ÁµÑ`);
        }

        // Ê∏ÖÈô§Áæ§ÁµÑÊàêÂì°Ê®ôË®ò
        function clearGroupMembersMarkers() {
            groupMembersMarkers.forEach(item => {
                if (item.marker) item.marker.setMap(null);
            });
            groupMembersMarkers = [];
        }

        // Áõ£ËÅΩÊâÄÈÅ∏Áæ§ÁµÑÁöÑ‰ΩçÁΩÆ
        function listenSelectedGroupLocation() {
            const user = auth.currentUser;
            if (!user || !selectedGroupId) return;
            
            if (unsubscribeGroupLocations) {
                unsubscribeGroupLocations();
            }
            
            const locationsRef = db.collection('groups')
                .doc(selectedGroupId)
                .collection('locations');
            
            unsubscribeGroupLocations = locationsRef.onSnapshot((snapshot) => {
                // Êõ¥Êñ∞Âú®Á∑ö‰∫∫Êï∏
                const onlineCount = snapshot.docs.length;
                const badge = document.getElementById('memberCountBadge');
                
                // Êõ¥Êñ∞Â∞çÊáâÁæ§ÁµÑÊ®ôÁ±§ÁöÑÁ∑ö‰∏ä‰∫∫Êï∏
                const groupIndex = userGroups.findIndex(g => g.groupId === selectedGroupId);
                if (groupIndex !== -1) {
                    userGroups[groupIndex].onlineCount = onlineCount;
                    renderGroupBadges();
                }
                
                if (onlineCount > 0) {
                    badge.style.display = 'inline-block';
                    badge.textContent = `${onlineCount} ‰∫∫Âú®Á∑ö`;
                } else {
                    badge.style.display = 'none';
                }
                
                // Ê∏ÖÈô§ËàäÊ®ôË®ò
                clearGroupMembersMarkers();
                
                // ÁÇ∫ÊØèÂÄãÊàêÂì°Âª∫Á´ãÊñ∞Ê®ôË®ò
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const memberId = doc.id;
                    
                    if (memberId === user.uid) return;
                    
                    updateMemberMarker(memberId, data);
                });
            }, (error) => {
                console.error('Áõ£ËÅΩ‰ΩçÁΩÆÈåØË™§:', error);
            });
        }

        // Êõ¥Êñ∞ÊàêÂì°Ê®ôË®ò
        function updateMemberMarker(memberId, locationData) {
            const lastUpdate = locationData.timestamp?.toDate?.() || new Date(locationData.timestamp);
            const now = new Date();
            const diffMinutes = (now - lastUpdate) / 1000 / 60;
            
            if (diffMinutes > 1) {
                return;
            }
            
            const position = {
                lat: locationData.latitude,
                lng: locationData.longitude
            };
            
            const markerContent = document.createElement('div');
            markerContent.style.position = 'relative';
            markerContent.style.width = '36px';
            markerContent.style.height = '36px';
            markerContent.style.cursor = 'pointer';
            
            if (locationData.avatarUrl) {
                const img = document.createElement('img');
                img.src = locationData.avatarUrl;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.borderRadius = '50%';
                img.style.border = '2px solid var(--member-color)';
                img.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
                img.style.objectFit = 'cover';
                markerContent.appendChild(img);
            } else {
                const defaultIcon = document.createElement('div');
                defaultIcon.style.width = '100%';
                defaultIcon.style.height = '100%';
                defaultIcon.style.borderRadius = '50%';
                defaultIcon.style.background = 'linear-gradient(135deg, var(--member-color), var(--member-dark))';
                defaultIcon.style.border = '2px solid white';
                defaultIcon.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
                defaultIcon.style.display = 'flex';
                defaultIcon.style.alignItems = 'center';
                defaultIcon.style.justifyContent = 'center';
                defaultIcon.style.color = 'white';
                defaultIcon.style.fontSize = '16px';
                defaultIcon.style.fontWeight = 'bold';
                defaultIcon.textContent = locationData.name ? locationData.name.charAt(0).toUpperCase() : '?';
                markerContent.appendChild(defaultIcon);
            }
            
            const pulse = document.createElement('div');
            pulse.style.position = 'absolute';
            pulse.style.top = '50%';
            pulse.style.left = '50%';
            pulse.style.transform = 'translate(-50%, -50%)';
            pulse.style.width = '100%';
            pulse.style.height = '100%';
            pulse.style.borderRadius = '50%';
            pulse.style.border = '2px solid var(--member-color)';
            pulse.style.animation = 'pulse 2s ease-out infinite';
            pulse.style.pointerEvents = 'none';
            markerContent.appendChild(pulse);
            
            let marker;
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                marker = new google.maps.marker.AdvancedMarkerElement({
                    map: map,
                    position: position,
                    content: markerContent,
                    title: locationData.name || 'Áæ§ÁµÑÊàêÂì°'
                });
            } else {
                marker = new google.maps.Marker({
                    map: map,
                    position: position,
                    title: locationData.name || 'Áæ§ÁµÑÊàêÂì°',
                    icon: {
                        url: locationData.avatarUrl || 'data:image/svg+xml,' + encodeURIComponent(`
                            <svg width="36" height="36" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="18" cy="18" r="16" fill="#FFB347" stroke="white" stroke-width="2"/>
                                <text x="18" y="24" font-size="14" font-weight="bold" text-anchor="middle" fill="white">${locationData.name ? locationData.name.charAt(0).toUpperCase() : '?'}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(36, 36)
                    }
                });
            }
            
            groupMembersMarkers.push({
                memberId: memberId,
                marker: marker,
                content: markerContent
            });
            
            markerContent.addEventListener('click', () => {
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding:10px; text-align:center;">
                            ${locationData.avatarUrl ? `<img src="${locationData.avatarUrl}" style="width:45px; height:45px; border-radius:50%; margin-bottom:8px; object-fit:cover;">` : ''}
                            <div style="font-weight:bold; color:var(--accent-dark);">${locationData.name || 'Áæ§ÁµÑÊàêÂì°'}</div>
                            <div style="font-size:11px; color:var(--muted);">ÊúÄÂæåÊõ¥Êñ∞: ${lastUpdate.toLocaleTimeString()}</div>
                        </div>
                    `
                });
                infoWindow.open(map, marker);
            });
        }

        // ÂàáÊèõ‰ΩçÁΩÆÂàÜ‰∫´
        window.toggleLocationSharing = function() {
            if (!currentUserLocation) {
                showToast('Ë´ãÂÖàÁç≤ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆ');
                return;
            }
            
            if (!selectedGroupId) {
                showToast('Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÄãÁæ§ÁµÑ');
                return;
            }
            
            const btn = document.getElementById('shareLocationBtn');
            
            if (isSharingLocation) {
                stopSharingLocation();
                btn.classList.remove('sharing');
                btn.style.background = 'white';
                btn.style.color = 'var(--accent-dark)';
            } else {
                startSharingLocation();
                btn.classList.add('sharing');
                btn.style.background = 'var(--member-color)';
                btn.style.color = 'white';
            }
        }

        // ÈñãÂßãÂàÜ‰∫´‰ΩçÁΩÆ
        function startSharingLocation() {
            if (!currentUserLocation || !selectedGroupId) {
                showToast('Ë´ãÂÖàÁç≤ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆ');
                return;
            }
            
            if (isSharingLocation) return;
            
            isSharingLocation = true;
            
            shareCurrentLocation();
            locationShareInterval = setInterval(shareCurrentLocation, 30000);
            
            showToast(`üìç Ê≠£Âú®ÂàÜ‰∫´ÊÇ®ÁöÑ‰ΩçÁΩÆÁµ¶ÊâÄÈÅ∏Áæ§ÁµÑ`);
        }

        // ÂÅúÊ≠¢ÂàÜ‰∫´‰ΩçÁΩÆ
        function stopSharingLocation() {
            if (locationShareInterval) {
                clearInterval(locationShareInterval);
                locationShareInterval = null;
            }
            
            if (selectedGroupId && auth.currentUser) {
                db.collection('groups')
                    .doc(selectedGroupId)
                    .collection('locations')
                    .doc(auth.currentUser.uid)
                    .delete()
                    .catch(error => console.error('ÁßªÈô§‰ΩçÁΩÆÈåØË™§:', error));
            }
            
            isSharingLocation = false;
            showToast('üõë Â∑≤ÂÅúÊ≠¢ÂàÜ‰∫´‰ΩçÁΩÆ');
        }

        // ÂàÜ‰∫´ÁõÆÂâç‰ΩçÁΩÆ
        async function shareCurrentLocation() {
            if (!currentUserLocation || !selectedGroupId || !auth.currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
                const userData = userDoc.exists ? userDoc.data() : {};
                
                const locationData = {
                    userId: auth.currentUser.uid,
                    name: userData.username || auth.currentUser.displayName || 'Áî®Êà∂',
                    avatarUrl: userData.profileImageUrl || null,
                    latitude: currentUserLocation.lat,
                    longitude: currentUserLocation.lng,
                    accuracy: currentUserLocation.accuracy || 0,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('groups')
                    .doc(selectedGroupId)
                    .collection('locations')
                    .doc(auth.currentUser.uid)
                    .set(locationData);
                    
            } catch (error) {
                console.error('ÂàÜ‰∫´‰ΩçÁΩÆÈåØË™§:', error);
            }
        }

        // Âª∫Á´ãËá™ÂÆöÁæ©È†≠ÂÉèÊ®ôË®ò
        function createCustomAvatarMarker(position, avatarUrl, accuracy, username) {
            const markerContent = document.createElement('div');
            markerContent.style.position = 'relative';
            markerContent.style.width = '40px';
            markerContent.style.height = '40px';
            markerContent.style.cursor = 'pointer';
            
            if (avatarUrl) {
                const img = document.createElement('img');
                img.src = avatarUrl;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.borderRadius = '50%';
                img.style.border = '3px solid white';
                img.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
                img.style.objectFit = 'cover';
                markerContent.appendChild(img);
            } else {
                const defaultIcon = document.createElement('div');
                defaultIcon.style.width = '100%';
                defaultIcon.style.height = '100%';
                defaultIcon.style.borderRadius = '50%';
                defaultIcon.style.background = 'linear-gradient(135deg, #4285F4, #2CC5C2)';
                defaultIcon.style.border = '3px solid white';
                defaultIcon.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
                defaultIcon.style.display = 'flex';
                defaultIcon.style.alignItems = 'center';
                defaultIcon.style.justifyContent = 'center';
                defaultIcon.style.color = 'white';
                defaultIcon.style.fontSize = '18px';
                defaultIcon.style.fontWeight = 'bold';
                defaultIcon.textContent = username ? username.charAt(0).toUpperCase() : '?';
                markerContent.appendChild(defaultIcon);
            }
            
            const pulse = document.createElement('div');
            pulse.style.position = 'absolute';
            pulse.style.top = '50%';
            pulse.style.left = '50%';
            pulse.style.transform = 'translate(-50%, -50%)';
            pulse.style.width = '100%';
            pulse.style.height = '100%';
            pulse.style.borderRadius = '50%';
            pulse.style.border = '2px solid #4285F4';
            pulse.style.animation = 'pulse 1.5s ease-out infinite';
            pulse.style.pointerEvents = 'none';
            markerContent.appendChild(pulse);
            
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                currentLocationMarker = new google.maps.marker.AdvancedMarkerElement({
                    map: map,
                    position: position,
                    content: markerContent,
                    title: 'ÊÇ®ÁöÑ‰ΩçÁΩÆ'
                });
            } else {
                currentLocationMarker = new google.maps.Marker({
                    map: map,
                    position: position,
                    title: 'ÊÇ®ÁöÑ‰ΩçÁΩÆ',
                    icon: {
                        url: avatarUrl || 'data:image/svg+xml,' + encodeURIComponent(`
                            <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="20" cy="20" r="18" fill="#4285F4" stroke="white" stroke-width="3"/>
                                <text x="20" y="26" font-size="18" font-weight="bold" text-anchor="middle" fill="white">${username ? username.charAt(0).toUpperCase() : '?'}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });
            }
            
            userLocationCircle = new google.maps.Circle({
                map: map,
                center: position,
                radius: accuracy,
                fillColor: '#4285F4',
                fillOpacity: 0.1,
                strokeColor: '#4285F4',
                strokeOpacity: 0.5,
                strokeWeight: 1
            });
            
            markerContent.addEventListener('click', () => {
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding:10px; text-align:center;">
                            ${avatarUrl ? `<img src="${avatarUrl}" style="width:45px; height:45px; border-radius:50%; margin-bottom:8px; object-fit:cover;">` : ''}
                            <div style="font-weight:bold; color:var(--accent-dark);">ÊÇ®ÁöÑ‰ΩçÁΩÆ</div>
                            <div style="font-size:12px; color:var(--muted);">${username || 'Áî®Êà∂'}</div>
                            <div style="font-size:11px; color:var(--muted);">Á≤æÁ¢∫Â∫¶: ${Math.round(accuracy)}ÂÖ¨Â∞∫</div>
                        </div>
                    `
                });
                infoWindow.open(map, currentLocationMarker);
            });
        }

        // Áç≤ÂèñÁõÆÂâç‰ΩçÁΩÆ
        window.getCurrentLocationAndCenter = function() {
            if (!map) {
                alert('Âú∞ÂúñÂ∞öÊú™ÂàùÂßãÂåñÂÆåÊàêÔºåË´ãÁ®çÂæåÂÜçË©¶');
                return;
            }
            
            if (!navigator.geolocation) {
                alert('ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Âú∞ÁêÜ‰ΩçÁΩÆÂäüËÉΩ');
                return;
            }

            const loadingEl = document.getElementById('locationLoading');
            const locationInfo = document.getElementById('locationInfo');
            
            if (loadingEl) loadingEl.style.display = 'block';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const currentPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    currentUserLocation = currentPos;
                    lastOriginPosition = currentPos;
                    
                    map.setCenter(currentPos);
                    map.setZoom(17);
                    
                    if (currentLocationMarker) currentLocationMarker.setMap(null);
                    if (userLocationCircle) userLocationCircle.setMap(null);
                    
                    const user = auth.currentUser;
                    
                    if (user) {
                        db.collection('users').doc(user.uid).get().then((doc) => {
                            let avatarUrl = null;
                            let username = user.displayName || user.email?.split('@')[0] || 'Áî®Êà∂';
                            
                            if (doc.exists) {
                                if (doc.data().profileImageUrl) {
                                    avatarUrl = doc.data().profileImageUrl;
                                }
                                if (doc.data().username) {
                                    username = doc.data().username;
                                }
                            }
                            
                            createCustomAvatarMarker(currentPos, avatarUrl, position.coords.accuracy, username);
                            
                            if (isSharingLocation) {
                                shareCurrentLocation();
                            }
                        }).catch((error) => {
                            console.error('Áç≤ÂèñÁî®Êà∂Ë≥áÊñôÈåØË™§:', error);
                            createCustomAvatarMarker(currentPos, null, position.coords.accuracy, 'Áî®Êà∂');
                        });
                    } else {
                        createCustomAvatarMarker(currentPos, null, position.coords.accuracy, 'Ë®™ÂÆ¢');
                    }
                    
                    if (locationInfo) {
                        locationInfo.textContent = `üìç ÊÇ®ÁöÑ‰ΩçÁΩÆ - Á≤æÁ¢∫Â∫¶ÔºöÁ¥Ñ ${Math.round(position.coords.accuracy)} ÂÖ¨Â∞∫`;
                        locationInfo.style.display = 'block';
                        setTimeout(() => locationInfo.style.display = 'none', 5000);
                    }
                    
                    if (loadingEl) loadingEl.style.display = 'none';

                    if (currentDestinationPosition) {
                        calculateAndDisplayRoute(currentPos, currentDestinationPosition, currentTravelMode);
                    } else {
                        const infoWindow = new google.maps.InfoWindow({
                            content: '<div style="padding:8px;">üîç ÁèæÂú®ÂèØ‰ª•ÊêúÂ∞ãÁõÆÁöÑÂú∞ÔºåË∑ØÁ∑öÊúÉËá™ÂãïË¶èÂäÉ</div>'
                        });
                        infoWindow.setPosition(currentPos);
                        infoWindow.open(map);
                    }
                },
                
                function(error) {
                    console.error('Âú∞ÁêÜ‰ΩçÁΩÆÈåØË™§:', error);
                    if (loadingEl) loadingEl.style.display = 'none';
                    
                    let errorMessage = 'ÁÑ°Ê≥ïÁç≤ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆÔºö';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'ÊÇ®ÊãíÁµï‰∫Ü‰ΩçÁΩÆÂ≠òÂèñÊ¨äÈôê„ÄÇ';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += '‰ΩçÁΩÆË≥áË®ä‰∏çÂèØÁî®„ÄÇ';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Êì∑Âèñ‰ΩçÁΩÆË∂ÖÊôÇ„ÄÇ';
                            break;
                        default:
                            errorMessage += 'Êú™Áü•ÈåØË™§„ÄÇ';
                    }
                    alert(errorMessage);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        };

        // ÊêúÂ∞ãÈôÑËøëË®≠ÊñΩ
        window.searchNearby = function(type) {
            if (!map || !placesService) {
                alert('Âú∞ÂúñÂ∞öÊú™Ê∫ñÂÇôÂ•ΩÔºåË´ãÁ®çÂæåÂÜçË©¶');
                return;
            }

            clearNearbyMarkers();

            const btn = document.getElementById(getButtonId(type));
            if (btn) btn.classList.add('active');

            let searchCenter;
            if (searchLocationType === 'current') {
                if (!currentUserLocation) {
                    showToast('Ë´ãÂÖàÈªûÊìäÂÆö‰ΩçÊåâÈàïÁç≤ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆ');
                    return;
                }
                searchCenter = {
                    lat: currentUserLocation.lat,
                    lng: currentUserLocation.lng
                };
            } else {
                const center = map.getCenter();
                searchCenter = {
                    lat: center.lat(),
                    lng: center.lng()
                };
            }

            const typeNames = {
                'restaurant': { name: 'È§êÂª≥', icon: 'üçΩÔ∏è' },
                'hotel': { name: 'ÈÖíÂ∫ó', icon: 'üè®' },
                'convenience_store': { name: '‰æøÂà©Â∫ó', icon: 'üè™' },
                'cafe': { name: 'ÂíñÂï°Âª≥', icon: '‚òï' },
                'gas_station': { name: 'Âä†Ê≤πÁ´ô', icon: '‚õΩ' },
                'parking': { name: 'ÂÅúËªäÂ†¥', icon: 'üÖøÔ∏è' },
                'hospital': { name: 'ÈÜ´Èô¢', icon: 'üè•' },
                'atm': { name: 'ÊèêÊ¨æÊ©ü', icon: 'üèß' }
            };

            showToast(`Ê≠£Âú®ÊêúÂ∞ã ${searchLocationType === 'current' ? 'ÊÇ®ÈôÑËøë' : 'Âú∞Âúñ‰∏≠ÂøÉÈôÑËøë'} 1ÂÖ¨ÈáåÂÖßÁöÑ${typeNames[type].name}...`);

            const request = {
                location: new google.maps.LatLng(searchCenter.lat, searchCenter.lng),
                radius: 1000,
                type: type
            };

            placesService.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                    
                    const sortedResults = results.sort((a, b) => {
                        const distA = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(searchCenter.lat, searchCenter.lng), 
                            a.geometry.location
                        );
                        const distB = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(searchCenter.lat, searchCenter.lng), 
                            b.geometry.location
                        );
                        return distA - distB;
                    });

                    const oneKmResults = sortedResults.filter(place => {
                        const distance = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(searchCenter.lat, searchCenter.lng), 
                            place.geometry.location
                        );
                        return distance <= 1000;
                    });

                    if (oneKmResults.length === 0) {
                        showToast(`${searchLocationType === 'current' ? 'ÊÇ®ÈôÑËøë' : 'Âú∞Âúñ‰∏≠ÂøÉÈôÑËøë'} 1ÂÖ¨ÈáåÂÖßÊâæ‰∏çÂà∞${typeNames[type].name}`);
                        return;
                    }

                    const top20Results = oneKmResults.slice(0, 20);

                    showToast(`Âú®1ÂÖ¨ÈáåÂÖßÊâæÂà∞ ${top20Results.length} Èñì${typeNames[type].name}`);

                    top20Results.forEach((place) => {
                        createNearbyMarker(place, typeNames[type], searchCenter);
                    });

                    if (top20Results.length > 0) {
                        const bounds = new google.maps.LatLngBounds();
                        top20Results.forEach(place => {
                            bounds.extend(place.geometry.location);
                        });
                        
                        if (top20Results.length === 1) {
                            map.setCenter(top20Results[0].geometry.location);
                            map.setZoom(16);
                        } else {
                            map.fitBounds(bounds);
                            
                            const listener = google.maps.event.addListener(map, 'bounds_changed', function() {
                                if (map.getZoom() > 18) map.setZoom(18);
                                google.maps.event.removeListener(listener);
                            });
                        }
                    }
                } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                    showToast(`${searchLocationType === 'current' ? 'ÊÇ®ÈôÑËøë' : 'Âú∞Âúñ‰∏≠ÂøÉÈôÑËøë'} 1ÂÖ¨ÈáåÂÖßÊâæ‰∏çÂà∞${typeNames[type].name}`);
                } else {
                    console.error('ÈôÑËøëÊêúÂ∞ãÂ§±Êïó:', status);
                    let errorMsg = 'ÊêúÂ∞ãÂ§±Êïó';
                    switch(status) {
                        case 'OVER_QUERY_LIMIT':
                            errorMsg = 'Êü•Ë©¢Ê¨°Êï∏Ë∂ÖÈÅéÈôêÂà∂ÔºåË´ãÁ®çÂæåÂÜçË©¶';
                            break;
                        case 'REQUEST_DENIED':
                            errorMsg = 'Ë´ãÊ±ÇË¢´ÊãíÁµï';
                            break;
                        case 'INVALID_REQUEST':
                            errorMsg = 'ÁÑ°ÊïàÁöÑË´ãÊ±Ç';
                            break;
                        default:
                            errorMsg = `ÊêúÂ∞ãÂ§±ÊïóÔºö${status}`;
                    }
                    showToast(errorMsg);
                }
            });
        };

        // Âª∫Á´ãÈôÑËøëË®≠ÊñΩÊ®ôË®ò
        function createNearbyMarker(place, typeInfo, center) {
            let distanceText = '';
            let distance = 0;
            
            if (center) {
                distance = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(center.lat, center.lng), 
                    place.geometry.location
                );
                if (distance < 1000) {
                    distanceText = `<div style="font-size: 11px; color: var(--muted); margin-bottom: 5px;">üìè Ë∑ùÈõ¢ ${Math.round(distance)} ÂÖ¨Â∞∫</div>`;
                } else {
                    distanceText = `<div style="font-size: 11px; color: var(--muted); margin-bottom: 5px;">üìè Ë∑ùÈõ¢ ${(distance/1000).toFixed(1)} ÂÖ¨Èáå</div>`;
                }
            }

            const markerColors = {
                'restaurant': '#FF6B6B',
                'hotel': '#4ECDC4',
                'convenience_store': '#45B7D1',
                'cafe': '#FFB347',
                'gas_station': '#96CEB4',
                'parking': '#FFE194',
                'hospital': '#DDA0DD',
                'atm': '#FF9999'
            };

            let colorKey = 'restaurant';
            if (typeInfo.icon === 'üè®') colorKey = 'hotel';
            else if (typeInfo.icon === 'üè™') colorKey = 'convenience_store';
            else if (typeInfo.icon === '‚òï') colorKey = 'cafe';
            else if (typeInfo.icon === '‚õΩ') colorKey = 'gas_station';
            else if (typeInfo.icon === 'üÖøÔ∏è') colorKey = 'parking';
            else if (typeInfo.icon === 'üè•') colorKey = 'hospital';
            else if (typeInfo.icon === 'üèß') colorKey = 'atm';

            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: markerColors[colorKey],
                    fillOpacity: 0.9,
                    strokeColor: 'white',
                    strokeWeight: 2
                },
                animation: google.maps.Animation.DROP
            });

            marker.addListener('click', () => {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }

                const loadingInfoWindow = new google.maps.InfoWindow({
                    content: '<div style="padding:10px;">ËºâÂÖ•Ë©≥Á¥∞Ë≥áË®ä‰∏≠...</div>'
                });
                loadingInfoWindow.open(map, marker);
                currentInfoWindow = loadingInfoWindow;

                const request = {
                    placeId: place.place_id,
                    fields: ['name', 'formatted_address', 'formatted_phone_number', 'rating', 'website', 
                            'opening_hours', 'price_level', 'vicinity', 'user_ratings_total',
                            'types']
                };

                placesService.getDetails(request, (placeDetails, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && placeDetails) {
                        let ratingHtml = '';
                        if (placeDetails.rating) {
                            const fullStars = Math.round(placeDetails.rating);
                            const stars = '‚òÖ'.repeat(fullStars) + '‚òÜ'.repeat(5 - fullStars);
                            ratingHtml = `<div class="info-window-rating">${stars} ${placeDetails.rating} (${placeDetails.user_ratings_total || 0} ÂâáË©ïË´ñ)</div>`;
                        }

                        let hoursHtml = '';
                        if (placeDetails.opening_hours) {
                            const isOpen = placeDetails.opening_hours.isOpen ? placeDetails.opening_hours.isOpen() : false;
                            const openStatus = isOpen ? 'ÁáüÊ•≠‰∏≠' : '‰ºëÊÅØ‰∏≠';
                            const statusColor = isOpen ? '#28a745' : '#dc3545';
                            hoursHtml = `<div style="font-size: 11px; color: ${statusColor}; margin-bottom: 5px;">${openStatus}</div>`;
                            
                            if (placeDetails.opening_hours.weekday_text) {
                                const today = new Date().getDay();
                                const dayIndex = today === 0 ? 6 : today - 1;
                                hoursHtml += `<div style="font-size: 10px; color: var(--muted);">${placeDetails.opening_hours.weekday_text[dayIndex]}</div>`;
                            }
                        }

                        let priceHtml = '';
                        if (placeDetails.price_level) {
                            const priceLevel = 'üí∞'.repeat(placeDetails.price_level);
                            priceHtml = `<div style="font-size: 11px; margin-bottom: 5px;">ÂÉπÊ†º: ${priceLevel}</div>`;
                        }

                        let typesHtml = '';
                        if (placeDetails.types) {
                            const typeMap = {
                                'chinese_restaurant': '‰∏≠Âºè',
                                'japanese_restaurant': 'Êó•Âºè',
                                'italian_restaurant': 'Áæ©Âºè',
                                'french_restaurant': 'Ê≥ïÂºè',
                                'thai_restaurant': 'Ê≥∞Âºè',
                                'vietnamese_restaurant': 'Ë∂äÂºè',
                                'korean_restaurant': 'ÈüìÂºè',
                                'fast_food_restaurant': 'ÈÄüÈ£ü',
                                'pizza_restaurant': 'Êä´Ëñ©',
                                'burger_restaurant': 'Êº¢Â†°',
                                'seafood_restaurant': 'Êµ∑ÈÆÆ',
                                'steak_house': 'ÁâõÊéí',
                                'sushi_restaurant': 'Â£ΩÂè∏',
                                'ramen_restaurant': 'ÊãâÈ∫µ',
                                'bakery': 'È∫µÂåÖÂ∫ó',
                                'bar': 'ÈÖíÂêß',
                                'cafe': 'ÂíñÂï°Âª≥'
                            };
                            
                            const matchedTypes = placeDetails.types
                                .filter(t => typeMap[t])
                                .map(t => typeMap[t])
                                .slice(0, 3);
                            
                            if (matchedTypes.length > 0) {
                                typesHtml = `<div style="font-size: 10px; color: var(--accent); margin-bottom: 5px;">${matchedTypes.join(' ¬∑ ')}</div>`;
                            }
                        }

                        const infoWindowContent = `
                            <div class="info-window" style="max-width: 250px;">
                                <div class="info-window-title" style="font-size: 16px; margin-bottom: 8px;">${typeInfo.icon} ${placeDetails.name}</div>
                                ${typesHtml}
                                ${hoursHtml}
                                ${ratingHtml}
                                ${priceHtml}
                                ${distanceText}
                                <div class="info-window-address" style="font-size: 11px; margin: 8px 0;">üìç ${placeDetails.formatted_address || place.vicinity || 'Âú∞ÂùÄ‰∏çË©≥'}</div>
                                ${placeDetails.formatted_phone_number ? `<div style="font-size: 11px; margin: 5px 0;"><a href="tel:${placeDetails.formatted_phone_number}" style="color: var(--accent); text-decoration: none;">üìû ${placeDetails.formatted_phone_number}</a></div>` : ''}
                                <button class="info-window-btn" onclick="setDestination(${place.geometry.location.lat()}, ${place.geometry.location.lng()}, '${placeDetails.name.replace(/'/g, "\\'")}')">
                                    Ë®≠ÁÇ∫ÁõÆÁöÑÂú∞
                                </button>
                            </div>
                        `;

                        const infoWindow = new google.maps.InfoWindow({
                            content: infoWindowContent
                        });

                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                    } else {
                        const infoWindowContent = `
                            <div class="info-window">
                                <div class="info-window-title">${typeInfo.icon} ${place.name}</div>
                                ${distanceText}
                                <div class="info-window-address">üìç ${place.vicinity || 'Âú∞ÂùÄ‰∏çË©≥'}</div>
                                <button class="info-window-btn" onclick="setDestination(${place.geometry.location.lat()}, ${place.geometry.location.lng()}, '${place.name.replace(/'/g, "\\'")}')">
                                    Ë®≠ÁÇ∫ÁõÆÁöÑÂú∞
                                </button>
                            </div>
                        `;

                        const infoWindow = new google.maps.InfoWindow({
                            content: infoWindowContent
                        });

                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                    }
                });
            });

            nearbyMarkers.push(marker);
        }

        function getButtonId(type) {
            const map = {
                'restaurant': 'btnRestaurant',
                'hotel': 'btnHotel',
                'convenience_store': 'btnStore',
                'cafe': 'btnCafe',
                'gas_station': 'btnGas',
                'parking': 'btnParking',
                'hospital': 'btnHospital',
                'atm': 'btnATM'
            };
            return map[type] || '';
        }

        window.setDestination = function(lat, lng, name) {
            currentDestinationPosition = { lat, lng };
            
            clearNearbyMarkers();
            
            map.setCenter({ lat, lng });
            map.setZoom(17);
            
            if (searchMarker) {
                searchMarker.setMap(null);
            }
            
            searchMarker = new google.maps.Marker({
                map: map,
                position: { lat, lng },
                title: name,
                animation: google.maps.Animation.DROP
            });
            
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div class="info-window">
                        <div class="info-window-title">üìç ÁõÆÁöÑÂú∞</div>
                        <div class="info-window-address">${name}</div>
                        <small style="color:var(--accent);">‚úÖ Â∑≤Ë®≠ÁÇ∫ÁõÆÁöÑÂú∞ÔºåÈÅ∏Êìá‰∫§ÈÄöÊ®°ÂºèË¶èÂäÉË∑ØÁ∑ö</small>
                    </div>
                `
            });
            
            infoWindow.open(map, searchMarker);
            
            if (lastOriginPosition) {
                calculateAndDisplayRoute(lastOriginPosition, currentDestinationPosition, currentTravelMode);
            }

            if (currentInfoWindow) {
                currentInfoWindow.close();
            }
        };

        function handlePlaceSelected(place) {
            if (!map) {
                alert('Âú∞ÂúñÂ∞öÊú™ÂàùÂßãÂåñÂÆåÊàêÔºåË´ãÁ®çÂæåÂÜçË©¶');
                return;
            }
            
            const position = place.geometry.location;
            
            currentDestinationPosition = {
                lat: position.lat(),
                lng: position.lng()
            };
            
            map.setCenter(position);
            map.setZoom(17);
            
            if (searchMarker) {
                searchMarker.setMap(null);
            }
            
            searchMarker = new google.maps.Marker({
                map: map,
                position: position,
                title: place.name,
                animation: google.maps.Animation.DROP
            });
            
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div class="info-window">
                        <div class="info-window-title">${place.name}</div>
                        <div class="info-window-address">${place.formatted_address || ''}</div>
                        <small style="color:var(--accent);">‚úÖ ÈÅ∏Êìá‰∫§ÈÄöÊ®°ÂºèËá™ÂãïË¶èÂäÉË∑ØÁ∑ö</small>
                    </div>
                `
            });
            
            infoWindow.open(map, searchMarker);

            if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
            document.getElementById('routeSummary').classList.remove('show');
            
            if (lastOriginPosition) {
                autoPlanRoute();
            }

            clearNearbyMarkers();
        }

        window.searchPlace = function() {
            if (!map || !placesService) {
                alert('Âú∞ÂúñÂ∞öÊú™Ê∫ñÂÇôÂ•ΩÔºåË´ãÁ®çÂæåÂÜçË©¶');
                return;
            }
            
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const request = {
                query: query,
                fields: ['name', 'geometry', 'formatted_address']
            };

            placesService.findPlaceFromQuery(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                    const place = results[0];
                    const position = place.geometry.location;
                    
                    currentDestinationPosition = {
                        lat: position.lat(),
                        lng: position.lng()
                    };
                    
                    map.setCenter(position);
                    map.setZoom(17);
                    
                    if (searchMarker) searchMarker.setMap(null);
                    
                    searchMarker = new google.maps.Marker({
                        map: map,
                        position: position,
                        title: place.name,
                        animation: google.maps.Animation.DROP
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="info-window">
                                <div class="info-window-title">${place.name}</div>
                                <div class="info-window-address">${place.formatted_address || ''}</div>
                                <small style="color:var(--accent);">‚úÖ ÈÅ∏Êìá‰∫§ÈÄöÊ®°ÂºèËá™ÂãïË¶èÂäÉË∑ØÁ∑ö</small>
                            </div>
                        `
                    });
                    infoWindow.open(map, searchMarker);
                    
                    if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
                    document.getElementById('routeSummary').classList.remove('show');
                    
                    if (lastOriginPosition) {
                        autoPlanRoute();
                    }

                    clearNearbyMarkers();
                } else {
                    alert('Êâæ‰∏çÂà∞Ë©≤Âú∞ÈªûÔºåË´ãÂòóË©¶ÂÖ∂‰ªñÈóúÈçµÂ≠ó');
                }
            });
        };

        function autoPlanRoute() {
            if (lastOriginPosition && currentDestinationPosition) {
                calculateAndDisplayRoute(lastOriginPosition, currentDestinationPosition, currentTravelMode);
            }
        }

        window.setTravelMode = function(mode) {
            document.querySelectorAll('.route-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.route-mode-btn[data-mode="${mode}"]`).classList.add('active');
            
            currentTravelMode = mode;
            
            if (lastOriginPosition && currentDestinationPosition) {
                calculateAndDisplayRoute(lastOriginPosition, currentDestinationPosition, mode);
            } else if (!lastOriginPosition) {
                if (map) {
                    const infoWindow = new google.maps.InfoWindow({
                        content: '<div style="padding:8px;">üìç Ë´ãÂÖàÈªûÊìäÂ∑¶‰∏ãËßíÊåâÈàïÁç≤ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆ</div>'
                    });
                    infoWindow.setPosition(map.getCenter());
                    infoWindow.open(map);
                }
            } else if (!currentDestinationPosition) {
                if (map) {
                    const infoWindow = new google.maps.InfoWindow({
                        content: '<div style="padding:8px;">üîç Ë´ãÂÖàÊêúÂ∞ãÁõÆÁöÑÂú∞</div>'
                    });
                    infoWindow.setPosition(map.getCenter());
                    infoWindow.open(map);
                }
            }
        };

        function getGoogleTravelMode(mode) {
            switch(mode) {
                case 'DRIVING': return google.maps.TravelMode.DRIVING;
                case 'TRANSIT': return google.maps.TravelMode.TRANSIT;
                case 'WALKING': return google.maps.TravelMode.WALKING;
                case 'BICYCLING': return google.maps.TravelMode.BICYCLING;
                default: return google.maps.TravelMode.DRIVING;
            }
        }

        function calculateAndDisplayRoute(origin, destination, mode) {
            if (!directionsService || !directionsRenderer) return;

            const travelMode = getGoogleTravelMode(mode);

            const request = {
                origin: origin,
                destination: destination,
                travelMode: travelMode,
                unitSystem: google.maps.UnitSystem.METRIC
            };

            if (mode === 'TRANSIT') {
                request.transitOptions = {
                    modes: [google.maps.TransitMode.BUS, google.maps.TransitMode.RAIL],
                    routingPreference: google.maps.TransitRoutePreference.FEWER_TRANSFERS
                };
            }

            directionsService.route(request, (result, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);
                    
                    const route = result.routes[0];
                    if (route && route.legs.length > 0) {
                        const leg = route.legs[0];
                        const distance = leg.distance.text;
                        const duration = leg.duration.text;
                        
                        let modeIcon = 'üöó';
                        if (mode === 'TRANSIT') modeIcon = 'üöÜ';
                        else if (mode === 'WALKING') modeIcon = 'üö∂';
                        else if (mode === 'BICYCLING') modeIcon = 'üö≤';
                        
                        let summaryHtml = `
                            <strong>${modeIcon} ÊúÄ‰Ω≥Ë∑ØÁ∑ö (${getModeName(mode)})</strong><br>
                            <span>Ë∑ùÈõ¢: ${distance} | ÊôÇÈñì: ${duration}</span><br>
                            <small>Ëµ∑Èªû: ${leg.start_address.split(',')[0]}</small><br>
                            <small>ÁµÇÈªû: ${leg.end_address.split(',')[0]}</small>
                        `;
                        document.getElementById('routeSummaryContent').innerHTML = summaryHtml;

                        if (mode === 'TRANSIT' && leg.steps) {
                            let transitStepsHtml = '<hr style="margin:8px 0"><strong>üöâ ËΩâ‰πòË≥áË®ä</strong>';
                            leg.steps.forEach((step) => {
                                if (step.travel_mode === 'TRANSIT' && step.transit) {
                                    const line = step.transit.line;
                                    const vehicle = line.vehicle;
                                    const icon = vehicle && vehicle.type === 'BUS' ? 'üöå' : 'üöÜ';
                                    const departureStop = step.transit.departure_stop.name;
                                    const arrivalStop = step.transit.arrival_stop.name;
                                    transitStepsHtml += `
                                        <div class="transit-step">
                                            <span>${icon} ${line.short_name || line.name || ''}</span>
                                            <span>${departureStop} ‚Üí ${arrivalStop}</span>
                                            <small>(${step.duration.text})</small>
                                        </div>
                                    `;
                                } else if (step.travel_mode === 'WALKING') {
                                    transitStepsHtml += `<div class="transit-step"><span>üö∂ Ê≠•Ë°å ${step.distance.text} (${step.duration.text})</span></div>`;
                                }
                            });
                            document.getElementById('transitDetailed').innerHTML = transitStepsHtml;
                        } else {
                            document.getElementById('transitDetailed').innerHTML = '';
                        }

                        document.getElementById('routeSummary').classList.add('show');
                    }
                } else {
                    console.log('Ë∑ØÁ∑öË¶èÂäÉÂ§±Êïó:', status);
                }
            });
        }

        function getModeName(mode) {
            switch(mode) {
                case 'DRIVING': return 'ÈñãËªä';
                case 'TRANSIT': return 'Â§ßÁúæÈÅãËº∏';
                case 'WALKING': return 'Ê≠•Ë°å';
                case 'BICYCLING': return 'ÂñÆËªä';
                default: return 'Êú™Áü•';
            }
        }

        window.closeRoutePanel = function() {
            document.getElementById('routeSummary').classList.remove('show');
            if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
            
            // ÈáçÁΩÆÊäòÁñäÁãÄÊÖã
            isRouteCollapsed = false;
        };

        function showMeetingLocationFromStorage() {
            try {
                const savedLocation = localStorage.getItem('meetingLocation');
                if (savedLocation && map) {
                    const locationData = JSON.parse(savedLocation);
                    const now = new Date().getTime();
                    
                    if (now - locationData.timestamp < 5 * 60 * 1000) {
                        const position = {
                            lat: locationData.lat,
                            lng: locationData.lng
                        };
                        
                        map.setCenter(position);
                        map.setZoom(17);
                        
                        if (meetingLocationMarker) meetingLocationMarker.setMap(null);
                        
                        meetingLocationMarker = new google.maps.Marker({
                            map: map,
                            position: position,
                            title: 'ÊúÉÂêàÈªû',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 12,
                                fillColor: '#FF4444',
                                fillOpacity: 1,
                                strokeColor: 'white',
                                strokeWeight: 3
                            }
                        });
                        
                        if (meetingInfoWindow) meetingInfoWindow.close();
                        
                        meetingInfoWindow = new google.maps.InfoWindow({
                            content: `
                                <div class="meeting-info-window">
                                    <div class="meeting-info-title">üéØ ÊúÉÂêàÈªû</div>
                                    <div class="meeting-info-address">üìç ${locationData.address || 'Êú™Áü•Âú∞ÂùÄ'}</div>
                                </div>
                            `
                        });
                        
                        setTimeout(() => meetingInfoWindow.open(map, meetingLocationMarker), 500);
                        localStorage.removeItem('meetingLocation');
                    } else {
                        localStorage.removeItem('meetingLocation');
                    }
                }
            } catch (error) {
                console.error('ËÆÄÂèñÊúÉÂêàÈªûË≥áÊñôÈåØË™§:', error);
                localStorage.removeItem('meetingLocation');
            }
        }

        // Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖã
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Áî®Êà∂Â∑≤ÁôªÂÖ•');
                if (isMapInitialized) {
                    loadUserGroups();
                }
            } else {
                console.log('Áî®Êà∂Êú™ÁôªÂÖ•ÔºåÂú∞Âúñ‰ª•Ë®™ÂÆ¢Ê®°ÂºèÈ°ØÁ§∫');
            }
        });

        // È†ÅÈù¢Âç∏ËºâÊôÇÂÅúÊ≠¢ÂàÜ‰∫´
        window.addEventListener('beforeunload', () => {
            stopSharingLocation();
            if (unsubscribeGroupLocations) {
                unsubscribeGroupLocations();
            }
        });

        document.addEventListener('touchstart', function(e) {
        }, { passive: true });
    </script>
</body>
</html>