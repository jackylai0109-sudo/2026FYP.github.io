<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>TravelSync Â· åœ°åœ–ï¼‹å¤šå…ƒäº¤é€š</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Google Maps API ç›´æ¥è¼‰å…¥ -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXCOcFaB80u9FjnEkQf-DlMOPqAJyGngA&libraries=places,geometry,marker&callback=initMap&v=weekly" async defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --accent: #2CC5C2;
            --accent-dark: #0C344E;
            --bg: #f5fbfb;
            --card: #ffffff;
            --muted: #6b7b86;
            --radius: 14px;
            --member-color: #FFB347;
            --member-dark: #FF8C00;
        }

        body {
            font-family: 'Noto Sans', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f2fbfb 0%, #ebf8f8 100%);
            min-height: 100vh;
            padding: 10px 10px 10px 70px; /* æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
            touch-action: pan-y pinch-zoom;
        }

        /* ==================== å´é‚Šå°èˆª - æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ ==================== */
        .side-nav {
            position: fixed;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
            width: 50px; /* æ‰‹æ©Ÿç‰ˆå¯¬åº¦ */
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(12,52,78,0.08);
            z-index: 1000;
            padding: 12px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(44, 197, 194, 0.2);
            transition: all 0.3s ease;
        }

        .side-nav:hover {
            width: 140px; /* æ‰‹æ©Ÿç‰ˆæ‡¸åœå¯¬åº¦ */
        }

        .nav-items {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .side-nav:hover .nav-items {
            align-items: flex-start;
            padding-left: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            width: 100%;
            color: var(--muted);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            font-size: 13px;
        }

        .side-nav:not(:hover) .nav-item {
            justify-content: center;
        }

        .nav-item:hover {
            color: var(--accent-dark);
            background: rgba(44, 197, 194, 0.1);
        }

        .nav-item:active {
            background: rgba(44, 197, 194, 0.2);
        }

        .nav-item.active {
            color: var(--accent-dark);
            font-weight: 600;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 16px;
            background: var(--accent);
            border-radius: 0 3px 3px 0;
        }

        .nav-icon {
            font-size: 16px;
            min-width: 28px;
            text-align: center;
        }

        .nav-label {
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s ease 0.1s;
        }

        .side-nav:hover .nav-label {
            opacity: 1;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            padding-left: 70px; /* é…åˆå´é‚Šå°èˆª */
            flex-wrap: wrap;
        }

        .back-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--accent);
            border-radius: 8px;
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            -webkit-tap-highlight-color: transparent;
        }

        .back-btn:active {
            transform: scale(0.95);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            height: calc(100vh - 120px);
            padding-left: 70px; /* é…åˆå´é‚Šå°èˆª */
            position: relative;
            z-index: 1;
        }

        .map-card {
            background: var(--card);
            border-radius: var(--radius);
            height: 100%;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(6, 30, 38, 0.06);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .map-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px; /* æ‰‹æ©Ÿç‰ˆæ¸›å°‘å…§é‚Šè· */
            border-bottom: 1px solid #eef2f2;
            flex-wrap: wrap;
            gap: 8px;
            background: white;
            z-index: 5;
        }

        .map-header h2 {
            color: var(--accent-dark);
            font-size: 16px; /* æ‰‹æ©Ÿç‰ˆå­—é«” */
            white-space: nowrap;
        }

        /* ==================== ç¾¤çµ„é¸æ“‡å™¨ - æ‰‹æ©Ÿå„ªåŒ– ==================== */
        .group-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-bottom: 1px solid #eef2f2;
            flex-wrap: wrap;
        }

        .group-selector-label {
            font-size: 12px;
            color: var(--accent-dark);
            font-weight: 500;
            white-space: nowrap;
        }

        .group-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            flex: 1;
        }

        .group-badge {
            padding: 4px 10px;
            background: #f0f8f8;
            border: 1px solid #e6eef0;
            border-radius: 20px;
            color: var(--accent-dark);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            -webkit-tap-highlight-color: transparent;
        }

        .group-badge:active {
            transform: scale(0.95);
        }

        .group-badge.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .group-badge i {
            font-size: 12px;
        }

        .group-badge .online-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4caf50;
            display: inline-block;
            margin-left: 3px;
        }

        .search-container {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-box {
            display: flex;
            gap: 6px;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e6eef0;
            border-radius: 20px;
            font-size: 13px;
            transition: all 0.3s ease;
            background: white;
            -webkit-appearance: none;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(44, 197, 194, 0.1);
        }

        .search-btn {
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            white-space: nowrap;
        }

        .search-btn:active {
            transform: scale(0.95);
        }

        .pac-container {
            border-radius: 10px;
            margin-top: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #e6eef0;
            font-family: 'Noto Sans', 'Segoe UI', Roboto, sans-serif;
            z-index: 2000;
        }

        .pac-item {
            padding: 8px 12px;
            cursor: pointer;
            border-top: 1px solid #eef2f2;
            font-size: 13px;
        }

        .map-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .map-action-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #e6eef0;
            border-radius: 20px;
            color: var(--accent-dark);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            white-space: nowrap;
        }

        .map-action-btn:active {
            transform: scale(0.95);
        }

        /* ==================== é™„è¿‘è¨­æ–½æŒ‰éˆ•çµ„ - æ‰‹æ©Ÿå„ªåŒ– ==================== */
        .nearby-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            padding: 0;
            background: transparent;
            border-bottom: none;
        }

        .nearby-btn {
            padding: 6px 12px;
            background: #f0f8f8;
            border: 1px solid #e6eef0;
            border-radius: 20px;
            color: var(--accent-dark);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .nearby-btn:active {
            transform: scale(0.95);
        }

        .nearby-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .nearby-btn i {
            font-size: 14px;
        }

        /* ==================== æœå°‹ä¾æ“šé¸æ“‡å™¨ - æ‰‹æ©Ÿå„ªåŒ– ==================== */
        .search-location-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0;
            background: transparent;
            border-bottom: none;
        }

        .selector-label {
            font-size: 12px;
            color: var(--accent-dark);
            font-weight: 500;
            white-space: nowrap;
        }

        .selector-radio {
            display: flex;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            font-size: 12px;
            color: var(--muted);
            transition: color 0.2s ease;
            white-space: nowrap;
        }

        .selector-radio:hover {
            color: var(--accent-dark);
        }

        .selector-radio input[type="radio"] {
            cursor: pointer;
            width: 14px;
            height: 14px;
            accent-color: var(--accent);
            margin: 0;
        }

        .route-mode-group {
            display: flex;
            gap: 4px;
            background: #f0f7f9;
            padding: 3px;
            border-radius: 25px;
            margin-right: 3px;
            flex-wrap: wrap;
        }
        
        .route-mode-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 500;
            color: var(--accent-dark);
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .route-mode-btn:active {
            transform: scale(0.95);
        }
        
        .route-mode-btn.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: var(--accent);
        }
        
        .route-mode-btn i { font-style: normal; font-size: 14px; }

        .map-container {
            flex: 1;
            position: relative;
            min-height: 350px;
            background-color: #f0f0f0;
            touch-action: pan-y pinch-zoom;
            overflow: hidden;
        }

        #google-map {
            width: 100%;
            height: 100%;
            min-height: 350px;
            background-color: #e8eef0;
        }

        .location-button-container {
            position: absolute;
            bottom: 15px;
            left: 15px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: auto;
        }

        .location-button {
            width: 44px;
            height: 44px;
            background: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            padding: 0;
        }

        .location-button:active {
            transform: scale(0.95);
        }

        .location-button.sharing {
            background: var(--member-color);
            color: white;
        }

        .location-info {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 12px;
            color: var(--accent-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 2001;
            display: none;
            white-space: nowrap;
            max-width: 90%;
            text-align: center;
        }

        .location-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            text-align: center;
        }

        .location-loading .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        .info-window {
            padding: 8px;
            max-width: 180px;
            font-size: 12px;
        }

        .info-window-title {
            font-weight: 700;
            color: var(--accent-dark);
            margin-bottom: 5px;
            font-size: 13px;
        }

        .info-window-address {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 8px;
            word-break: break-word;
        }

        .info-window-rating {
            font-size: 11px;
            color: #f39c12;
            margin-bottom: 5px;
        }

        .info-window-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            font-size: 11px;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
        }

        .info-window-btn:active {
            transform: scale(0.95);
        }

        .route-summary {
            position: absolute;
            bottom: 70px;
            left: 10px;
            right: 10px;
            background: white;
            border-radius: 20px;
            padding: 12px 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            max-width: none;
            font-size: 12px;
            border-left: 5px solid var(--accent);
            display: none;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.98);
            pointer-events: auto;
        }
        
        .route-summary.show { display: block; }
        
        .route-summary .close-route {
            float: right;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
            color: #aaa;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .route-summary .close-route:active { transform: scale(0.95); }
        
        .route-summary strong { color: var(--accent-dark); }
        
        .route-summary .transit-details {
            margin-top: 8px;
            border-top: 1px dashed #ccc;
            padding-top: 8px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 11px;
        }
        
        .route-summary .transit-step {
            display: flex;
            gap: 4px;
            margin: 4px 0;
            align-items: center;
            flex-wrap: wrap;
        }

        .map-error {
            padding: 30px;
            text-align: center;
            background: white;
            border-radius: 10px;
            margin: 20px;
        }
        
        .map-error h3 {
            color: #d32f2f;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .toast-message {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-dark);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 13px;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
            max-width: 90%;
            text-align: center;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .member-count-badge {
            background: var(--member-color);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 6px;
        }

        /* æ‰‹æ©Ÿç‰ˆç‰¹å®šèª¿æ•´ */
        @media (max-width: 480px) {
            body {
                padding: 8px 8px 8px 60px;
            }

            .header {
                padding-left: 60px;
                margin-bottom: 10px;
            }

            .header h1 {
                font-size: 18px;
            }

            .back-btn {
                padding: 6px 12px;
                font-size: 13px;
            }

            .container {
                padding-left: 60px;
                height: calc(100vh - 100px);
            }

            .map-header {
                padding: 8px 10px;
            }

            .map-header h2 {
                font-size: 14px;
            }

            .group-selector {
                padding: 6px 10px;
            }

            .group-badges {
                gap: 4px;
            }

            .group-badge {
                padding: 3px 8px;
                font-size: 11px;
            }

            .search-input {
                padding: 6px 10px;
                font-size: 12px;
            }

            .search-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .map-action-btn {
                padding: 5px 10px;
                font-size: 11px;
            }

            .nearby-btn {
                padding: 5px 10px;
                font-size: 11px;
            }

            .route-mode-btn {
                padding: 3px 6px;
                font-size: 11px;
            }

            .route-mode-btn i {
                font-size: 12px;
            }

            .selector-label {
                font-size: 11px;
            }

            .selector-radio {
                font-size: 11px;
            }

            .selector-radio input[type="radio"] {
                width: 12px;
                height: 12px;
            }

            .location-button {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .route-summary {
                font-size: 11px;
                padding: 10px 12px;
            }

            .button-row {
                padding: 6px 10px !important;
                gap: 6px !important;
            }

            .search-location-selector {
                gap: 8px;
            }

            .nearby-buttons {
                gap: 4px;
            }

            .group-badges {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 3px;
            }

            .group-badge {
                flex-shrink: 0;
            }
        }

        @media (max-width: 375px) {
            .map-header h2 {
                font-size: 13px;
            }

            .route-mode-btn {
                padding: 2px 5px;
                font-size: 10px;
            }

            .route-mode-btn i {
                font-size: 11px;
            }

            .nearby-btn {
                padding: 4px 8px;
                font-size: 10px;
            }

            .search-input {
                font-size: 11px;
            }

            .search-btn {
                padding: 5px 10px;
                font-size: 11px;
            }

            .map-action-btn {
                padding: 4px 8px;
                font-size: 10px;
            }

            .group-badge {
                padding: 2px 6px;
                font-size: 10px;
            }

            .selector-label {
                font-size: 10px;
            }

            .selector-radio {
                font-size: 10px;
            }

            .selector-radio input[type="radio"] {
                width: 11px;
                height: 11px;
            }
        }
    </style>
</head>
<body>
    <!-- å´é‚Šå°èˆª - æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ -->
    <div class="side-nav">
        <div class="nav-items">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">ä¸»é </span>
            </a>
            <a href="map.html" class="nav-item active">
                <span class="nav-icon">ğŸ—ºï¸</span>
                <span class="nav-label">åœ°åœ–</span>
            </a>
            <a href="groups.html" class="nav-item">
                <span class="nav-icon">ğŸ‘¥</span>
                <span class="nav-label">ç¾¤çµ„</span>
            </a>
            <a href="ChatMessage.html" class="nav-item">
                <span class="nav-icon">ğŸ’¬</span>
                <span class="nav-label">èŠå¤©</span>
            </a>
            <a href="profile.html" class="nav-item">
                <span class="nav-icon">ğŸ‘¤</span>
                <span class="nav-label">å¸³è™Ÿ</span>
            </a>
        </div>
    </div>

    <div class="header">
        <a href="index.html" class="back-btn">â† è¿”å›</a>
        <h1>åœ°åœ– Â· å¤šå…ƒäº¤é€š</h1>
    </div>

    <!-- åœ°ç†ä½ç½®è¼‰å…¥æç¤º -->
    <div class="location-loading" id="locationLoading">
        <div class="spinner"></div>
        <p>æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...</p>
        <p style="font-size: 12px; color: var(--muted); margin-top: 10px;">è«‹å…è¨±ç€è¦½å™¨å­˜å–ä½ç½®</p>
    </div>

    <!-- ä½ç½®è³‡è¨Šé¡¯ç¤º -->
    <div class="location-info" id="locationInfo"></div>

    <div class="container">
        <div class="map-card">
            <div class="map-header">
                <h2>ğŸ—ºï¸ å³æ™‚åœ°åœ– <span id="memberCountBadge" class="member-count-badge" style="display: none;">0</span></h2>
                
                <!-- æœå°‹åˆ— -->
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" 
                               class="search-input" 
                               id="searchInput" 
                               placeholder="æœå°‹åœ°é»..."
                               autocomplete="off">
                        <button class="search-btn" onclick="searchPlace()">æœå°‹</button>
                    </div>
                </div>

                <div class="map-actions">
                    <!-- äº¤é€šæ¨¡å¼åˆ‡æ› -->
                    <div class="route-mode-group" id="routeModeGroup">
                        <button class="route-mode-btn active" data-mode="DRIVING" onclick="setTravelMode('DRIVING')"><i>ğŸš—</i> é–‹è»Š</button>
                        <button class="route-mode-btn" data-mode="TRANSIT" onclick="setTravelMode('TRANSIT')"><i>ğŸš†</i> å¤§çœ¾</button>
                        <button class="route-mode-btn" data-mode="WALKING" onclick="setTravelMode('WALKING')"><i>ğŸš¶</i> æ­¥è¡Œ</button>
                        <button class="route-mode-btn" data-mode="BICYCLING" onclick="setTravelMode('BICYCLING')"><i>ğŸš²</i> å–®è»Š</button>
                    </div>
                    <button class="map-action-btn" onclick="window.location.href='meeting.html'">ğŸ¯ æœƒåˆé»</button>
                    <button class="map-action-btn" onclick="window.location.href='weather.html'">â˜€ï¸ å¤©æ°£</button>
                </div>
            </div>

            <!-- ç¾¤çµ„é¸æ“‡å™¨ -->
            <div class="group-selector">
                <span class="group-selector-label">æˆ‘çš„ç¾¤çµ„ï¼š</span>
                <div class="group-badges" id="groupBadges">
                    <div class="group-badge loading-badge">
                        <div class="spinner small" style="width: 14px; height: 14px; margin: 0;"></div>
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
            </div>

            <!-- é™„è¿‘è¨­æ–½æŒ‰éˆ•åˆ— + æœå°‹ä¾æ“šï¼ˆåŒä¸€è¡Œï¼‰ -->
            <div class="button-row" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; border-bottom: 1px solid #eef2f2; flex-wrap: wrap; gap: 8px;">
                <!-- å·¦å´ï¼šé™„è¿‘è¨­æ–½æŒ‰éˆ• -->
                <div class="nearby-buttons" style="display: flex; gap: 6px; flex-wrap: wrap; padding: 0; border-bottom: none; flex: 1;">
                    <button class="nearby-btn" onclick="searchNearby('restaurant')" id="btnRestaurant">
                        <i>ğŸ½ï¸</i> é¤å»³
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('hotel')" id="btnHotel">
                        <i>ğŸ¨</i> é…’åº—
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('convenience_store')" id="btnStore">
                        <i>ğŸª</i> ä¾¿åˆ©
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('cafe')" id="btnCafe">
                        <i>â˜•</i> å’–å•¡
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('gas_station')" id="btnGas">
                        <i>â›½</i> åŠ æ²¹
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('parking')" id="btnParking">
                        <i>ğŸ…¿ï¸</i> åœè»Š
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('hospital')" id="btnHospital">
                        <i>ğŸ¥</i> é†«é™¢
                    </button>
                    <button class="nearby-btn" onclick="searchNearby('atm')" id="btnATM">
                        <i>ğŸ§</i> ææ¬¾
                    </button>
                </div>
                
                <!-- å³å´ï¼šæœå°‹ä¾æ“š -->
                <div class="search-location-selector" style="display: flex; align-items: center; gap: 10px; padding: 0; border-bottom: none;">
                    <span class="selector-label">ä¾æ“šï¼š</span>
                    <label class="selector-radio">
                        <input type="radio" name="searchLocation" value="center" checked onchange="updateSearchLocation()">
                        <span>ğŸ“ ä¸­å¿ƒ</span>
                    </label>
                    <label class="selector-radio">
                        <input type="radio" name="searchLocation" value="current" onchange="updateSearchLocation()">
                        <span>ğŸ“ æˆ‘çš„</span>
                    </label>
                </div>
            </div>
            
            <!-- åœ°åœ–å®¹å™¨ -->
            <div class="map-container" id="mapContainer">
                <div id="google-map"></div>
                
                <!-- è·¯ç·šæ‘˜è¦å¡ç‰‡ -->
                <div class="route-summary" id="routeSummary">
                    <span class="close-route" onclick="closeRoutePanel()">âœ•</span>
                    <div id="routeSummaryContent"></div>
                    <div id="transitDetailed" class="transit-details"></div>
                </div>
            </div>
            
            <!-- å®šä½æŒ‰éˆ•å®¹å™¨ -->
            <div class="location-button-container">
                <button class="location-button" onclick="getCurrentLocationAndCenter()" title="é¡¯ç¤ºæˆ‘çš„ä½ç½®">
                    <span>ğŸ“</span>
                </button>
                <button class="location-button" id="shareLocationBtn" onclick="toggleLocationSharing()" title="åˆ†äº«ä½ç½®çµ¦æ‰€é¸ç¾¤çµ„" style="display: none;">
                    <span>ğŸ‘¥</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBhvbTPl-hGv1MWtrua55LuvIUpdabqy4M",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "project-221c4",
            storageBucket: "project-221c4.firebasestorage.app",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // åœ°åœ–è®Šæ•¸
        let map;
        let geocoder;
        let placesService;
        let autocomplete;
        let searchMarker;
        let currentLocationMarker;
        let userLocationCircle;
        let meetingLocationMarker;
        let meetingInfoWindow;
        let directionsService;
        let directionsRenderer;
        let currentDestinationPosition = null;
        let lastOriginPosition = null;
        let currentTravelMode = 'DRIVING';
        let isMapInitialized = false;
        let resizeTimer;
        let currentInfoWindow = null;
        let nearbyMarkers = [];
        
        // ç¾¤çµ„ä½ç½®åˆ†äº«è®Šæ•¸
        let searchLocationType = 'center';
        let currentUserLocation = null;
        let selectedGroupId = null;
        let userGroups = [];
        let isSharingLocation = false;
        let locationShareInterval = null;
        let groupMembersMarkers = [];
        let unsubscribeLocations = null;
        let unsubscribeGroupLocations = null;

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Google åœ°åœ–åˆå§‹åŒ–
        window.initMap = function() {
            console.log('initMap é–‹å§‹åŸ·è¡Œ');
            
            const mapElement = document.getElementById("google-map");
            if (!mapElement) {
                console.error("æ‰¾ä¸åˆ°åœ°åœ–å®¹å™¨");
                return;
            }

            try {
                map = new google.maps.Map(mapElement, {
                    center: { lat: 25.0330, lng: 121.5654 },
                    zoom: 12,
                    mapTypeControl: true,
                    fullscreenControl: true,
                    streetViewControl: true,
                    zoomControl: true,
                    gestureHandling: 'greedy',
                    mapId: 'YOUR_MAP_ID'
                });

                console.log("åœ°åœ–å»ºç«‹æˆåŠŸ");

                geocoder = new google.maps.Geocoder();
                placesService = new google.maps.places.PlacesService(map);
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: false,
                    preserveViewport: false,
                    polylineOptions: {
                        strokeColor: "#2CC5C2",
                        strokeWeight: 5,
                        strokeOpacity: 0.8
                    }
                });

                initAutocomplete();
                
                isMapInitialized = true;
                console.log("æ‰€æœ‰æœå‹™åˆå§‹åŒ–å®Œæˆ");
                
                showMeetingLocationFromStorage();
                
                // åœ°åœ–ä¸­å¿ƒé»è®Šæ›´æ™‚æ›´æ–°è³‡è¨Š
                google.maps.event.addListener(map, 'center_changed', function() {
                    if (searchLocationType === 'center') {
                        console.log('åœ°åœ–ä¸­å¿ƒé»å·²ç§»å‹•');
                    }
                });
                
                // è¼‰å…¥ç”¨æˆ¶ç¾¤çµ„
                loadUserGroups();
                
            } catch (error) {
                console.error("åœ°åœ–åˆå§‹åŒ–éŒ¯èª¤:", error);
                mapElement.innerHTML = `<div class="map-error">
                    <h3>åœ°åœ–è¼‰å…¥å¤±æ•—</h3>
                    <p>${error.message}</p>
                    <p>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢</p>
                </div>`;
            }
        };

        // è™•ç†æ‰‹æ©Ÿæ—‹è½‰æ™‚åœ°åœ–å¤§å°èª¿æ•´
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                }
            }, 250);
        });

        // åˆå§‹åŒ– Google Places è‡ªå‹•å®Œæˆ
        function initAutocomplete() {
            const input = document.getElementById('searchInput');
            if (!input) return;
            
            autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['establishment', 'geocode'],
                fields: ['place_id', 'name', 'formatted_address', 'geometry']
            });

            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                if (place && place.geometry) {
                    handlePlaceSelected(place);
                }
            });
        }

        // æ¸…é™¤æ‰€æœ‰é™„è¿‘è¨­æ–½æ¨™è¨˜
        function clearNearbyMarkers() {
            nearbyMarkers.forEach(marker => marker.setMap(null));
            nearbyMarkers = [];
            document.querySelectorAll('.nearby-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        // æ›´æ–°æœå°‹ä¾æ“š
        window.updateSearchLocation = function() {
            const radios = document.getElementsByName('searchLocation');
            for (let radio of radios) {
                if (radio.checked) {
                    searchLocationType = radio.value;
                    break;
                }
            }
            
            console.log(`æœå°‹ä¾æ“šåˆ‡æ›ç‚ºï¼š${searchLocationType === 'center' ? 'åœ°åœ–ä¸­å¿ƒé»' : 'æˆ‘çš„ä½ç½®'}`);
            
            if (searchLocationType === 'current' && !currentUserLocation) {
                showToast('è«‹å…ˆé»æ“Šå®šä½æŒ‰éˆ•ç²å–æ‚¨çš„ä½ç½®');
            }
        }

        // è¼‰å…¥ç”¨æˆ¶çš„æ‰€æœ‰ç¾¤çµ„
        async function loadUserGroups() {
            const user = auth.currentUser;
            if (!user) return;
            
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists && userDoc.data().groups) {
                    const groups = userDoc.data().groups;
                    
                    // è½‰æ›ç‚ºé™£åˆ—
                    if (Array.isArray(groups)) {
                        userGroups = groups;
                    } else if (typeof groups === 'object') {
                        userGroups = Object.values(groups);
                    }
                    
                    if (userGroups.length > 0) {
                        // ç²å–ç¾¤çµ„è©³ç´°è³‡è¨Šå’Œç·šä¸Šäººæ•¸
                        await loadGroupDetails();
                        
                        // é è¨­é¸æ“‡ç¬¬ä¸€å€‹ç¾¤çµ„
                        if (!selectedGroupId && userGroups.length > 0) {
                            selectedGroupId = userGroups[0].groupId;
                        }
                        
                        renderGroupBadges();
                        
                        // å¦‚æœå·²é¸æ“‡ç¾¤çµ„ï¼Œé–‹å§‹ç›£è½è©²ç¾¤çµ„çš„ä½ç½®
                        if (selectedGroupId) {
                            document.getElementById('shareLocationBtn').style.display = 'flex';
                            listenSelectedGroupLocation();
                        }
                    } else {
                        document.getElementById('groupBadges').innerHTML = '<div class="group-badge" style="background: transparent; border: 1px dashed #e6eef0;">å°šæœªåŠ å…¥ç¾¤çµ„</div>';
                    }
                } else {
                    document.getElementById('groupBadges').innerHTML = '<div class="group-badge" style="background: transparent; border: 1px dashed #e6eef0;">å°šæœªåŠ å…¥ç¾¤çµ„</div>';
                }
            } catch (error) {
                console.error('è¼‰å…¥ç¾¤çµ„éŒ¯èª¤:', error);
                document.getElementById('groupBadges').innerHTML = '<div class="group-badge" style="background: #ff5a5f; color: white;">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // è¼‰å…¥ç¾¤çµ„è©³ç´°è³‡è¨Š
        async function loadGroupDetails() {
            const promises = userGroups.map(async (group) => {
                try {
                    const groupDoc = await db.collection('groups').doc(group.groupId).get();
                    if (groupDoc.exists) {
                        group.groupName = groupDoc.data().name || 'æœªå‘½åç¾¤çµ„';
                        
                        // ç²å–è©²ç¾¤çµ„çš„ç·šä¸Šäººæ•¸
                        const locationsSnapshot = await db.collection('groups')
                            .doc(group.groupId)
                            .collection('locations')
                            .get();
                        
                        group.onlineCount = locationsSnapshot.size;
                    }
                } catch (error) {
                    console.error('è¼‰å…¥ç¾¤çµ„è©³ç´°è³‡è¨ŠéŒ¯èª¤:', error);
                    group.groupName = group.groupName || 'æœªçŸ¥ç¾¤çµ„';
                    group.onlineCount = 0;
                }
            });
            
            await Promise.all(promises);
        }

        // æ¸²æŸ“ç¾¤çµ„æ¨™ç±¤
        function renderGroupBadges() {
            const container = document.getElementById('groupBadges');
            
            if (userGroups.length === 0) {
                container.innerHTML = '<div class="group-badge" style="background: transparent; border: 1px dashed #e6eef0;">å°šæœªåŠ å…¥ç¾¤çµ„</div>';
                return;
            }
            
            container.innerHTML = userGroups.map(group => {
                const isSelected = group.groupId === selectedGroupId;
                const onlineCount = group.onlineCount || 0;
                
                return `
                    <div class="group-badge ${isSelected ? 'active' : ''}" 
                         onclick="selectGroup('${group.groupId}')"
                         title="ç·šä¸Šæˆå“¡: ${onlineCount}äºº">
                        <i>ğŸ‘¥</i>
                        ${group.groupName ? group.groupName.substring(0, 8) + (group.groupName.length > 8 ? 'â€¦' : '') : 'ç¾¤çµ„'}
                        ${onlineCount > 0 ? `<span class="online-indicator"></span>` : ''}
                    </div>
                `;
            }).join('');
        }

        // é¸æ“‡ç¾¤çµ„
        window.selectGroup = function(groupId) {
            if (selectedGroupId === groupId) return;
            
            // å¦‚æœæ­£åœ¨åˆ†äº«ä½ç½®ï¼Œå…ˆåœæ­¢
            if (isSharingLocation) {
                stopSharingLocation();
            }
            
            // æ¸…é™¤èˆŠçš„ç¾¤çµ„æˆå“¡æ¨™è¨˜
            clearGroupMembersMarkers();
            
            // å–æ¶ˆè¨‚é–±èˆŠçš„ç›£è½
            if (unsubscribeGroupLocations) {
                unsubscribeGroupLocations();
            }
            
            selectedGroupId = groupId;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            renderGroupBadges();
            
            // é¡¯ç¤ºåˆ†äº«æŒ‰éˆ•
            document.getElementById('shareLocationBtn').style.display = 'flex';
            
            // ç›£è½æ–°ç¾¤çµ„çš„ä½ç½®
            listenSelectedGroupLocation();
            
            showToast(`å·²åˆ‡æ›åˆ°æ‰€é¸ç¾¤çµ„`);
        }

        // æ¸…é™¤ç¾¤çµ„æˆå“¡æ¨™è¨˜
        function clearGroupMembersMarkers() {
            groupMembersMarkers.forEach(item => {
                if (item.marker) item.marker.setMap(null);
            });
            groupMembersMarkers = [];
        }

        // ç›£è½æ‰€é¸ç¾¤çµ„çš„ä½ç½®
        function listenSelectedGroupLocation() {
            const user = auth.currentUser;
            if (!user || !selectedGroupId) return;
            
            if (unsubscribeGroupLocations) {
                unsubscribeGroupLocations();
            }
            
            const locationsRef = db.collection('groups')
                .doc(selectedGroupId)
                .collection('locations');
            
            unsubscribeGroupLocations = locationsRef.onSnapshot((snapshot) => {
                // æ›´æ–°åœ¨ç·šäººæ•¸
                const onlineCount = snapshot.docs.length;
                const badge = document.getElementById('memberCountBadge');
                
                // æ›´æ–°å°æ‡‰ç¾¤çµ„æ¨™ç±¤çš„ç·šä¸Šäººæ•¸
                const groupIndex = userGroups.findIndex(g => g.groupId === selectedGroupId);
                if (groupIndex !== -1) {
                    userGroups[groupIndex].onlineCount = onlineCount;
                    renderGroupBadges();
                }
                
                if (onlineCount > 0) {
                    badge.style.display = 'inline-block';
                    badge.textContent = `${onlineCount}`;
                } else {
                    badge.style.display = 'none';
                }
                
                // æ¸…é™¤èˆŠæ¨™è¨˜
                clearGroupMembersMarkers();
                
                // ç‚ºæ¯å€‹æˆå“¡å»ºç«‹æ–°æ¨™è¨˜
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const memberId = doc.id;
                    
                    if (memberId === user.uid) return;
                    
                    updateMemberMarker(memberId, data);
                });
            }, (error) => {
                console.error('ç›£è½ä½ç½®éŒ¯èª¤:', error);
            });
        }

        // æ›´æ–°æˆå“¡æ¨™è¨˜
        function updateMemberMarker(memberId, locationData) {
            const lastUpdate = locationData.timestamp?.toDate?.() || new Date(locationData.timestamp);
            const now = new Date();
            const diffMinutes = (now - lastUpdate) / 1000 / 60;
            
            if (diffMinutes > 1) {
                return;
            }
            
            const position = {
                lat: locationData.latitude,
                lng: locationData.longitude
            };
            
            const markerContent = document.createElement('div');
            markerContent.style.position = 'relative';
            markerContent.style.width = '32px';
            markerContent.style.height = '32px';
            markerContent.style.cursor = 'pointer';
            
            if (locationData.avatarUrl) {
                const img = document.createElement('img');
                img.src = locationData.avatarUrl;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.borderRadius = '50%';
                img.style.border = '2px solid var(--member-color)';
                img.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
                img.style.objectFit = 'cover';
                markerContent.appendChild(img);
            } else {
                const defaultIcon = document.createElement('div');
                defaultIcon.style.width = '100%';
                defaultIcon.style.height = '100%';
                defaultIcon.style.borderRadius = '50%';
                defaultIcon.style.background = 'linear-gradient(135deg, var(--member-color), var(--member-dark))';
                defaultIcon.style.border = '2px solid white';
                defaultIcon.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
                defaultIcon.style.display = 'flex';
                defaultIcon.style.alignItems = 'center';
                defaultIcon.style.justifyContent = 'center';
                defaultIcon.style.color = 'white';
                defaultIcon.style.fontSize = '14px';
                defaultIcon.style.fontWeight = 'bold';
                defaultIcon.textContent = locationData.name ? locationData.name.charAt(0).toUpperCase() : '?';
                markerContent.appendChild(defaultIcon);
            }
            
            const pulse = document.createElement('div');
            pulse.style.position = 'absolute';
            pulse.style.top = '50%';
            pulse.style.left = '50%';
            pulse.style.transform = 'translate(-50%, -50%)';
            pulse.style.width = '100%';
            pulse.style.height = '100%';
            pulse.style.borderRadius = '50%';
            pulse.style.border = '2px solid var(--member-color)';
            pulse.style.animation = 'pulse 2s ease-out infinite';
            pulse.style.pointerEvents = 'none';
            markerContent.appendChild(pulse);
            
            let marker;
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                marker = new google.maps.marker.AdvancedMarkerElement({
                    map: map,
                    position: position,
                    content: markerContent,
                    title: locationData.name || 'ç¾¤çµ„æˆå“¡'
                });
            } else {
                marker = new google.maps.Marker({
                    map: map,
                    position: position,
                    title: locationData.name || 'ç¾¤çµ„æˆå“¡',
                    icon: {
                        url: locationData.avatarUrl || 'data:image/svg+xml,' + encodeURIComponent(`
                            <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="16" cy="16" r="14" fill="#FFB347" stroke="white" stroke-width="2"/>
                                <text x="16" y="22" font-size="12" font-weight="bold" text-anchor="middle" fill="white">${locationData.name ? locationData.name.charAt(0).toUpperCase() : '?'}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(32, 32)
                    }
                });
            }
            
            groupMembersMarkers.push({
                memberId: memberId,
                marker: marker,
                content: markerContent
            });
            
            markerContent.addEventListener('click', () => {
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding:8px; text-align:center;">
                            ${locationData.avatarUrl ? `<img src="${locationData.avatarUrl}" style="width:40px; height:40px; border-radius:50%; margin-bottom:8px; object-fit:cover;">` : ''}
                            <div style="font-weight:bold; color:var(--accent-dark);">${locationData.name || 'ç¾¤çµ„æˆå“¡'}</div>
                            <div style="font-size:11px; color:var(--muted);">${lastUpdate.toLocaleTimeString()}</div>
                        </div>
                    `
                });
                infoWindow.open(map, marker);
            });
        }

        // åˆ‡æ›ä½ç½®åˆ†äº«
        window.toggleLocationSharing = function() {
            if (!currentUserLocation) {
                showToast('è«‹å…ˆç²å–æ‚¨çš„ä½ç½®');
                return;
            }
            
            if (!selectedGroupId) {
                showToast('è«‹å…ˆé¸æ“‡ä¸€å€‹ç¾¤çµ„');
                return;
            }
            
            const btn = document.getElementById('shareLocationBtn');
            
            if (isSharingLocation) {
                stopSharingLocation();
                btn.classList.remove('sharing');
                btn.style.background = 'white';
                btn.style.color = 'var(--accent-dark)';
            } else {
                startSharingLocation();
                btn.classList.add('sharing');
                btn.style.background = 'var(--member-color)';
                btn.style.color = 'white';
            }
        }

        // é–‹å§‹åˆ†äº«ä½ç½®
        function startSharingLocation() {
            if (!currentUserLocation || !selectedGroupId) {
                showToast('è«‹å…ˆç²å–æ‚¨çš„ä½ç½®');
                return;
            }
            
            if (isSharingLocation) return;
            
            isSharingLocation = true;
            
            shareCurrentLocation();
            locationShareInterval = setInterval(shareCurrentLocation, 30000);
            
            showToast(`ğŸ“ æ­£åœ¨åˆ†äº«æ‚¨çš„ä½ç½®çµ¦æ‰€é¸ç¾¤çµ„`);
        }

        // åœæ­¢åˆ†äº«ä½ç½®
        function stopSharingLocation() {
            if (locationShareInterval) {
                clearInterval(locationShareInterval);
                locationShareInterval = null;
            }
            
            if (selectedGroupId && auth.currentUser) {
                db.collection('groups')
                    .doc(selectedGroupId)
                    .collection('locations')
                    .doc(auth.currentUser.uid)
                    .delete()
                    .catch(error => console.error('ç§»é™¤ä½ç½®éŒ¯èª¤:', error));
            }
            
            isSharingLocation = false;
            showToast('ğŸ›‘ å·²åœæ­¢åˆ†äº«ä½ç½®');
        }

        // åˆ†äº«ç›®å‰ä½ç½®
        async function shareCurrentLocation() {
            if (!currentUserLocation || !selectedGroupId || !auth.currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
                const userData = userDoc.exists ? userDoc.data() : {};
                
                const locationData = {
                    userId: auth.currentUser.uid,
                    name: userData.username || auth.currentUser.displayName || 'ç”¨æˆ¶',
                    avatarUrl: userData.profileImageUrl || null,
                    latitude: currentUserLocation.lat,
                    longitude: currentUserLocation.lng,
                    accuracy: currentUserLocation.accuracy || 0,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('groups')
                    .doc(selectedGroupId)
                    .collection('locations')
                    .doc(auth.currentUser.uid)
                    .set(locationData);
                    
            } catch (error) {
                console.error('åˆ†äº«ä½ç½®éŒ¯èª¤:', error);
            }
        }

        // å»ºç«‹è‡ªå®šç¾©é ­åƒæ¨™è¨˜
        function createCustomAvatarMarker(position, avatarUrl, accuracy, username) {
            const markerContent = document.createElement('div');
            markerContent.style.position = 'relative';
            markerContent.style.width = '36px';
            markerContent.style.height = '36px';
            markerContent.style.cursor = 'pointer';
            
            if (avatarUrl) {
                const img = document.createElement('img');
                img.src = avatarUrl;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.borderRadius = '50%';
                img.style.border = '3px solid white';
                img.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                img.style.objectFit = 'cover';
                markerContent.appendChild(img);
            } else {
                const defaultIcon = document.createElement('div');
                defaultIcon.style.width = '100%';
                defaultIcon.style.height = '100%';
                defaultIcon.style.borderRadius = '50%';
                defaultIcon.style.background = 'linear-gradient(135deg, #4285F4, #2CC5C2)';
                defaultIcon.style.border = '3px solid white';
                defaultIcon.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                defaultIcon.style.display = 'flex';
                defaultIcon.style.alignItems = 'center';
                defaultIcon.style.justifyContent = 'center';
                defaultIcon.style.color = 'white';
                defaultIcon.style.fontSize = '16px';
                defaultIcon.style.fontWeight = 'bold';
                defaultIcon.textContent = username ? username.charAt(0).toUpperCase() : '?';
                markerContent.appendChild(defaultIcon);
            }
            
            const pulse = document.createElement('div');
            pulse.style.position = 'absolute';
            pulse.style.top = '50%';
            pulse.style.left = '50%';
            pulse.style.transform = 'translate(-50%, -50%)';
            pulse.style.width = '100%';
            pulse.style.height = '100%';
            pulse.style.borderRadius = '50%';
            pulse.style.border = '2px solid #4285F4';
            pulse.style.animation = 'pulse 1.5s ease-out infinite';
            pulse.style.pointerEvents = 'none';
            markerContent.appendChild(pulse);
            
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                currentLocationMarker = new google.maps.marker.AdvancedMarkerElement({
                    map: map,
                    position: position,
                    content: markerContent,
                    title: 'æ‚¨çš„ä½ç½®'
                });
            } else {
                currentLocationMarker = new google.maps.Marker({
                    map: map,
                    position: position,
                    title: 'æ‚¨çš„ä½ç½®',
                    icon: {
                        url: avatarUrl || 'data:image/svg+xml,' + encodeURIComponent(`
                            <svg width="36" height="36" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="18" cy="18" r="16" fill="#4285F4" stroke="white" stroke-width="3"/>
                                <text x="18" y="24" font-size="16" font-weight="bold" text-anchor="middle" fill="white">${username ? username.charAt(0).toUpperCase() : '?'}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(36, 36)
                    }
                });
            }
            
            userLocationCircle = new google.maps.Circle({
                map: map,
                center: position,
                radius: accuracy,
                fillColor: '#4285F4',
                fillOpacity: 0.1,
                strokeColor: '#4285F4',
                strokeOpacity: 0.5,
                strokeWeight: 1
            });
            
            markerContent.addEventListener('click', () => {
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding:8px; text-align:center;">
                            ${avatarUrl ? `<img src="${avatarUrl}" style="width:40px; height:40px; border-radius:50%; margin-bottom:8px; object-fit:cover;">` : ''}
                            <div style="font-weight:bold; color:var(--accent-dark);">æ‚¨çš„ä½ç½®</div>
                            <div style="font-size:11px; color:var(--muted);">${username || 'ç”¨æˆ¶'}</div>
                            <div style="font-size:11px; color:var(--muted);">ç²¾ç¢º: ${Math.round(accuracy)}m</div>
                        </div>
                    `
                });
                infoWindow.open(map, currentLocationMarker);
            });
        }

        // ç²å–ç›®å‰ä½ç½®
        window.getCurrentLocationAndCenter = function() {
            if (!map) {
                alert('åœ°åœ–å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }
            
            if (!navigator.geolocation) {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½');
                return;
            }

            const loadingEl = document.getElementById('locationLoading');
            const locationInfo = document.getElementById('locationInfo');
            
            if (loadingEl) loadingEl.style.display = 'block';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const currentPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    currentUserLocation = currentPos;
                    lastOriginPosition = currentPos;
                    
                    map.setCenter(currentPos);
                    map.setZoom(17);
                    
                    if (currentLocationMarker) currentLocationMarker.setMap(null);
                    if (userLocationCircle) userLocationCircle.setMap(null);
                    
                    const user = auth.currentUser;
                    
                    if (user) {
                        db.collection('users').doc(user.uid).get().then((doc) => {
                            let avatarUrl = null;
                            let username = user.displayName || user.email?.split('@')[0] || 'ç”¨æˆ¶';
                            
                            if (doc.exists) {
                                if (doc.data().profileImageUrl) {
                                    avatarUrl = doc.data().profileImageUrl;
                                }
                                if (doc.data().username) {
                                    username = doc.data().username;
                                }
                            }
                            
                            createCustomAvatarMarker(currentPos, avatarUrl, position.coords.accuracy, username);
                            
                            if (isSharingLocation) {
                                shareCurrentLocation();
                            }
                        }).catch((error) => {
                            console.error('ç²å–ç”¨æˆ¶è³‡æ–™éŒ¯èª¤:', error);
                            createCustomAvatarMarker(currentPos, null, position.coords.accuracy, 'ç”¨æˆ¶');
                        });
                    } else {
                        createCustomAvatarMarker(currentPos, null, position.coords.accuracy, 'è¨ªå®¢');
                    }
                    
                    if (locationInfo) {
                        locationInfo.textContent = `ğŸ“ ç²¾ç¢ºåº¦ï¼šç´„ ${Math.round(position.coords.accuracy)} å…¬å°º`;
                        locationInfo.style.display = 'block';
                        setTimeout(() => locationInfo.style.display = 'none', 5000);
                    }
                    
                    if (loadingEl) loadingEl.style.display = 'none';

                    if (currentDestinationPosition) {
                        calculateAndDisplayRoute(currentPos, currentDestinationPosition, currentTravelMode);
                    } else {
                        const infoWindow = new google.maps.InfoWindow({
                            content: '<div style="padding:8px;">ğŸ” ç¾åœ¨å¯ä»¥æœå°‹ç›®çš„åœ°</div>'
                        });
                        infoWindow.setPosition(currentPos);
                        infoWindow.open(map);
                    }
                },
                
                function(error) {
                    console.error('åœ°ç†ä½ç½®éŒ¯èª¤:', error);
                    if (loadingEl) loadingEl.style.display = 'none';
                    
                    let errorMessage = 'ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®ï¼š';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'æ‚¨æ‹’çµ•äº†ä½ç½®å­˜å–æ¬Šé™ã€‚';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'ä½ç½®è³‡è¨Šä¸å¯ç”¨ã€‚';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'æ“·å–ä½ç½®è¶…æ™‚ã€‚';
                            break;
                        default:
                            errorMessage += 'æœªçŸ¥éŒ¯èª¤ã€‚';
                    }
                    alert(errorMessage);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        };

        // æœå°‹é™„è¿‘è¨­æ–½
        window.searchNearby = function(type) {
            if (!map || !placesService) {
                alert('åœ°åœ–å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }

            clearNearbyMarkers();

            const btn = document.getElementById(getButtonId(type));
            if (btn) btn.classList.add('active');

            let searchCenter;
            if (searchLocationType === 'current') {
                if (!currentUserLocation) {
                    showToast('è«‹å…ˆé»æ“Šå®šä½æŒ‰éˆ•ç²å–æ‚¨çš„ä½ç½®');
                    return;
                }
                searchCenter = {
                    lat: currentUserLocation.lat,
                    lng: currentUserLocation.lng
                };
            } else {
                const center = map.getCenter();
                searchCenter = {
                    lat: center.lat(),
                    lng: center.lng()
                };
            }

            const typeNames = {
                'restaurant': { name: 'é¤å»³', icon: 'ğŸ½ï¸' },
                'hotel': { name: 'é…’åº—', icon: 'ğŸ¨' },
                'convenience_store': { name: 'ä¾¿åˆ©åº—', icon: 'ğŸª' },
                'cafe': { name: 'å’–å•¡å»³', icon: 'â˜•' },
                'gas_station': { name: 'åŠ æ²¹ç«™', icon: 'â›½' },
                'parking': { name: 'åœè»Šå ´', icon: 'ğŸ…¿ï¸' },
                'hospital': { name: 'é†«é™¢', icon: 'ğŸ¥' },
                'atm': { name: 'ææ¬¾æ©Ÿ', icon: 'ğŸ§' }
            };

            showToast(`æœå°‹ 1å…¬é‡Œå…§ ${typeNames[type].name}...`);

            const request = {
                location: new google.maps.LatLng(searchCenter.lat, searchCenter.lng),
                radius: 1000,
                type: type
            };

            placesService.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                    
                    const sortedResults = results.sort((a, b) => {
                        const distA = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(searchCenter.lat, searchCenter.lng), 
                            a.geometry.location
                        );
                        const distB = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(searchCenter.lat, searchCenter.lng), 
                            b.geometry.location
                        );
                        return distA - distB;
                    });

                    const oneKmResults = sortedResults.filter(place => {
                        const distance = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(searchCenter.lat, searchCenter.lng), 
                            place.geometry.location
                        );
                        return distance <= 1000;
                    });

                    if (oneKmResults.length === 0) {
                        showToast(`1å…¬é‡Œå…§æ‰¾ä¸åˆ°${typeNames[type].name}`);
                        return;
                    }

                    const top20Results = oneKmResults.slice(0, 20);

                    showToast(`æ‰¾åˆ° ${top20Results.length} é–“${typeNames[type].name}`);

                    top20Results.forEach((place) => {
                        createNearbyMarker(place, typeNames[type], searchCenter);
                    });

                    if (top20Results.length > 0) {
                        const bounds = new google.maps.LatLngBounds();
                        top20Results.forEach(place => {
                            bounds.extend(place.geometry.location);
                        });
                        
                        if (top20Results.length === 1) {
                            map.setCenter(top20Results[0].geometry.location);
                            map.setZoom(16);
                        } else {
                            map.fitBounds(bounds);
                            
                            const listener = google.maps.event.addListener(map, 'bounds_changed', function() {
                                if (map.getZoom() > 18) map.setZoom(18);
                                google.maps.event.removeListener(listener);
                            });
                        }
                    }
                } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                    showToast(`1å…¬é‡Œå…§æ‰¾ä¸åˆ°${typeNames[type].name}`);
                } else {
                    console.error('é™„è¿‘æœå°‹å¤±æ•—:', status);
                    let errorMsg = 'æœå°‹å¤±æ•—';
                    switch(status) {
                        case 'OVER_QUERY_LIMIT':
                            errorMsg = 'æŸ¥è©¢æ¬¡æ•¸è¶…éé™åˆ¶ï¼Œè«‹ç¨å¾Œå†è©¦';
                            break;
                        case 'REQUEST_DENIED':
                            errorMsg = 'è«‹æ±‚è¢«æ‹’çµ•';
                            break;
                        case 'INVALID_REQUEST':
                            errorMsg = 'ç„¡æ•ˆçš„è«‹æ±‚';
                            break;
                        default:
                            errorMsg = `æœå°‹å¤±æ•—ï¼š${status}`;
                    }
                    showToast(errorMsg);
                }
            });
        };

        // å»ºç«‹é™„è¿‘è¨­æ–½æ¨™è¨˜
        function createNearbyMarker(place, typeInfo, center) {
            let distanceText = '';
            let distance = 0;
            
            if (center) {
                distance = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(center.lat, center.lng), 
                    place.geometry.location
                );
                if (distance < 1000) {
                    distanceText = `<div style="font-size: 10px; color: var(--muted); margin-bottom: 3px;">ğŸ“ ${Math.round(distance)}m</div>`;
                } else {
                    distanceText = `<div style="font-size: 10px; color: var(--muted); margin-bottom: 3px;">ğŸ“ ${(distance/1000).toFixed(1)}km</div>`;
                }
            }

            const markerColors = {
                'restaurant': '#FF6B6B',
                'hotel': '#4ECDC4',
                'convenience_store': '#45B7D1',
                'cafe': '#FFB347',
                'gas_station': '#96CEB4',
                'parking': '#FFE194',
                'hospital': '#DDA0DD',
                'atm': '#FF9999'
            };

            let colorKey = 'restaurant';
            if (typeInfo.icon === 'ğŸ¨') colorKey = 'hotel';
            else if (typeInfo.icon === 'ğŸª') colorKey = 'convenience_store';
            else if (typeInfo.icon === 'â˜•') colorKey = 'cafe';
            else if (typeInfo.icon === 'â›½') colorKey = 'gas_station';
            else if (typeInfo.icon === 'ğŸ…¿ï¸') colorKey = 'parking';
            else if (typeInfo.icon === 'ğŸ¥') colorKey = 'hospital';
            else if (typeInfo.icon === 'ğŸ§') colorKey = 'atm';

            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: markerColors[colorKey],
                    fillOpacity: 0.9,
                    strokeColor: 'white',
                    strokeWeight: 2
                },
                animation: google.maps.Animation.DROP
            });

            marker.addListener('click', () => {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }

                const loadingInfoWindow = new google.maps.InfoWindow({
                    content: '<div style="padding:8px;">è¼‰å…¥ä¸­...</div>'
                });
                loadingInfoWindow.open(map, marker);
                currentInfoWindow = loadingInfoWindow;

                const request = {
                    placeId: place.place_id,
                    fields: ['name', 'formatted_address', 'formatted_phone_number', 'rating', 'website', 
                            'opening_hours', 'price_level', 'vicinity', 'user_ratings_total',
                            'types']
                };

                placesService.getDetails(request, (placeDetails, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && placeDetails) {
                        let ratingHtml = '';
                        if (placeDetails.rating) {
                            const fullStars = Math.round(placeDetails.rating);
                            const stars = 'â˜…'.repeat(fullStars) + 'â˜†'.repeat(5 - fullStars);
                            ratingHtml = `<div style="font-size: 11px; color: #f39c12; margin-bottom: 3px;">${stars} ${placeDetails.rating}</div>`;
                        }

                        let hoursHtml = '';
                        if (placeDetails.opening_hours) {
                            const isOpen = placeDetails.opening_hours.isOpen ? placeDetails.opening_hours.isOpen() : false;
                            const openStatus = isOpen ? 'ç‡Ÿæ¥­ä¸­' : 'ä¼‘æ¯ä¸­';
                            const statusColor = isOpen ? '#28a745' : '#dc3545';
                            hoursHtml = `<div style="font-size: 10px; color: ${statusColor}; margin-bottom: 3px;">${openStatus}</div>`;
                        }

                        const infoWindowContent = `
                            <div class="info-window">
                                <div class="info-window-title">${typeInfo.icon} ${placeDetails.name}</div>
                                ${hoursHtml}
                                ${ratingHtml}
                                ${distanceText}
                                <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">ğŸ“ ${placeDetails.formatted_address || place.vicinity || ''}</div>
                                <button class="info-window-btn" onclick="setDestination(${place.geometry.location.lat()}, ${place.geometry.location.lng()}, '${placeDetails.name.replace(/'/g, "\\'")}')">
                                    è¨­ç‚ºç›®çš„åœ°
                                </button>
                            </div>
                        `;

                        const infoWindow = new google.maps.InfoWindow({
                            content: infoWindowContent
                        });

                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                    } else {
                        const infoWindowContent = `
                            <div class="info-window">
                                <div class="info-window-title">${typeInfo.icon} ${place.name}</div>
                                ${distanceText}
                                <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">ğŸ“ ${place.vicinity || ''}</div>
                                <button class="info-window-btn" onclick="setDestination(${place.geometry.location.lat()}, ${place.geometry.location.lng()}, '${place.name.replace(/'/g, "\\'")}')">
                                    è¨­ç‚ºç›®çš„åœ°
                                </button>
                            </div>
                        `;

                        const infoWindow = new google.maps.InfoWindow({
                            content: infoWindowContent
                        });

                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                    }
                });
            });

            nearbyMarkers.push(marker);
        }

        function getButtonId(type) {
            const map = {
                'restaurant': 'btnRestaurant',
                'hotel': 'btnHotel',
                'convenience_store': 'btnStore',
                'cafe': 'btnCafe',
                'gas_station': 'btnGas',
                'parking': 'btnParking',
                'hospital': 'btnHospital',
                'atm': 'btnATM'
            };
            return map[type] || '';
        }

        window.setDestination = function(lat, lng, name) {
            currentDestinationPosition = { lat, lng };
            
            clearNearbyMarkers();
            
            map.setCenter({ lat, lng });
            map.setZoom(17);
            
            if (searchMarker) {
                searchMarker.setMap(null);
            }
            
            searchMarker = new google.maps.Marker({
                map: map,
                position: { lat, lng },
                title: name,
                animation: google.maps.Animation.DROP
            });
            
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div class="info-window">
                        <div class="info-window-title">ğŸ“ ç›®çš„åœ°</div>
                        <div class="info-window-address">${name}</div>
                        <small style="color:var(--accent);">âœ… å·²è¨­ç‚ºç›®çš„åœ°</small>
                    </div>
                `
            });
            
            infoWindow.open(map, searchMarker);
            
            if (lastOriginPosition) {
                calculateAndDisplayRoute(lastOriginPosition, currentDestinationPosition, currentTravelMode);
            }

            if (currentInfoWindow) {
                currentInfoWindow.close();
            }
        };

        function handlePlaceSelected(place) {
            if (!map) {
                alert('åœ°åœ–å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }
            
            const position = place.geometry.location;
            
            currentDestinationPosition = {
                lat: position.lat(),
                lng: position.lng()
            };
            
            map.setCenter(position);
            map.setZoom(17);
            
            if (searchMarker) {
                searchMarker.setMap(null);
            }
            
            searchMarker = new google.maps.Marker({
                map: map,
                position: position,
                title: place.name,
                animation: google.maps.Animation.DROP
            });
            
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div class="info-window">
                        <div class="info-window-title">${place.name}</div>
                        <div class="info-window-address">${place.formatted_address || ''}</div>
                        <small style="color:var(--accent);">âœ… é¸æ“‡äº¤é€šæ¨¡å¼</small>
                    </div>
                `
            });
            
            infoWindow.open(map, searchMarker);

            if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
            document.getElementById('routeSummary').classList.remove('show');
            
            if (lastOriginPosition) {
                autoPlanRoute();
            }

            clearNearbyMarkers();
        }

        window.searchPlace = function() {
            if (!map || !placesService) {
                alert('åœ°åœ–å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }
            
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const request = {
                query: query,
                fields: ['name', 'geometry', 'formatted_address']
            };

            placesService.findPlaceFromQuery(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                    const place = results[0];
                    const position = place.geometry.location;
                    
                    currentDestinationPosition = {
                        lat: position.lat(),
                        lng: position.lng()
                    };
                    
                    map.setCenter(position);
                    map.setZoom(17);
                    
                    if (searchMarker) searchMarker.setMap(null);
                    
                    searchMarker = new google.maps.Marker({
                        map: map,
                        position: position,
                        title: place.name,
                        animation: google.maps.Animation.DROP
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="info-window">
                                <div class="info-window-title">${place.name}</div>
                                <div class="info-window-address">${place.formatted_address || ''}</div>
                                <small style="color:var(--accent);">âœ… é¸æ“‡äº¤é€šæ¨¡å¼</small>
                            </div>
                        `
                    });
                    infoWindow.open(map, searchMarker);
                    
                    if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
                    document.getElementById('routeSummary').classList.remove('show');
                    
                    if (lastOriginPosition) {
                        autoPlanRoute();
                    }

                    clearNearbyMarkers();
                } else {
                    alert('æ‰¾ä¸åˆ°è©²åœ°é»ï¼Œè«‹å˜—è©¦å…¶ä»–é—œéµå­—');
                }
            });
        };

        function autoPlanRoute() {
            if (lastOriginPosition && currentDestinationPosition) {
                calculateAndDisplayRoute(lastOriginPosition, currentDestinationPosition, currentTravelMode);
            }
        }

        window.setTravelMode = function(mode) {
            document.querySelectorAll('.route-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.route-mode-btn[data-mode="${mode}"]`).classList.add('active');
            
            currentTravelMode = mode;
            
            if (lastOriginPosition && currentDestinationPosition) {
                calculateAndDisplayRoute(lastOriginPosition, currentDestinationPosition, mode);
            } else if (!lastOriginPosition) {
                if (map) {
                    const infoWindow = new google.maps.InfoWindow({
                        content: '<div style="padding:8px;">ğŸ“ è«‹å…ˆé»æ“Šå·¦ä¸‹è§’æŒ‰éˆ•ç²å–æ‚¨çš„ä½ç½®</div>'
                    });
                    infoWindow.setPosition(map.getCenter());
                    infoWindow.open(map);
                }
            } else if (!currentDestinationPosition) {
                if (map) {
                    const infoWindow = new google.maps.InfoWindow({
                        content: '<div style="padding:8px;">ğŸ” è«‹å…ˆæœå°‹ç›®çš„åœ°</div>'
                    });
                    infoWindow.setPosition(map.getCenter());
                    infoWindow.open(map);
                }
            }
        };

        function getGoogleTravelMode(mode) {
            switch(mode) {
                case 'DRIVING': return google.maps.TravelMode.DRIVING;
                case 'TRANSIT': return google.maps.TravelMode.TRANSIT;
                case 'WALKING': return google.maps.TravelMode.WALKING;
                case 'BICYCLING': return google.maps.TravelMode.BICYCLING;
                default: return google.maps.TravelMode.DRIVING;
            }
        }

        function calculateAndDisplayRoute(origin, destination, mode) {
            if (!directionsService || !directionsRenderer) return;

            const travelMode = getGoogleTravelMode(mode);

            const request = {
                origin: origin,
                destination: destination,
                travelMode: travelMode,
                unitSystem: google.maps.UnitSystem.METRIC
            };

            if (mode === 'TRANSIT') {
                request.transitOptions = {
                    modes: [google.maps.TransitMode.BUS, google.maps.TransitMode.RAIL],
                    routingPreference: google.maps.TransitRoutePreference.FEWER_TRANSFERS
                };
            }

            directionsService.route(request, (result, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);
                    
                    const route = result.routes[0];
                    if (route && route.legs.length > 0) {
                        const leg = route.legs[0];
                        const distance = leg.distance.text;
                        const duration = leg.duration.text;
                        
                        let modeIcon = 'ğŸš—';
                        if (mode === 'TRANSIT') modeIcon = 'ğŸš†';
                        else if (mode === 'WALKING') modeIcon = 'ğŸš¶';
                        else if (mode === 'BICYCLING') modeIcon = 'ğŸš²';
                        
                        let summaryHtml = `
                            <strong>${modeIcon} è·¯ç·š (${getModeName(mode)})</strong><br>
                            <span>${distance} | ${duration}</span>
                        `;
                        document.getElementById('routeSummaryContent').innerHTML = summaryHtml;

                        if (mode === 'TRANSIT' && leg.steps) {
                            let transitStepsHtml = '<hr style="margin:5px 0"><strong>ğŸš‰ è½‰ä¹˜</strong>';
                            leg.steps.forEach((step) => {
                                if (step.travel_mode === 'TRANSIT' && step.transit) {
                                    const line = step.transit.line;
                                    const vehicle = line.vehicle;
                                    const icon = vehicle && vehicle.type === 'BUS' ? 'ğŸšŒ' : 'ğŸš†';
                                    const departureStop = step.transit.departure_stop.name;
                                    const arrivalStop = step.transit.arrival_stop.name;
                                    transitStepsHtml += `
                                        <div class="transit-step">
                                            <span>${icon}</span>
                                            <span>${departureStop}â†’${arrivalStop}</span>
                                            <small>(${step.duration.text})</small>
                                        </div>
                                    `;
                                } else if (step.travel_mode === 'WALKING') {
                                    transitStepsHtml += `<div class="transit-step"><span>ğŸš¶ æ­¥è¡Œ ${step.distance.text}</span></div>`;
                                }
                            });
                            document.getElementById('transitDetailed').innerHTML = transitStepsHtml;
                        } else {
                            document.getElementById('transitDetailed').innerHTML = '';
                        }

                        document.getElementById('routeSummary').classList.add('show');
                    }
                } else {
                    console.log('è·¯ç·šè¦åŠƒå¤±æ•—:', status);
                }
            });
        }

        function getModeName(mode) {
            switch(mode) {
                case 'DRIVING': return 'é–‹è»Š';
                case 'TRANSIT': return 'å¤§çœ¾';
                case 'WALKING': return 'æ­¥è¡Œ';
                case 'BICYCLING': return 'å–®è»Š';
                default: return 'æœªçŸ¥';
            }
        }

        window.closeRoutePanel = function() {
            document.getElementById('routeSummary').classList.remove('show');
            if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
        };

        function showMeetingLocationFromStorage() {
            try {
                const savedLocation = localStorage.getItem('meetingLocation');
                if (savedLocation && map) {
                    const locationData = JSON.parse(savedLocation);
                    const now = new Date().getTime();
                    
                    if (now - locationData.timestamp < 5 * 60 * 1000) {
                        const position = {
                            lat: locationData.lat,
                            lng: locationData.lng
                        };
                        
                        map.setCenter(position);
                        map.setZoom(17);
                        
                        if (meetingLocationMarker) meetingLocationMarker.setMap(null);
                        
                        meetingLocationMarker = new google.maps.Marker({
                            map: map,
                            position: position,
                            title: 'æœƒåˆé»',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#FF4444',
                                fillOpacity: 1,
                                strokeColor: 'white',
                                strokeWeight: 3
                            }
                        });
                        
                        if (meetingInfoWindow) meetingInfoWindow.close();
                        
                        meetingInfoWindow = new google.maps.InfoWindow({
                            content: `
                                <div class="meeting-info-window">
                                    <div class="meeting-info-title">ğŸ¯ æœƒåˆé»</div>
                                    <div class="meeting-info-address">ğŸ“ ${locationData.address || ''}</div>
                                </div>
                            `
                        });
                        
                        setTimeout(() => meetingInfoWindow.open(map, meetingLocationMarker), 500);
                        localStorage.removeItem('meetingLocation');
                    } else {
                        localStorage.removeItem('meetingLocation');
                    }
                }
            } catch (error) {
                console.error('è®€å–æœƒåˆé»è³‡æ–™éŒ¯èª¤:', error);
                localStorage.removeItem('meetingLocation');
            }
        }

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('ç”¨æˆ¶å·²ç™»å…¥');
                if (isMapInitialized) {
                    loadUserGroups();
                }
            } else {
                console.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œåœ°åœ–ä»¥è¨ªå®¢æ¨¡å¼é¡¯ç¤º');
            }
        });

        // é é¢å¸è¼‰æ™‚åœæ­¢åˆ†äº«
        window.addEventListener('beforeunload', () => {
            stopSharingLocation();
            if (unsubscribeGroupLocations) {
                unsubscribeGroupLocations();
            }
        });

        document.addEventListener('touchstart', function(e) {
        }, { passive: true });
    </script>
</body>
</html>