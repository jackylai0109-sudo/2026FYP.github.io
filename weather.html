<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>TravelSync Â· å¤©æ°£æŸ¥è©¢</title>
    
    <!-- ä½¿ç”¨è¼ƒæ–°çš„ Places API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXCOcFaB80u9FjnEkQf-DlMOPqAJyGngA&libraries=places&callback=initGooglePlaces&loading=async" defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤è§¸æ‘¸é«˜äº® */
        }

        :root {
            --accent: #2CC5C2;
            --accent-dark: #0C344E;
            --bg: #f5fbfb;
            --card: #ffffff;
            --muted: #6b7b86;
            --radius: 14px;
        }

        body {
            font-family: 'Noto Sans', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f2fbfb 0%, #ebf8f8 100%);
            min-height: 100vh;
            padding: 20px;
            touch-action: pan-y pinch-zoom; /* å…è¨±å‚ç›´æ»‘å‹•å’Œç¸®æ”¾ */
        }

        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            flex-wrap: wrap;
        }

        .back-btn {
            padding: 10px 20px;
            background: white;
            border: 1px solid var(--accent);
            border-radius: 10px;
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .back-btn:hover {
            background: var(--accent);
            color: white;
        }

        .back-btn:active {
            transform: scale(0.95);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .search-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: 0 6px 20px rgba(6, 30, 38, 0.06);
            margin-bottom: 20px;
        }

        h2 {
            color: var(--accent-dark);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            position: relative;
            width: 100%;
        }

        .search-container {
            position: relative;
            flex: 1;
            min-width: 0;
        }

        .search-input {
            width: 100%;
            padding: 16px 18px;
            border: 1px solid #e6eef0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            -webkit-appearance: none;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(44, 197, 194, 0.1);
        }

        .search-btn {
            padding: 16px 32px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            -webkit-tap-highlight-color: transparent;
        }

        .search-btn:hover {
            background: #28b5b2;
            transform: translateY(-2px);
        }

        .search-btn:active {
            transform: scale(0.95);
        }

        .use-location-btn {
            padding: 16px 28px;
            background: white;
            border: 1px solid var(--accent);
            color: var(--accent);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
            -webkit-tap-highlight-color: transparent;
        }

        .use-location-btn:hover {
            background: #f0fcfc;
            transform: translateY(-2px);
        }

        .use-location-btn:active {
            transform: scale(0.95);
        }

        /* Google Places è‡ªå‹•å®Œæˆä¸‹æ‹‰é¸å–® */
        .pac-container {
            border-radius: 12px;
            margin-top: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #e6eef0;
            font-family: 'Noto Sans', 'Segoe UI', Roboto, sans-serif;
            z-index: 1000;
            width: 100% !important;
        }

        .pac-item {
            padding: 12px 16px;
            cursor: pointer;
            border-top: 1px solid #eef2f2;
            font-size: 15px;
        }

        .pac-item:hover {
            background: #f0fcfc;
        }

        .pac-item:active {
            background: #e0f5f5;
        }

        .pac-item:first-child {
            border-top: none;
        }

        .recent-searches {
            margin-top: 20px;
        }

        .recent-title {
            color: var(--muted);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .recent-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .recent-tag {
            padding: 8px 16px;
            background: #f0f8f8;
            border-radius: 20px;
            font-size: 14px;
            color: var(--accent-dark);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            -webkit-tap-highlight-color: transparent;
        }

        .recent-tag:hover {
            background: white;
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .recent-tag:active {
            transform: scale(0.95);
        }

        .weather-display {
            background: var(--card);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: 0 6px 20px rgba(6, 30, 38, 0.06);
            display: none;
        }

        .weather-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eef2f2;
            flex-wrap: wrap;
            gap: 15px;
        }

        .location-info h3 {
            color: var(--accent-dark);
            font-size: 24px;
            margin-bottom: 5px;
        }

        .location-info p {
            color: var(--muted);
            font-size: 14px;
            word-break: break-word;
        }

        .current-weather {
            text-align: right;
        }

        .current-temp {
            font-size: 48px;
            font-weight: 700;
            color: var(--accent-dark);
            line-height: 1;
        }

        .current-desc {
            color: var(--muted);
            font-size: 16px;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .weather-card {
            background: linear-gradient(135deg, #f8fcfc, #f0f8f8);
            border-radius: 16px;
            padding: 20px 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #e6eef0;
            cursor: pointer;
        }

        .weather-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 8px 20px rgba(44, 197, 194, 0.1);
        }

        .weather-card:active {
            transform: scale(0.95);
        }

        .weather-day {
            font-weight: 600;
            color: var(--accent-dark);
            margin-bottom: 10px;
            font-size: 16px;
        }

        .weather-date {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 15px;
        }

        .weather-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .weather-temp {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-dark);
            margin-bottom: 5px;
        }

        .weather-temp-range {
            font-size: 14px;
            color: var(--muted);
        }

        .weather-desc {
            font-size: 13px;
            color: var(--muted);
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            text-align: center;
            padding: 40px;
            color: #ff5a5f;
        }

        .api-status {
            text-align: center;
            padding: 15px;
            background: #fff3cd;
            color: #856404;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }

        .google-attribution {
            text-align: center;
            margin-top: 15px;
            font-size: 12px;
            color: var(--muted);
        }

        /* ğŸ”´ æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .header {
                margin-bottom: 20px;
                gap: 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .back-btn {
                padding: 8px 16px;
                font-size: 14px;
            }

            .search-card {
                padding: 20px;
            }

            h2 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }

            .search-box {
                flex-direction: column;
                gap: 12px;
            }
            
            .search-input {
                width: 100%;
                padding: 14px 16px;
                font-size: 15px;
            }
            
            .search-btn {
                width: 100%;
                padding: 14px;
                font-size: 15px;
            }

            .use-location-btn {
                padding: 14px;
                font-size: 15px;
            }

            .pac-item {
                padding: 10px 14px;
                font-size: 14px;
            }

            .recent-tag {
                padding: 6px 14px;
                font-size: 13px;
            }

            .weather-display {
                padding: 20px;
            }

            .weather-header {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }

            .current-weather {
                text-align: left;
                width: 100%;
            }

            .location-info h3 {
                font-size: 22px;
            }

            .current-temp {
                font-size: 42px;
            }

            .weather-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .weather-card {
                padding: 15px 10px;
            }

            .weather-day {
                font-size: 14px;
            }

            .weather-icon {
                font-size: 40px;
            }

            .weather-temp {
                font-size: 18px;
            }

            .weather-desc {
                font-size: 12px;
            }
        }

        /* ğŸ”´ å°æ‰‹æ©Ÿå°ˆç”¨ */
        @media (max-width: 480px) {
            .header {
                margin-bottom: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .search-card {
                padding: 15px;
            }

            h2 {
                font-size: 1.2rem;
            }

            .search-input {
                padding: 12px 14px;
                font-size: 14px;
            }

            .search-btn {
                padding: 12px;
                font-size: 14px;
            }

            .use-location-btn {
                padding: 12px;
                font-size: 14px;
                margin-bottom: 15px;
            }

            .recent-title {
                font-size: 13px;
            }

            .recent-tag {
                padding: 5px 12px;
                font-size: 12px;
            }

            .weather-display {
                padding: 15px;
            }

            .location-info h3 {
                font-size: 20px;
            }

            .location-info p {
                font-size: 12px;
            }

            .current-temp {
                font-size: 36px;
            }

            .current-desc {
                font-size: 14px;
            }

            .weather-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .weather-card {
                display: flex;
                align-items: center;
                text-align: left;
                padding: 12px;
                gap: 15px;
            }

            .weather-card > div {
                flex: 1;
            }

            .weather-day {
                margin-bottom: 0;
                font-size: 14px;
            }

            .weather-date {
                margin-bottom: 0;
            }

            .weather-icon {
                font-size: 36px;
                margin-bottom: 0;
            }

            .weather-temp {
                font-size: 18px;
                margin-bottom: 0;
            }

            .weather-temp-range {
                font-size: 13px;
            }

            .weather-desc {
                margin-top: 0;
                text-align: right;
            }
        }

        /* æ¥µå°è¢å¹• (å¦‚ iPhone SE) */
        @media (max-width: 375px) {
            .header h1 {
                font-size: 18px;
            }

            .weather-card {
                flex-wrap: wrap;
                gap: 8px;
            }

            .weather-card > div {
                min-width: 80px;
            }

            .weather-icon {
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-btn">â† è¿”å›</a>
        <h1>å¤©æ°£æŸ¥è©¢</h1>
    </div>

    <div class="container">
        <!-- API ç‹€æ…‹æç¤º -->
        <div class="api-status" id="apiStatus">â³ æ­£åœ¨è¼‰å…¥ Google Places API...</div>

        <!-- æœå°‹å¡ç‰‡ -->
        <div class="search-card">
            <h2>æœå°‹åœ°é»å¤©æ°£</h2>
            <div class="search-box">
                <div class="search-container">
                    <input type="text" 
                           class="search-input" 
                           id="placeInput" 
                           placeholder="è¼¸å…¥åŸå¸‚æˆ–æ™¯é»"
                           autocomplete="off"
                           disabled>
                </div>
                <button class="search-btn" id="searchBtn" onclick="searchPlace()" disabled>æœå°‹</button>
            </div>
            
            <button class="use-location-btn" id="useLocationBtn" onclick="getLocationWeather()" disabled>
                ğŸ“ ä½¿ç”¨æˆ‘çš„ä½ç½®
            </button>

            <div class="recent-searches" id="recentSearches"></div>
        </div>

        <!-- å¤©æ°£é¡¯ç¤ºå¡ç‰‡ -->
        <div class="weather-display" id="weatherDisplay">
            <div class="weather-header">
                <div class="location-info">
                    <h3 id="locationName">-</h3>
                    <p id="locationDetail">7 å¤©å¤©æ°£é å ±</p>
                </div>
                <div class="current-weather">
                    <div class="current-temp" id="currentTemp">-</div>
                    <div class="current-desc" id="currentDesc">-</div>
                </div>
            </div>

            <div id="weatherGrid" class="weather-grid"></div>
            
            <div class="google-attribution">åœ°é»è³‡è¨Šæä¾›ï¼šGoogle Places</div>
        </div>
    </div>

    <script>
        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        let autocomplete;
        let geocoder;
        let mapsInitialized = false;
        let recentSearches = [];

        // ==================== Google Places åˆå§‹åŒ– ====================
        window.initGooglePlaces = function() {
            console.log('Google Places API åˆå§‹åŒ–æˆåŠŸ');
            
            try {
                // æª¢æŸ¥å¿…è¦å…ƒç´ 
                const input = document.getElementById('placeInput');
                if (!input) {
                    throw new Error('æ‰¾ä¸åˆ°è¼¸å…¥æ¡†å…ƒç´ ');
                }

                // åˆå§‹åŒ– Geocoder
                geocoder = new google.maps.Geocoder();
                
                // åˆå§‹åŒ– Places Autocomplete
                autocomplete = new google.maps.places.Autocomplete(input, {
                    types: ['(cities)'],
                    fields: ['place_id', 'name', 'formatted_address', 'geometry', 'address_components']
                });

                autocomplete.addListener('place_changed', function() {
                    const place = autocomplete.getPlace();
                    if (place && place.geometry) {
                        handlePlaceSelected(place);
                    }
                });

                mapsInitialized = true;
                
                // å•Ÿç”¨è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•
                document.getElementById('placeInput').disabled = false;
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('useLocationBtn').disabled = false;
                
                // éš±è—ç‹€æ…‹æç¤º
                const apiStatus = document.getElementById('apiStatus');
                if (apiStatus) {
                    apiStatus.style.display = 'none';
                }
                
                // è¼‰å…¥æœ€è¿‘æœå°‹è¨˜éŒ„
                loadRecentSearches();
                
                console.log('Places Autocomplete åˆå§‹åŒ–æˆåŠŸ');
                
            } catch (error) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                handleInitError(error.message);
            }
        };

        // è™•ç†åˆå§‹åŒ–éŒ¯èª¤
        function handleInitError(message) {
            const apiStatus = document.getElementById('apiStatus');
            if (apiStatus) {
                apiStatus.innerHTML = 'âŒ Google Places API åˆå§‹åŒ–å¤±æ•—ï¼š' + message;
                apiStatus.style.background = '#f8d7da';
                apiStatus.style.color = '#721c24';
                apiStatus.style.display = 'block';
            }
        }

        // ==================== API é©—è­‰éŒ¯èª¤è™•ç† ====================
        window.gm_authFailure = function() {
            handleInitError('API é‡‘é‘°é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥é‡‘é‘°è¨­å®š');
        };

        // ==================== è¼‰å…¥æœ€è¿‘æœå°‹ ====================
        function loadRecentSearches() {
            try {
                const saved = localStorage.getItem('recentWeatherSearches');
                if (saved) {
                    recentSearches = JSON.parse(saved);
                    updateRecentSearches();
                }
            } catch (e) {
                console.error('è¼‰å…¥æœ€è¿‘æœå°‹å¤±æ•—:', e);
            }
        }

        // ==================== è™•ç†é¸æ“‡çš„åœ°é» ====================
        function handlePlaceSelected(place) {
            const lat = place.geometry.location.lat();
            const lng = place.geometry.location.lng();
            
            let displayName = place.name;
            let fullAddress = place.formatted_address || displayName;
            
            // å˜—è©¦å–å¾—æ›´å¥½çš„é¡¯ç¤ºåç¨±
            if (place.address_components) {
                for (const component of place.address_components) {
                    if (component.types.includes('locality')) {
                        displayName = component.long_name;
                        break;
                    } else if (component.types.includes('administrative_area_level_1')) {
                        displayName = component.long_name;
                    }
                }
            }
            
            fetchWeather(displayName, lat, lng, fullAddress);
        }

        // ==================== æœå°‹åœ°é» ====================
        function searchPlace() {
            const input = document.getElementById('placeInput').value.trim();
            
            if (!input) {
                alert('è«‹è¼¸å…¥åœ°é»åç¨±');
                return;
            }

            if (!mapsInitialized || !geocoder) {
                alert('Google Places API å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            document.getElementById('weatherDisplay').style.display = 'block';
            document.getElementById('weatherGrid').innerHTML = `
                <div class="loading" style="grid-column: 1/-1;">
                    <div class="spinner"></div>
                    <p>æœå°‹åœ°é»ä¸­...</p>
                </div>
            `;

            // ä½¿ç”¨ Geocoder é€²è¡Œåœ°ç†ç·¨ç¢¼
            geocoder.geocode(
                { 
                    address: input,
                    language: 'zh-TW',
                    region: 'tw'
                }, 
                (results, status) => {
                    if (status === 'OK' && results.length > 0) {
                        const place = results[0];
                        const lat = place.geometry.location.lat();
                        const lng = place.geometry.location.lng();
                        
                        // å–å¾—é¡¯ç¤ºåç¨±
                        let displayName = input;
                        let fullAddress = place.formatted_address;
                        
                        // å¾ address_components å–å¾—æ›´å¥½çš„åç¨±
                        if (place.address_components) {
                            for (const component of place.address_components) {
                                if (component.types.includes('locality')) {
                                    displayName = component.long_name;
                                    break;
                                } else if (component.types.includes('administrative_area_level_1')) {
                                    displayName = component.long_name;
                                }
                            }
                        }
                        
                        fetchWeather(displayName, lat, lng, fullAddress);
                    } else {
                        let errorMsg = 'æ‰¾ä¸åˆ°è©²åœ°é»';
                        if (status === 'ZERO_RESULTS') {
                            errorMsg = 'æ‰¾ä¸åˆ°è©²åœ°é»ï¼Œè«‹å˜—è©¦å…¶ä»–é—œéµå­—';
                        } else if (status === 'OVER_QUERY_LIMIT') {
                            errorMsg = 'æŸ¥è©¢æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦';
                        } else if (status === 'REQUEST_DENIED') {
                            errorMsg = 'è«‹æ±‚è¢«æ‹’çµ•ï¼Œè«‹æª¢æŸ¥ API é‡‘é‘°';
                        } else if (status === 'INVALID_REQUEST') {
                            errorMsg = 'ç„¡æ•ˆçš„è«‹æ±‚';
                        }
                        
                        document.getElementById('weatherGrid').innerHTML = `
                            <div class="error-message" style="grid-column: 1/-1;">
                                <p>âŒ ${errorMsg}</p>
                            </div>
                        `;
                    }
                }
            );
        }

        // ==================== ä½¿ç”¨ç›®å‰ä½ç½® ====================
        function getLocationWeather() {
            if (!navigator.geolocation) {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½');
                return;
            }

            if (!mapsInitialized || !geocoder) {
                alert('Google Places API å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }

            document.getElementById('weatherDisplay').style.display = 'block';
            document.getElementById('weatherGrid').innerHTML = `
                <div class="loading" style="grid-column: 1/-1;">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...</p>
                </div>
            `;

            const timeoutId = setTimeout(() => {
                document.getElementById('weatherGrid').innerHTML = `
                    <div class="error-message" style="grid-column: 1/-1;">
                        <p>âŒ å®šä½è¶…æ™‚</p>
                        <p style="font-size:14px; margin-top:10px;">è«‹ç¢ºèª GPS å·²é–‹å•Ÿï¼Œä¸¦åˆ°æˆ¶å¤–ç©ºæ› è™•é‡è©¦</p>
                    </div>
                `;
            }, 15000);

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    clearTimeout(timeoutId);
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // åå‘åœ°ç†ç·¨ç¢¼å–å¾—åœ°é»åç¨±
                    geocoder.geocode(
                        { 
                            location: { lat, lng },
                            language: 'zh-TW'
                        }, 
                        (results, status) => {
                            if (status === 'OK' && results.length > 0) {
                                const place = results[0];
                                let displayName = 'ç›®å‰ä½ç½®';
                                let fullAddress = place.formatted_address;
                                
                                // å˜—è©¦å–å¾—åŸå¸‚åç¨±
                                if (place.address_components) {
                                    for (const component of place.address_components) {
                                        if (component.types.includes('locality')) {
                                            displayName = component.long_name;
                                            break;
                                        } else if (component.types.includes('administrative_area_level_1')) {
                                            displayName = component.long_name;
                                        }
                                    }
                                }
                                
                                fetchWeather(displayName, lat, lng, fullAddress);
                            } else {
                                fetchWeather('ç›®å‰ä½ç½®', lat, lng, '');
                            }
                        }
                    );
                },
                (error) => {
                    clearTimeout(timeoutId);
                    
                    let errorMessage = 'ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®ï¼š';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'è«‹å…è¨±ç€è¦½å™¨å­˜å–æ‚¨çš„ä½ç½®';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'ç„¡æ³•å–å¾—ä½ç½®è³‡è¨Šï¼Œè«‹æª¢æŸ¥ GPS æ˜¯å¦é–‹å•Ÿ';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'å®šä½è¶…æ™‚ï¼Œè«‹åˆ°æˆ¶å¤–ç©ºæ› è™•é‡è©¦';
                            break;
                        default:
                            errorMessage = 'å®šä½å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                    }
                    
                    document.getElementById('weatherGrid').innerHTML = `
                        <div class="error-message" style="grid-column: 1/-1;">
                            <p>âŒ ${errorMessage}</p>
                        </div>
                    `;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // ==================== å–å¾—å¤©æ°£è³‡æ–™ ====================
        async function fetchWeather(displayName, lat, lon, fullAddress) {
            document.getElementById('weatherDisplay').style.display = 'block';
            document.getElementById('weatherGrid').innerHTML = `
                <div class="loading" style="grid-column: 1/-1;">
                    <div class="spinner"></div>
                    <p>è¼‰å…¥å¤©æ°£è³‡æ–™ä¸­...</p>
                </div>
            `;

            try {
                // ä½¿ç”¨ Open-Meteo API å–å¾—å¤©æ°£è³‡æ–™
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=7`
                );
                
                if (!response.ok) {
                    throw new Error('å¤©æ°£è³‡æ–™è¼‰å…¥å¤±æ•—');
                }
                
                const data = await response.json();

                // æ›´æ–°ä½ç½®è³‡è¨Š
                document.getElementById('locationName').textContent = displayName;
                document.getElementById('locationDetail').textContent = fullAddress || `${displayName} Â· 7 å¤©å¤©æ°£é å ±`;

                // å–å¾—ä»Šå¤©çš„å¤©æ°£
                const today = data.daily;
                const todayWeatherCode = today.weathercode[0];
                const todayMax = Math.round(today.temperature_2m_max[0]);
                const todayMin = Math.round(today.temperature_2m_min[0]);
                
                document.getElementById('currentTemp').innerHTML = `${todayMax}Â°<span style="font-size:16px; color:var(--muted);">/${todayMin}Â°</span>`;
                document.getElementById('currentDesc').textContent = getWeatherDescription(todayWeatherCode);

                // ç”¢ç”Ÿ 7 å¤©é å ±
                const weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                let weatherHtml = '';

                for (let i = 0; i < today.time.length; i++) {
                    const date = new Date(today.time[i]);
                    const weekday = weekdays[date.getDay()];
                    const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                    
                    const weatherCode = today.weathercode[i];
                    const weatherIcon = getWeatherIcon(weatherCode);
                    const weatherDesc = getWeatherDescription(weatherCode);
                    
                    const maxTemp = Math.round(today.temperature_2m_max[i]);
                    const minTemp = Math.round(today.temperature_2m_min[i]);
                    
                    weatherHtml += `
                        <div class="weather-card" onclick="alert('${displayName} ${weekday} ${dateStr}ï¼š${weatherDesc}ï¼Œæœ€é«˜ ${maxTemp}Â° / æœ€ä½ ${minTemp}Â°')">
                            <div class="weather-day">${weekday}</div>
                            <div class="weather-date">${dateStr}</div>
                            <div class="weather-icon">${weatherIcon}</div>
                            <div class="weather-temp">${maxTemp}Â°</div>
                            <div class="weather-temp-range">${minTemp}Â°</div>
                            <div class="weather-desc">${weatherDesc}</div>
                        </div>
                    `;
                }

                document.getElementById('weatherGrid').innerHTML = weatherHtml;

                // å„²å­˜åˆ°æœ€è¿‘æœå°‹
                addToRecentSearches(displayName, lat, lon, fullAddress || displayName);

            } catch (error) {
                console.error('å–å¾—å¤©æ°£è³‡æ–™éŒ¯èª¤:', error);
                document.getElementById('weatherGrid').innerHTML = `
                    <div class="error-message" style="grid-column: 1/-1;">
                        <p>âŒ ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™</p>
                        <p style="font-size:14px; margin-top:10px;">è«‹ç¨å¾Œå†è©¦</p>
                    </div>
                `;
            }
        }

        // ==================== å¤©æ°£è¼”åŠ©å‡½æ•¸ ====================
        function getWeatherIcon(code) {
            if (code === 0 || code === 1) return 'â˜€ï¸';
            if (code === 2) return 'â›…';
            if (code === 3) return 'â˜ï¸';
            if (code >= 45 && code <= 49) return 'ğŸŒ«ï¸';
            if (code >= 51 && code <= 55) return 'ğŸŒ§ï¸';
            if (code >= 61 && code <= 65) return 'ğŸŒ§ï¸';
            if (code >= 71 && code <= 75) return 'â„ï¸';
            if (code >= 80 && code <= 82) return 'ğŸŒ¦ï¸';
            if (code >= 95 && code <= 99) return 'â›ˆï¸';
            return 'â˜ï¸';
        }

        function getWeatherDescription(code) {
            if (code === 0) return 'æ™´å¤©';
            if (code === 1) return 'å¤šé›²æ™‚æ™´';
            if (code === 2) return 'å¤šé›²';
            if (code === 3) return 'é™°å¤©';
            if (code >= 45 && code <= 49) return 'æœ‰éœ§';
            if (code >= 51 && code <= 55) return 'æ¯›æ¯›é›¨';
            if (code >= 61 && code <= 65) return 'é›¨å¤©';
            if (code >= 71 && code <= 75) return 'ä¸‹é›ª';
            if (code >= 80 && code <= 82) return 'é™£é›¨';
            if (code >= 95 && code <= 99) return 'é›·é›¨';
            return 'æœªçŸ¥';
        }

        // ==================== æœ€è¿‘æœå°‹åŠŸèƒ½ ====================
        function addToRecentSearches(name, lat, lon, address) {
            const search = { name, lat, lon, address: address || '' };
            
            // ç§»é™¤é‡è¤‡çš„
            recentSearches = recentSearches.filter(s => s.name !== name);
            
            // åŠ åˆ°æœ€å‰é¢
            recentSearches.unshift(search);
            
            // åªä¿ç•™æœ€è¿‘5ç­†
            if (recentSearches.length > 5) {
                recentSearches.pop();
            }
            
            // å„²å­˜åˆ° localStorage
            localStorage.setItem('recentWeatherSearches', JSON.stringify(recentSearches));
            
            // æ›´æ–°é¡¯ç¤º
            updateRecentSearches();
        }

        function updateRecentSearches() {
            const recentDiv = document.getElementById('recentSearches');
            
            if (!recentDiv) return;
            
            if (recentSearches.length === 0) {
                recentDiv.innerHTML = '';
                return;
            }

            try {
                recentDiv.innerHTML = `
                    <div class="recent-title">æœ€è¿‘æœå°‹ï¼š</div>
                    <div class="recent-tags">
                        ${recentSearches.map(s => {
                            const safeAddress = s.address ? s.address.replace(/"/g, '&quot;') : '';
                            return `
                                <span class="recent-tag" onclick='fetchWeather("${s.name}", ${s.lat}, ${s.lon}, "${safeAddress}")'>
                                    ${s.name}
                                </span>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('æ›´æ–°æœ€è¿‘æœå°‹é¡¯ç¤ºéŒ¯èª¤:', error);
            }
        }

        // ğŸ”´ é˜²æ­¢ iOS ä¸ŠæŒ‰éˆ•é»æ“Šå•é¡Œ
        document.addEventListener('touchstart', function(e) {
            // ä¸åšä»»ä½•äº‹ï¼Œåªæ˜¯ç‚ºäº†å•Ÿç”¨ touch äº‹ä»¶
        }, { passive: true });
    </script>
</body>
</html>