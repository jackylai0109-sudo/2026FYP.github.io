<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TravelSync Â· åœ°åœ–ï¼‹å¤šå…ƒäº¤é€š</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --accent: #2CC5C2;
      --accent-dark: #0C344E;
      --bg: #f5fbfb;
      --card: #ffffff;
      --muted: #6b7b86;
      --radius: 14px;
    }

    body {
      font-family: 'Noto Sans', 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f2fbfb 0%, #ebf8f8 100%);
      min-height: 100vh;
      padding: 20px 20px 20px 100px;
    }

    /* ==================== å´é‚Šå°èˆª ==================== */
    .side-nav {
      position: fixed;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
      width: 80px;
      border-radius: 40px;
      box-shadow: 0 10px 30px rgba(12,52,78,0.08);
      z-index: 100;
      padding: 20px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(44, 197, 194, 0.2);
      transition: all 0.3s ease;
    }

    .side-nav:hover {
      width: 200px;
      box-shadow: 0 15px 40px rgba(44, 197, 194, 0.15);
    }

    .nav-items {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .side-nav:hover .nav-items {
      align-items: flex-start;
      padding-left: 20px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      width: 100%;
      color: var(--muted);
      text-decoration: none;
      transition: all 0.3s ease;
      border-radius: 30px;
      position: relative;
      overflow: hidden;
    }

    .side-nav:not(:hover) .nav-item {
      justify-content: center;
    }

    .nav-item:hover {
      color: var(--accent-dark);
      background: rgba(44, 197, 194, 0.1);
    }

    .nav-item.active {
      color: var(--accent-dark);
      font-weight: 600;
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 20px;
      background: var(--accent);
      border-radius: 0 4px 4px 0;
    }

    .nav-icon {
      font-size: 20px;
      min-width: 40px;
      text-align: center;
    }

    .nav-label {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s ease 0.1s;
    }

    .side-nav:hover .nav-label {
      opacity: 1;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      padding-left: 0;
    }

    .back-btn {
      padding: 10px 20px;
      background: white;
      border: 1px solid var(--accent);
      border-radius: 10px;
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    .back-btn:hover {
      background: var(--accent);
      color: white;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      height: calc(100vh - 150px);
      padding-left: 0;
    }

    .map-card {
      background: var(--card);
      border-radius: var(--radius);
      height: 100%;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(6, 30, 38, 0.06);
      display: flex;
      flex-direction: column;
    }

    .map-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      border-bottom: 1px solid #eef2f2;
      flex-wrap: wrap;
      gap: 15px;
    }

    .map-header h2 {
      color: var(--accent-dark);
      font-size: 18px;
    }

    .search-container {
      flex: 1;
      max-width: 500px;
      position: relative;
    }

    .search-box {
      display: flex;
      gap: 10px;
    }

    .search-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #e6eef0;
      border-radius: 30px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(44, 197, 194, 0.1);
    }

    .search-btn {
      padding: 12px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .search-btn:hover {
      background: #28b5b2;
      transform: translateY(-2px);
    }

    .search-btn:active {
      transform: translateY(0);
    }

    .pac-container {
      border-radius: 10px;
      margin-top: 5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: 1px solid #e6eef0;
      font-family: 'Noto Sans', 'Segoe UI', Roboto, sans-serif;
      z-index: 2000;
    }

    .pac-item {
      padding: 8px 12px;
      cursor: pointer;
      border-top: 1px solid #eef2f2;
    }

    .pac-item:hover {
      background: #f0fcfc;
    }

    .pac-matched {
      font-weight: 600;
      color: var(--accent-dark);
    }

    .map-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .map-action-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid #e6eef0;
      border-radius: 20px;
      color: var(--accent-dark);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .map-action-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .route-mode-group {
      display: flex;
      gap: 6px;
      background: #f0f7f9;
      padding: 4px;
      border-radius: 30px;
      margin-right: 5px;
    }
    .route-mode-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      border-radius: 30px;
      font-size: 13px;
      font-weight: 500;
      color: var(--accent-dark);
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .route-mode-btn.active {
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      color: var(--accent);
    }
    .route-mode-btn i { font-style: normal; font-size: 16px; }

    .map-container {
      flex: 1;
      position: relative;
      min-height: 500px;
      background-color: #f0f0f0;
    }

    #google-map {
      width: 100%;
      height: 100%;
      min-height: 500px;
      background-color: #e8eef0;
    }

    .location-button {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 10;
      transition: all 0.3s ease;
    }

    .location-button:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .location-info {
      position: fixed;
      bottom: 160px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 8px 16px;
      border-radius: 30px;
      font-size: 12px;
      color: var(--accent-dark);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 2001;
      display: none;
    }

    .location-loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 2000;
      display: none;
      text-align: center;
    }

    .location-loading .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .info-window {
      padding: 10px;
      max-width: 200px;
    }

    .info-window-title {
      font-weight: 700;
      color: var(--accent-dark);
      margin-bottom: 5px;
      font-size: 14px;
    }

    .info-window-address {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .route-summary {
      position: absolute;
      bottom: 90px;
      left: 20px;
      background: white;
      border-radius: 30px;
      padding: 15px 22px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.2);
      z-index: 20;
      max-width: 340px;
      font-size: 13px;
      border-left: 5px solid var(--accent);
      display: none;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.98);
    }
    .route-summary.show { display: block; }
    .route-summary .close-route {
      float: right;
      cursor: pointer;
      font-weight: bold;
      margin-left: 10px;
      color: #aaa;
      font-size: 18px;
    }
    .route-summary .close-route:hover { color: #333; }
    .route-summary strong { color: var(--accent-dark); }
    .route-summary .transit-details {
      margin-top: 8px;
      border-top: 1px dashed #ccc;
      padding-top: 8px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 12px;
    }
    .route-summary .transit-step {
      display: flex;
      gap: 6px;
      margin: 5px 0;
      align-items: center;
      flex-wrap: wrap;
    }

    .map-error {
      padding: 40px;
      text-align: center;
      background: white;
      border-radius: 10px;
      margin: 20px;
    }
    .map-error h3 {
      color: #d32f2f;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      body {
        padding-left: 80px;
      }
      
      .side-nav {
        left: 10px;
        width: 60px;
      }
      
      .side-nav:hover {
        width: 160px;
      }
      
      .map-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-container {
        max-width: 100%;
      }
      
      .map-actions {
        justify-content: flex-start;
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <!-- å´é‚Šå°èˆª -->
  <div class="side-nav">
    <div class="nav-items">
      <a href="index.html" class="nav-item">
        <span class="nav-icon">ğŸ </span>
        <span class="nav-label">ä¸»é </span>
      </a>
      <a href="map.html" class="nav-item active">
        <span class="nav-icon">ğŸ—ºï¸</span>
        <span class="nav-label">åœ°åœ–</span>
      </a>
      <a href="groups.html" class="nav-item">
        <span class="nav-icon">ğŸ‘¥</span>
        <span class="nav-label">ç¾¤çµ„</span>
      </a>
      <a href="ChatMessage.html" class="nav-item">
        <span class="nav-icon">ğŸ’¬</span>
        <span class="nav-label">èŠå¤©</span>
      </a>
      <a href="profile.html" class="nav-item">
        <span class="nav-icon">ğŸ‘¤</span>
        <span class="nav-label">å¸³è™Ÿ</span>
      </a>
    </div>
  </div>

  <div class="header">
    <a href="index.html" class="back-btn">â† è¿”å›ä¸»é </a>
    <h1>åœ°åœ– Â· å¤šå…ƒäº¤é€š</h1>
  </div>

  <!-- åœ°ç†ä½ç½®è¼‰å…¥æç¤º -->
  <div class="location-loading" id="locationLoading">
    <div class="spinner"></div>
    <p>æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...</p>
    <p style="font-size: 12px; color: var(--muted); margin-top: 10px;">è«‹å…è¨±ç€è¦½å™¨å­˜å–ä½ç½®</p>
  </div>

  <!-- ä½ç½®è³‡è¨Šé¡¯ç¤º -->
  <div class="location-info" id="locationInfo"></div>

  <div class="container">
    <div class="map-card">
      <div class="map-header">
        <h2>ğŸ—ºï¸ å³æ™‚åœ°åœ–</h2>
        
        <!-- æœå°‹åˆ— -->
        <div class="search-container">
          <div class="search-box">
            <input type="text" 
                   class="search-input" 
                   id="searchInput" 
                   placeholder="æœå°‹åœ°é»ã€åœ°å€æˆ–åœ°æ¨™..."
                   autocomplete="off">
            <button class="search-btn" onclick="searchPlace()">æœå°‹</button>
          </div>
        </div>

        <div class="map-actions">
          <!-- äº¤é€šæ¨¡å¼åˆ‡æ› - é»æ“Šè‡ªå‹•é‡æ–°è¦åŠƒ -->
          <div class="route-mode-group" id="routeModeGroup">
            <button class="route-mode-btn active" data-mode="DRIVING" onclick="setTravelMode('DRIVING')"><i>ğŸš—</i> é–‹è»Š</button>
            <button class="route-mode-btn" data-mode="TRANSIT" onclick="setTravelMode('TRANSIT')"><i>ğŸš†</i> å¤§çœ¾é‹è¼¸</button>
            <button class="route-mode-btn" data-mode="WALKING" onclick="setTravelMode('WALKING')"><i>ğŸš¶</i> æ­¥è¡Œ</button>
            <button class="route-mode-btn" data-mode="BICYCLING" onclick="setTravelMode('BICYCLING')"><i>ğŸš²</i> å–®è»Š</button>
          </div>
          <button class="map-action-btn" onclick="window.location.href='meeting.html'">ğŸ¯ å»ºç«‹æœƒåˆé»</button>
          <button class="map-action-btn" onclick="window.location.href='weather.html'">â˜€ï¸ å¤©æ°£æŸ¥è©¢</button>
        </div>
      </div>
      <div class="map-container">
        <div id="google-map"></div>
        <!-- ç›®å‰ä½ç½®æŒ‰éˆ• -->
        <button class="location-button" onclick="getCurrentLocationAndCenter()" title="é¡¯ç¤ºæˆ‘çš„ä½ç½®">
          <span>ğŸ“</span>
        </button>
        <!-- è·¯ç·šæ‘˜è¦å¡ç‰‡ -->
        <div class="route-summary" id="routeSummary">
          <span class="close-route" onclick="closeRoutePanel()">âœ•</span>
          <div id="routeSummaryContent"></div>
          <div id="transitDetailed" class="transit-details"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Maps API ç›´æ¥è¼‰å…¥ -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXCOcFaB80u9FjnEkQf-DlMOPqAJyGngA&libraries=places,geometry&callback=initMap&v=weekly" async defer></script>

  <script>
    // ==================== Firebase åˆå§‹åŒ– ====================
    const firebaseConfig = {
      apiKey: "AIzaSyBhvbTPl-hGv1MWtrua55LuvIUpdabqy4M",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "project-221c4",
      storageBucket: "project-221c4.firebasestorage.app",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ==================== åœ°åœ–è®Šæ•¸ ====================
    let map;
    let geocoder;
    let placesService;
    let autocomplete;
    let searchMarker;
    let currentLocationMarker;
    let userLocationCircle;
    let meetingLocationMarker;
    let meetingInfoWindow;
    let directionsService;
    let directionsRenderer;
    let currentDestinationPosition = null;
    let lastOriginPosition = null;
    let currentTravelMode = 'DRIVING';
    let isMapInitialized = false;

    // ==================== Google åœ°åœ–åˆå§‹åŒ– ====================
    window.initMap = function() {
      console.log('initMap é–‹å§‹åŸ·è¡Œ');
      
      const mapElement = document.getElementById("google-map");
      if (!mapElement) {
        console.error("æ‰¾ä¸åˆ°åœ°åœ–å®¹å™¨");
        return;
      }

      try {
        // å»ºç«‹åœ°åœ–
        map = new google.maps.Map(mapElement, {
          center: { lat: 25.0330, lng: 121.5654 }, // å°åŒ—
          zoom: 12,
          mapTypeControl: true,
          fullscreenControl: true,
          streetViewControl: true,
          zoomControl: true,
        });

        console.log("åœ°åœ–å»ºç«‹æˆåŠŸ");

        // åˆå§‹åŒ–æœå‹™
        geocoder = new google.maps.Geocoder();
        placesService = new google.maps.places.PlacesService(map);
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          map: map,
          suppressMarkers: false,
          preserveViewport: false,
          polylineOptions: {
            strokeColor: "#2CC5C2",
            strokeWeight: 5,
            strokeOpacity: 0.8
          }
        });

        // åˆå§‹åŒ–è‡ªå‹•å®Œæˆ
        initAutocomplete();
        
        isMapInitialized = true;
        console.log("æ‰€æœ‰æœå‹™åˆå§‹åŒ–å®Œæˆ");
        
        // æª¢æŸ¥æœƒåˆé»
        showMeetingLocationFromStorage();
        
      } catch (error) {
        console.error("åœ°åœ–åˆå§‹åŒ–éŒ¯èª¤:", error);
        mapElement.innerHTML = `<div class="map-error">
          <h3>åœ°åœ–è¼‰å…¥å¤±æ•—</h3>
          <p>${error.message}</p>
          <p>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢</p>
        </div>`;
      }
    };

    // ==================== åˆå§‹åŒ– Google Places è‡ªå‹•å®Œæˆ ====================
    function initAutocomplete() {
      const input = document.getElementById('searchInput');
      if (!input) return;
      
      autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['establishment', 'geocode'],
        fields: ['place_id', 'name', 'formatted_address', 'geometry']
      });

      autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        if (place && place.geometry) {
          handlePlaceSelected(place);
        }
      });
    }

    // ==================== è™•ç†é¸æ“‡çš„åœ°é» ====================
    function handlePlaceSelected(place) {
      if (!map) {
        alert('åœ°åœ–å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦');
        return;
      }
      
      const position = place.geometry.location;
      
      currentDestinationPosition = {
        lat: position.lat(),
        lng: position.lng()
      };
      
      map.setCenter(position);
      map.setZoom(17);
      
      if (searchMarker) {
        searchMarker.setMap(null);
      }
      
      searchMarker = new google.maps.Marker({
        map: map,
        position: position,
        title: place.name,
        animation: google.maps.Animation.DROP
      });
      
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div class="info-window">
            <div class="info-window-title">${place.name}</div>
            <div class="info-window-address">${place.formatted_address || ''}</div>
            <small style="color:var(--accent);">âœ… é¸æ“‡äº¤é€šæ¨¡å¼è‡ªå‹•è¦åŠƒè·¯ç·š</small>
          </div>
        `
      });
      
      infoWindow.open(map, searchMarker);

      // æ¸…é™¤èˆŠè·¯ç·š
      if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
      document.getElementById('routeSummary').classList.remove('show');
      
      // å¦‚æœæœ‰èµ·é»ï¼Œè‡ªå‹•è¦åŠƒè·¯ç·š
      if (lastOriginPosition) {
        autoPlanRoute();
      }
    }

    // ==================== æœå°‹åœ°é» ====================
    window.searchPlace = function() {
      if (!map || !placesService) {
        alert('åœ°åœ–å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦');
        return;
      }
      
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;

      const request = {
        query: query,
        fields: ['name', 'geometry', 'formatted_address']
      };

      placesService.findPlaceFromQuery(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
          const place = results[0];
          const position = place.geometry.location;
          
          currentDestinationPosition = {
            lat: position.lat(),
            lng: position.lng()
          };
          
          map.setCenter(position);
          map.setZoom(17);
          
          if (searchMarker) searchMarker.setMap(null);
          
          searchMarker = new google.maps.Marker({
            map: map,
            position: position,
            title: place.name,
            animation: google.maps.Animation.DROP
          });
          
          const infoWindow = new google.maps.InfoWindow({
            content: `
              <div class="info-window">
                <div class="info-window-title">${place.name}</div>
                <div class="info-window-address">${place.formatted_address || ''}</div>
                <small style="color:var(--accent);">âœ… é¸æ“‡äº¤é€šæ¨¡å¼è‡ªå‹•è¦åŠƒè·¯ç·š</small>
              </div>
            `
          });
          infoWindow.open(map, searchMarker);
          
          if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
          document.getElementById('routeSummary').classList.remove('show');
          
          // å¦‚æœæœ‰èµ·é»ï¼Œè‡ªå‹•è¦åŠƒè·¯ç·š
          if (lastOriginPosition) {
            autoPlanRoute();
          }
        } else {
          alert('æ‰¾ä¸åˆ°è©²åœ°é»ï¼Œè«‹å˜—è©¦å…¶ä»–é—œéµå­—');
        }
      });
    };

    // ==================== è‡ªå‹•è¦åŠƒè·¯ç·š ====================
    function autoPlanRoute() {
      if (lastOriginPosition && currentDestinationPosition) {
        calculateAndDisplayRoute(lastOriginPosition, currentDestinationPosition, currentTravelMode);
      }
    }

    // ==================== è¨­å®šäº¤é€šæ¨¡å¼ (è‡ªå‹•é‡æ–°è¦åŠƒ) ====================
    window.setTravelMode = function(mode) {
      // æ›´æ–°æŒ‰éˆ•æ¨£å¼
      document.querySelectorAll('.route-mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.route-mode-btn[data-mode="${mode}"]`).classList.add('active');
      
      // æ›´æ–°ç•¶å‰æ¨¡å¼
      currentTravelMode = mode;
      
      // è‡ªå‹•é‡æ–°è¦åŠƒè·¯ç·š
      if (lastOriginPosition && currentDestinationPosition) {
        calculateAndDisplayRoute(lastOriginPosition, currentDestinationPosition, mode);
      } else if (!lastOriginPosition) {
        // å¦‚æœæ²’æœ‰èµ·é»ï¼Œæç¤ºä½¿ç”¨è€…
        const infoWindow = new google.maps.InfoWindow({
          content: '<div style="padding:8px;">ğŸ“ è«‹å…ˆé»æ“Šå·¦ä¸‹è§’æŒ‰éˆ•ç²å–æ‚¨çš„ä½ç½®</div>'
        });
        infoWindow.setPosition(map.getCenter());
        infoWindow.open(map);
      } else if (!currentDestinationPosition) {
        // å¦‚æœæ²’æœ‰çµ‚é»ï¼Œæç¤ºä½¿ç”¨è€…
        const infoWindow = new google.maps.InfoWindow({
          content: '<div style="padding:8px;">ğŸ” è«‹å…ˆæœå°‹ç›®çš„åœ°</div>'
        });
        infoWindow.setPosition(map.getCenter());
        infoWindow.open(map);
      }
    };

    // å°‡æ¨¡å¼è½‰æ›ç‚º Google çš„ TravelMode
    function getGoogleTravelMode(mode) {
      switch(mode) {
        case 'DRIVING': return google.maps.TravelMode.DRIVING;
        case 'TRANSIT': return google.maps.TravelMode.TRANSIT;
        case 'WALKING': return google.maps.TravelMode.WALKING;
        case 'BICYCLING': return google.maps.TravelMode.BICYCLING;
        default: return google.maps.TravelMode.DRIVING;
      }
    }

    // è¨ˆç®—ä¸¦é¡¯ç¤ºè·¯ç·š
    function calculateAndDisplayRoute(origin, destination, mode) {
      if (!directionsService || !directionsRenderer) return;

      const travelMode = getGoogleTravelMode(mode);

      const request = {
        origin: origin,
        destination: destination,
        travelMode: travelMode,
        unitSystem: google.maps.UnitSystem.METRIC
      };

      // å¤§çœ¾é‹è¼¸é¸é …
      if (mode === 'TRANSIT') {
        request.transitOptions = {
          modes: [google.maps.TransitMode.BUS, google.maps.TransitMode.RAIL],
          routingPreference: google.maps.TransitRoutePreference.FEWER_TRANSFERS
        };
      }

      directionsService.route(request, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
          directionsRenderer.setDirections(result);
          
          const route = result.routes[0];
          if (route && route.legs.length > 0) {
            const leg = route.legs[0];
            const distance = leg.distance.text;
            const duration = leg.duration.text;
            
            let modeIcon = 'ğŸš—';
            if (mode === 'TRANSIT') modeIcon = 'ğŸš†';
            else if (mode === 'WALKING') modeIcon = 'ğŸš¶';
            else if (mode === 'BICYCLING') modeIcon = 'ğŸš²';
            
            let summaryHtml = `
              <strong>${modeIcon} æœ€ä½³è·¯ç·š (${getModeName(mode)})</strong><br>
              <span>è·é›¢: ${distance} | æ™‚é–“: ${duration}</span><br>
              <small>èµ·é»: ${leg.start_address.split(',')[0]}</small><br>
              <small>çµ‚é»: ${leg.end_address.split(',')[0]}</small>
            `;
            document.getElementById('routeSummaryContent').innerHTML = summaryHtml;

            // é¡¯ç¤ºå¤§çœ¾é‹è¼¸è©³ç´°è³‡è¨Š
            if (mode === 'TRANSIT' && leg.steps) {
              let transitStepsHtml = '<hr style="margin:8px 0"><strong>ğŸš‰ è½‰ä¹˜è³‡è¨Š</strong>';
              leg.steps.forEach((step) => {
                if (step.travel_mode === 'TRANSIT' && step.transit) {
                  const line = step.transit.line;
                  const vehicle = line.vehicle;
                  const icon = vehicle && vehicle.type === 'BUS' ? 'ğŸšŒ' : 'ğŸš†';
                  const departureStop = step.transit.departure_stop.name;
                  const arrivalStop = step.transit.arrival_stop.name;
                  transitStepsHtml += `
                    <div class="transit-step">
                      <span>${icon} ${line.short_name || line.name || ''}</span>
                      <span>${departureStop} â†’ ${arrivalStop}</span>
                      <small>(${step.duration.text})</small>
                    </div>
                  `;
                } else if (step.travel_mode === 'WALKING') {
                  transitStepsHtml += `<div class="transit-step"><span>ğŸš¶ æ­¥è¡Œ ${step.distance.text} (${step.duration.text})</span></div>`;
                }
              });
              document.getElementById('transitDetailed').innerHTML = transitStepsHtml;
            } else {
              document.getElementById('transitDetailed').innerHTML = '';
            }

            document.getElementById('routeSummary').classList.add('show');
          }
        } else {
          console.log('è·¯ç·šè¦åŠƒå¤±æ•—:', status);
        }
      });
    }

    function getModeName(mode) {
      switch(mode) {
        case 'DRIVING': return 'é–‹è»Š';
        case 'TRANSIT': return 'å¤§çœ¾é‹è¼¸';
        case 'WALKING': return 'æ­¥è¡Œ';
        case 'BICYCLING': return 'å–®è»Š';
        default: return 'æœªçŸ¥';
      }
    }

    window.closeRoutePanel = function() {
      document.getElementById('routeSummary').classList.remove('show');
      if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
    };

    // ==================== ç²å–ç›®å‰ä½ç½® ====================
    window.getCurrentLocationAndCenter = function() {
      if (!map) {
        alert('åœ°åœ–å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦');
        return;
      }
      
      if (!navigator.geolocation) {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½');
        return;
      }

      const loadingEl = document.getElementById('locationLoading');
      const locationInfo = document.getElementById('locationInfo');
      
      if (loadingEl) loadingEl.style.display = 'block';

      navigator.geolocation.getCurrentPosition(
        function(position) {
          const currentPos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          const accuracy = position.coords.accuracy;
          
          lastOriginPosition = currentPos;
          
          map.setCenter(currentPos);
          map.setZoom(17);
          
          if (currentLocationMarker) currentLocationMarker.setMap(null);
          if (userLocationCircle) userLocationCircle.setMap(null);
          
          currentLocationMarker = new google.maps.Marker({
            map: map,
            position: currentPos,
            title: 'æ‚¨çš„ä½ç½®',
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 10,
              fillColor: '#4285F4',
              fillOpacity: 1,
              strokeColor: 'white',
              strokeWeight: 3
            }
          });
          
          userLocationCircle = new google.maps.Circle({
            map: map,
            center: currentPos,
            radius: accuracy,
            fillColor: '#4285F4',
            fillOpacity: 0.1,
            strokeColor: '#4285F4',
            strokeOpacity: 0.5,
            strokeWeight: 1
          });
          
          if (locationInfo) {
            locationInfo.textContent = `ğŸ“ æ‚¨çš„ä½ç½® - ç²¾ç¢ºåº¦ï¼šç´„ ${Math.round(accuracy)} å…¬å°º`;
            locationInfo.style.display = 'block';
            setTimeout(() => locationInfo.style.display = 'none', 5000);
          }
          
          if (loadingEl) loadingEl.style.display = 'none';

          // å–å¾—ä½ç½®å¾Œè‡ªå‹•è¦åŠƒè·¯ç·šï¼ˆå¦‚æœæœ‰ç›®çš„åœ°ï¼‰
          if (currentDestinationPosition) {
            calculateAndDisplayRoute(currentPos, currentDestinationPosition, currentTravelMode);
          } else {
            // æç¤ºå¯ä»¥æœå°‹ç›®çš„åœ°
            const infoWindow = new google.maps.InfoWindow({
              content: '<div style="padding:8px;">ğŸ” ç¾åœ¨å¯ä»¥æœå°‹ç›®çš„åœ°ï¼Œè·¯ç·šæœƒè‡ªå‹•è¦åŠƒ</div>'
            });
            infoWindow.setPosition(currentPos);
            infoWindow.open(map);
          }
        },
        
        function(error) {
          console.error('åœ°ç†ä½ç½®éŒ¯èª¤:', error);
          if (loadingEl) loadingEl.style.display = 'none';
          
          let errorMessage = 'ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®ï¼š';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += 'æ‚¨æ‹’çµ•äº†ä½ç½®å­˜å–æ¬Šé™ã€‚';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += 'ä½ç½®è³‡è¨Šä¸å¯ç”¨ã€‚';
              break;
            case error.TIMEOUT:
              errorMessage += 'æ“·å–ä½ç½®è¶…æ™‚ã€‚';
              break;
            default:
              errorMessage += 'æœªçŸ¥éŒ¯èª¤ã€‚';
          }
          alert(errorMessage);
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    };

    // ==================== é¡¯ç¤ºæœƒåˆé» ====================
    function showMeetingLocationFromStorage() {
      try {
        const savedLocation = localStorage.getItem('meetingLocation');
        if (savedLocation && map) {
          const locationData = JSON.parse(savedLocation);
          const now = new Date().getTime();
          
          if (now - locationData.timestamp < 5 * 60 * 1000) {
            const position = {
              lat: locationData.lat,
              lng: locationData.lng
            };
            
            map.setCenter(position);
            map.setZoom(17);
            
            if (meetingLocationMarker) meetingLocationMarker.setMap(null);
            
            meetingLocationMarker = new google.maps.Marker({
              map: map,
              position: position,
              title: 'æœƒåˆé»',
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 12,
                fillColor: '#FF4444',
                fillOpacity: 1,
                strokeColor: 'white',
                strokeWeight: 3
              }
            });
            
            if (meetingInfoWindow) meetingInfoWindow.close();
            
            meetingInfoWindow = new google.maps.InfoWindow({
              content: `
                <div class="meeting-info-window">
                  <div class="meeting-info-title">ğŸ¯ æœƒåˆé»</div>
                  <div class="meeting-info-address">ğŸ“ ${locationData.address || 'æœªçŸ¥åœ°å€'}</div>
                </div>
              `
            });
            
            setTimeout(() => meetingInfoWindow.open(map, meetingLocationMarker), 500);
            localStorage.removeItem('meetingLocation');
          } else {
            localStorage.removeItem('meetingLocation');
          }
        }
      } catch (error) {
        console.error('è®€å–æœƒåˆé»è³‡æ–™éŒ¯èª¤:', error);
        localStorage.removeItem('meetingLocation');
      }
    }

    // ==================== æª¢æŸ¥ç™»å…¥ç‹€æ…‹ ====================
    auth.onAuthStateChanged(user => {
      if (!user) {
        console.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œåœ°åœ–ä»¥è¨ªå®¢æ¨¡å¼é¡¯ç¤º');
      }
    });
  </script>
</body>
</html>