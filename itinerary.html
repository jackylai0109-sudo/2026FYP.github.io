<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>TravelSync Â· è¡Œç¨‹è¦åŠƒ (åœ°åœ–æª¢è¦–)</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXCOcFaB80u9FjnEkQf-DlMOPqAJyGngA&libraries=places"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --accent: #2CC5C2;
            --accent-dark: #0C344E;
            --bg: #f5fbfb;
            --card: #ffffff;
            --muted: #6b7b86;
            --radius: 14px;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            font-family: 'Noto Sans', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f2fbfb 0%, #ebf8f8 100%);
            min-height: 100vh;
            padding: 20px 20px 20px 100px;
            touch-action: pan-y pinch-zoom;
            transition: padding 0.3s ease;
        }

        /* ==================== å´é‚Šå°èˆª ==================== */
        .side-nav {
            position: fixed;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
            width: 60px;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(12,52,78,0.08);
            z-index: 1000;
            padding: 15px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(44, 197, 194, 0.2);
            transition: all 0.3s ease;
        }

        .side-nav:hover {
            width: 160px;
            box-shadow: 0 15px 40px rgba(44, 197, 194, 0.15);
        }

        .nav-items {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .side-nav:hover .nav-items {
            align-items: flex-start;
            padding-left: 15px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            width: 100%;
            color: var(--muted);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 30px;
            position: relative;
            overflow: hidden;
        }

        .side-nav:not(:hover) .nav-item {
            justify-content: center;
        }

        .nav-item:hover {
            color: var(--accent-dark);
            background: rgba(44, 197, 194, 0.1);
        }

        .nav-item.active {
            color: var(--accent-dark);
            font-weight: 600;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 18px;
            background: var(--accent);
            border-radius: 0 3px 3px 0;
        }

        .nav-icon {
            font-size: 18px;
            min-width: 30px;
            text-align: center;
        }

        .nav-label {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s ease 0.1s;
        }

        .side-nav:hover .nav-label {
            opacity: 1;
        }

        /* ==================== åº•éƒ¨å°èˆª ==================== */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(44, 197, 194, 0.2);
            box-shadow: 0 -5px 20px rgba(12,52,78,0.08);
            z-index: 1000;
            padding: 8px 0 calc(8px + var(--safe-area-bottom));
            justify-content: space-around;
            align-items: center;
            border-radius: 20px 20px 0 0;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            color: var(--muted);
            text-decoration: none;
            font-size: 11px;
            transition: all 0.3s ease;
            padding: 5px 0;
            flex: 1;
        }

        .bottom-nav-item:hover {
            color: var(--accent-dark);
            background: rgba(44, 197, 194, 0.1);
        }

        .bottom-nav-item.active {
            color: var(--accent);
            font-weight: 600;
        }

        .bottom-nav-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .bottom-nav-label {
            font-size: 10px;
            font-weight: 500;
        }

        /* é é¢æ¨™é ­ + ç¾¤çµ„é¸æ“‡å™¨ */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .page-header h1 {
            font-size: 1.8rem;
            font-weight: 500;
            color: var(--accent-dark);
            border-left: 6px solid var(--accent);
            padding-left: 1rem;
        }
        .group-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 8px 18px;
            border-radius: 40px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
            border: 1px solid rgba(44,197,194,0.2);
        }
        .group-selector label {
            font-weight: 600;
            color: var(--accent-dark);
        }
        .group-selector select {
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid #d0e4e8;
            background: white;
            font-size: 1rem;
            min-width: 180px;
            cursor: pointer;
        }
        .add-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(44,197,194,0.3);
        }
        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(44,197,194,0.4);
        }

        /* è¡Œç¨‹åˆ—è¡¨ */
        .trip-list {
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .date-group {
            background: rgba(255,255,255,0.5);
            backdrop-filter: blur(4px);
            padding: 12px 18px;
            border-radius: 50px;
            font-weight: 600;
            color: var(--accent-dark);
            margin-bottom: 10px;
            display: inline-block;
            border: 1px solid rgba(44,197,194,0.2);
        }

        .trip-card {
            background: var(--card);
            border-radius: 18px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(6, 30, 38, 0.04);
            border: 1px solid rgba(230,238,240,0.8);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .trip-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }
        .trip-info {
            flex: 1;
        }
        .trip-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-dark);
            margin-bottom: 6px;
        }
        .trip-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.9rem;
            color: var(--muted);
            flex-wrap: wrap;
        }
        .trip-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .trip-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .icon-btn {
            background: transparent;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--muted);
        }
        .icon-btn:hover {
            background: #f0f4f4;
            color: var(--accent-dark);
            transform: scale(1.1);
        }
        .icon-btn.map-btn {
            color: #4CAF50;
        }
        .icon-btn.map-btn:hover {
            background: #e8f5e9;
            color: #2E7D32;
        }
        .icon-btn.edit:hover {
            background: #fff3e0;
            color: #F57C00;
        }
        .icon-btn.delete:hover {
            background: #ffe5e5;
            color: #d32f2f;
        }

        /* æ–°å¢/ç·¨è¼¯æµ®å±¤ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(6px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-card {
            background: white;
            border-radius: 28px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }
        .modal-card h2 {
            color: var(--accent-dark);
            margin-bottom: 20px;
            font-size: 1.6rem;
        }
        .form-group {
            margin-bottom: 16px;
            position: relative;
        }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            color: var(--muted);
            margin-bottom: 4px;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0ecf0;
            border-radius: 14px;
            font-size: 1rem;
            transition: border 0.2s;
            background: white;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        .pac-container {
            border-radius: 12px;
            margin-top: 5px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border: 1px solid #e0ecf0;
            font-family: 'Noto Sans', sans-serif;
            z-index: 10000;
        }
        .pac-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            border-top: 1px solid #eef2f2;
        }
        .pac-item:hover {
            background: #f0fcfc;
        }
        .location-hint {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .location-hint .coord {
            font-family: monospace;
            background: #f0f4f4;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .form-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .form-row .form-group {
            flex: 1 1 120px;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        .modal-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        .btn-primary:hover {
            background: #28b5b2;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #eef4f4;
            color: var(--accent-dark);
        }
        .btn-secondary:hover {
            background: #e0eaea;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--card);
            border-radius: var(--radius);
            color: var(--muted);
        }
        .empty-state .icon {
            font-size: 50px;
            margin-bottom: 16px;
        }

        /* è¼‰å…¥ä¸­ */
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æç¤ºè¨Šæ¯ */
        .toast-message {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-dark);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            z-index: 3000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            body {
                padding: 15px 15px 70px 15px;
            }
            .side-nav { display: none; }
            .bottom-nav { display: flex; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .group-selector { width: 100%; justify-content: space-between; }
            .trip-card { flex-direction: column; align-items: flex-start; }
            .trip-actions { margin-top: 12px; align-self: flex-end; }
        }
    </style>
</head>
<body>
    <!-- å´é‚Šå°èˆª -->
    <div class="side-nav">
        <div class="nav-items">
            <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ </span><span class="nav-label">ä¸»é </span></a>
            <a href="map.html" class="nav-item"><span class="nav-icon">ğŸ—ºï¸</span><span class="nav-label">åœ°åœ–</span></a>
            <a href="itinerary.html" class="nav-item active"><span class="nav-icon">ğŸ“…</span><span class="nav-label">è¡Œç¨‹</span></a>
            <a href="groups.html" class="nav-item"><span class="nav-icon">ğŸ‘¥</span><span class="nav-label">ç¾¤çµ„</span></a>
            <a href="ChatMessage.html" class="nav-item"><span class="nav-icon">ğŸ’¬</span><span class="nav-label">èŠå¤©</span></a>
            <a href="profile.html" class="nav-item"><span class="nav-icon">ğŸ‘¤</span><span class="nav-label">å¸³è™Ÿ</span></a>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <div class="bottom-nav">
        <a href="index.html" class="bottom-nav-item"><span class="bottom-nav-icon">ğŸ </span><span class="bottom-nav-label">ä¸»é </span></a>
        <a href="map.html" class="bottom-nav-item"><span class="bottom-nav-icon">ğŸ—ºï¸</span><span class="bottom-nav-label">åœ°åœ–</span></a>
        <a href="itinerary.html" class="bottom-nav-item active"><span class="bottom-nav-icon">ğŸ“…</span><span class="bottom-nav-label">è¡Œç¨‹</span></a>
        <a href="groups.html" class="bottom-nav-item"><span class="bottom-nav-icon">ğŸ‘¥</span><span class="bottom-nav-label">ç¾¤çµ„</span></a>
        <a href="ChatMessage.html" class="bottom-nav-item"><span class="bottom-nav-icon">ğŸ’¬</span><span class="bottom-nav-label">èŠå¤©</span></a>
        <a href="profile.html" class="bottom-nav-item"><span class="bottom-nav-icon">ğŸ‘¤</span><span class="bottom-nav-label">å¸³è™Ÿ</span></a>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div style="max-width: 1000px; margin: 0 auto;">
        <div class="page-header">
            <h1>ğŸ“… ç¾¤çµ„è¡Œç¨‹</h1>
            <div class="group-selector">
                <label for="groupSelect">ğŸ‘¥ ç›®å‰ç¾¤çµ„ï¼š</label>
                <select id="groupSelect"></select>
            </div>
            <button class="add-btn" id="openAddModalBtn">â• æ–°å¢è¡Œç¨‹</button>
        </div>

        <div id="loadingIndicator" class="loading"><div class="spinner"></div><p>è¼‰å…¥è¡Œç¨‹ä¸­...</p></div>
        <div id="tripListContainer" class="trip-list" style="display: none;"></div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="icon">ğŸ—“ï¸</div>
            <h3>é€™å€‹ç¾¤çµ„é‚„æ²’æœ‰è¡Œç¨‹</h3>
            <p>é»æ“Šã€Œæ–°å¢è¡Œç¨‹ã€é–‹å§‹è¦åŠƒæ—…ç¨‹å§ï¼</p>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯è¡Œç¨‹æµ®å±¤ -->
    <div class="modal-overlay" id="tripModal">
        <div class="modal-card">
            <h2 id="modalTitle">æ–°å¢è¡Œç¨‹</h2>
            <form id="tripForm">
                <div class="form-group">
                    <label>è¡Œç¨‹æ¨™é¡Œ *</label>
                    <input type="text" id="tripTitle" placeholder="ä¾‹å¦‚ï¼šè‰¾è²çˆ¾éµå¡”åƒè§€" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="tripDate" required>
                    </div>
                    <div class="form-group">
                        <label>æ™‚é–“ (é¸å¡«)</label>
                        <input type="time" id="tripTime">
                    </div>
                </div>
                <div class="form-group">
                    <label>åœ°é» (å¯æœå°‹)</label>
                    <input type="text" id="tripLocation" placeholder="è¼¸å…¥é—œéµå­—æœå°‹åœ°é»..." autocomplete="off">
                    <div class="location-hint" id="locationHint">
                        <span>ğŸ“ é¸æ“‡åœ°é»å¾Œæœƒè‡ªå‹•è¨˜éŒ„åº§æ¨™</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="tripNotes" rows="3" placeholder="ä»»ä½•æƒ³è¨˜éŒ„çš„ç´°ç¯€..."></textarea>
                </div>
                <input type="hidden" id="editingId" value="">
                <input type="hidden" id="editingLat" value="">
                <input type="hidden" id="editingLng" value="">
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="cancelModalBtn">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary" id="saveTripBtn">å„²å­˜è¡Œç¨‹</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBhvbTPl-hGv1MWtrua55LuvIUpdabqy4M",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "project-221c4",
            storageBucket: "project-221c4.firebasestorage.app",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM å…ƒç´ 
        const loadingEl = document.getElementById('loadingIndicator');
        const tripListContainer = document.getElementById('tripListContainer');
        const emptyState = document.getElementById('emptyState');
        const modal = document.getElementById('tripModal');
        const modalTitle = document.getElementById('modalTitle');
        const tripForm = document.getElementById('tripForm');
        const tripTitle = document.getElementById('tripTitle');
        const tripDate = document.getElementById('tripDate');
        const tripTime = document.getElementById('tripTime');
        const tripLocation = document.getElementById('tripLocation');
        const tripNotes = document.getElementById('tripNotes');
        const editingId = document.getElementById('editingId');
        const editingLat = document.getElementById('editingLat');
        const editingLng = document.getElementById('editingLng');
        const locationHint = document.getElementById('locationHint');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const openAddModalBtn = document.getElementById('openAddModalBtn');
        const groupSelect = document.getElementById('groupSelect');

        let currentUser = null;
        let userGroups = [];
        let currentGroupId = null;
        let autocomplete = null;

        // ========== åˆå§‹åŒ–åœ°é»è‡ªå‹•å®Œæˆ ==========
        function initAutocomplete() {
            const input = document.getElementById('tripLocation');
            if (!input) return;

            if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                console.log('Google Maps API å°šæœªè¼‰å…¥å®Œæˆï¼Œç¨å¾Œå†è©¦');
                setTimeout(initAutocomplete, 500);
                return;
            }

            try {
                if (autocomplete) {
                    google.maps.event.clearInstanceListeners(autocomplete);
                }

                autocomplete = new google.maps.places.Autocomplete(input, {
                    types: ['establishment', 'geocode'],
                    fields: ['place_id', 'name', 'formatted_address', 'geometry']
                });

                autocomplete.addListener('place_changed', function() {
                    const place = autocomplete.getPlace();
                    
                    if (!place.geometry) {
                        editingLat.value = '';
                        editingLng.value = '';
                        locationHint.innerHTML = 'âš ï¸ è«‹å¾ä¸‹æ‹‰æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹åœ°é»';
                        return;
                    }

                    const lat = place.geometry.location.lat();
                    const lng = place.geometry.location.lng();
                    editingLat.value = lat;
                    editingLng.value = lng;

                    locationHint.innerHTML = `
                        <span>ğŸ“ ${place.formatted_address || place.name}</span>
                        <span class="coord">${lat.toFixed(6)}, ${lng.toFixed(6)}</span>
                    `;
                });

                console.log('åœ°é»è‡ªå‹•å®Œæˆåˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('åˆå§‹åŒ–è‡ªå‹•å®ŒæˆéŒ¯èª¤:', error);
            }
        }

        // ========== ç›£è½ç™»å…¥ ==========
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserGroups();
                setupGroupSelector();
                
                setTimeout(() => {
                    initAutocomplete();
                }, 1000);
            } else {
                window.location.href = 'loginPage.html';
            }
        });

        // ========== è¼‰å…¥ä½¿ç”¨è€…ç¾¤çµ„ ==========
        async function loadUserGroups() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (!userDoc.exists) return;

                const groupsObj = userDoc.data().groups || {};
                userGroups = Object.values(groupsObj).map(g => ({
                    id: g.groupId,
                    name: g.groupName || 'æœªå‘½åç¾¤çµ„'
                }));

                if (userGroups.length === 0) {
                    alert('æ‚¨å°šæœªåŠ å…¥ä»»ä½•ç¾¤çµ„');
                    window.location.href = 'createJoin.html';
                    return;
                }

                currentGroupId = userDoc.data().currentGroupId || userGroups[0].id;

            } catch (error) {
                console.error('è¼‰å…¥ç¾¤çµ„éŒ¯èª¤:', error);
                showToast('ç„¡æ³•è¼‰å…¥ç¾¤çµ„è³‡è¨Š');
            }
        }

        // ========== è¨­å®šä¸‹æ‹‰é¸å–® ==========
        function setupGroupSelector() {
            let options = '';
            userGroups.forEach(g => {
                options += `<option value="${g.id}" ${g.id === currentGroupId ? 'selected' : ''}>${escapeHtml(g.name)}</option>`;
            });
            groupSelect.innerHTML = options;

            groupSelect.addEventListener('change', (e) => {
                currentGroupId = e.target.value;
                loadTrips();
            });

            loadTrips();
        }

        // ========== è¼‰å…¥è¡Œç¨‹ ==========
        async function loadTrips() {
            if (!currentUser || !currentGroupId) return;

            try {
                const tripsRef = db.collection('groups')
                    .doc(currentGroupId)
                    .collection('destinations')
                    .orderBy('time', 'asc');

                const snapshot = await tripsRef.get();

                loadingEl.style.display = 'none';

                if (snapshot.empty) {
                    tripListContainer.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                const tripsByDate = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let dateStr = 'æœªæŒ‡å®šæ—¥æœŸ';
                    if (data.time) {
                        const parts = data.time.split('T');
                        dateStr = parts[0];
                    }

                    if (!tripsByDate[dateStr]) tripsByDate[dateStr] = [];
                    tripsByDate[dateStr].push({
                        id: doc.id,
                        title: data.name || 'ç„¡æ¨™é¡Œ',
                        destination: data.destination || '',
                        time: data.time || '',
                        lat: data.lat || null,
                        lng: data.lng || null,
                        notes: data.notes || ''
                    });
                });

                const sortedDates = Object.keys(tripsByDate).sort((a,b) => a.localeCompare(b));

                let html = '';
                for (let date of sortedDates) {
                    let displayDate = date;
                    if (date !== 'æœªæŒ‡å®šæ—¥æœŸ') {
                        try {
                            displayDate = new Date(date + 'T12:00:00').toLocaleDateString('zh-TW', {
                                year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
                            });
                        } catch (e) {}
                    }
                    html += `<div class="date-group">ğŸ“… ${displayDate}</div>`;

                    tripsByDate[date].forEach(trip => {
                        let timeDisplay = '';
                        if (trip.time && trip.time.includes('T')) {
                            timeDisplay = trip.time.split('T')[1].substring(0,5);
                        }

                        html += `
                            <div class="trip-card" data-id="${trip.id}">
                                <div class="trip-info">
                                    <div class="trip-title">${escapeHtml(trip.title)}</div>
                                    <div class="trip-meta">
                                        ${trip.destination ? `<span>ğŸ“ ${escapeHtml(trip.destination)}</span>` : ''}
                                        ${timeDisplay ? `<span>ğŸ•’ ${timeDisplay}</span>` : ''}
                                        ${trip.notes ? `<span>ğŸ“ ${escapeHtml(trip.notes.substring(0,30))}${trip.notes.length > 30 ? 'â€¦' : ''}</span>` : ''}
                                       
                                    </div>
                                </div>
                                <div class="trip-actions">
                                    ${trip.lat && trip.lng ? `
                                        <button class="icon-btn map-btn" onclick="viewOnMap(${trip.lat}, ${trip.lng}, '${escapeHtml(trip.destination || trip.title)}')" title="åœ¨åœ°åœ–ä¸­æŸ¥çœ‹">ğŸ—ºï¸</button>
                                    ` : ''}
                                    <button class="icon-btn edit" onclick="editTrip('${trip.id}')" title="ç·¨è¼¯è¡Œç¨‹">âœï¸</button>
                                    <button class="icon-btn delete" onclick="deleteTrip('${trip.id}')" title="åˆªé™¤è¡Œç¨‹">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    });
                }

                tripListContainer.innerHTML = html;
                tripListContainer.style.display = 'block';
                emptyState.style.display = 'none';

            } catch (error) {
                console.error('è¼‰å…¥è¡Œç¨‹éŒ¯èª¤:', error);
                showToast('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
                loadingEl.style.display = 'none';
            }
        }

        // ========== åœ¨åœ°åœ–ä¸­æŸ¥çœ‹ ==========
        window.viewOnMap = function(lat, lng, title) {
            // å°‡åœ°é»è³‡è¨Šå­˜å…¥ localStorageï¼Œè®“åœ°åœ–é é¢å¯ä»¥è®€å–
            const locationData = {
                lat: lat,
                lng: lng,
                title: title,
                timestamp: new Date().getTime()
            };
            localStorage.setItem('viewLocation', JSON.stringify(locationData));
            
            // è·³è½‰åˆ°åœ°åœ–é é¢
            window.location.href = 'map.html';
            
            showToast('ğŸ“ æ­£åœ¨é–‹å•Ÿåœ°åœ–...');
        };

        // ========== é–‹å•Ÿæ–°å¢æµ®å±¤ ==========
        openAddModalBtn.addEventListener('click', () => {
            tripForm.reset();
            editingId.value = '';
            editingLat.value = '';
            editingLng.value = '';
            modalTitle.textContent = 'æ–°å¢è¡Œç¨‹';
            const today = new Date().toISOString().split('T')[0];
            tripDate.value = today;
            locationHint.innerHTML = '<span>ğŸ“ é¸æ“‡åœ°é»å¾Œæœƒè‡ªå‹•è¨˜éŒ„åº§æ¨™</span>';
            modal.style.display = 'flex';
            
            setTimeout(() => {
                initAutocomplete();
            }, 300);
        });

        cancelModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
        });

        // ========== å„²å­˜è¡Œç¨‹ ==========
        tripForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || !currentGroupId) return;

            const title = tripTitle.value.trim();
            const date = tripDate.value;
            if (!title || !date) {
                showToast('è«‹å¡«å¯«æ¨™é¡Œèˆ‡æ—¥æœŸ');
                return;
            }

            let timeValue = date;
            if (tripTime.value) {
                timeValue = date + 'T' + tripTime.value;
            }

            const destinationData = {
                name: title,
                destination: tripLocation.value.trim() || '',
                time: timeValue,
                lat: editingLat.value ? parseFloat(editingLat.value) : null,
                lng: editingLng.value ? parseFloat(editingLng.value) : null,
                notes: tripNotes.value.trim() || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid,
                senderId: currentUser.uid
            };

            const saveBtn = document.getElementById('saveTripBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'å„²å­˜ä¸­...';

            try {
                const destinationsRef = db.collection('groups')
                    .doc(currentGroupId)
                    .collection('destinations');

                if (editingId.value) {
                    await destinationsRef.doc(editingId.value).update(destinationData);
                    showToast('è¡Œç¨‹å·²æ›´æ–°');
                } else {
                    await destinationsRef.add(destinationData);
                    showToast('è¡Œç¨‹å·²æ–°å¢');
                }

                modal.style.display = 'none';
                loadTrips();

            } catch (error) {
                console.error('å„²å­˜è¡Œç¨‹éŒ¯èª¤:', error);
                showToast('å„²å­˜å¤±æ•—ï¼š' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'å„²å­˜è¡Œç¨‹';
            }
        });

        // ========== ç·¨è¼¯è¡Œç¨‹ ==========
        window.editTrip = async (tripId) => {
            if (!currentUser || !currentGroupId) return;

            try {
                const docRef = db.collection('groups')
                    .doc(currentGroupId)
                    .collection('destinations')
                    .doc(tripId);
                const doc = await docRef.get();
                if (!doc.exists) {
                    showToast('è¡Œç¨‹ä¸å­˜åœ¨');
                    return;
                }
                const data = doc.data();

                let dateVal = '', timeVal = '';
                if (data.time) {
                    if (data.time.includes('T')) {
                        const parts = data.time.split('T');
                        dateVal = parts[0];
                        timeVal = parts[1] ? parts[1].substring(0,5) : '';
                    } else {
                        dateVal = data.time;
                    }
                }

                tripTitle.value = data.name || '';
                tripDate.value = dateVal;
                tripTime.value = timeVal;
                tripLocation.value = data.destination || '';
                tripNotes.value = data.notes || '';
                editingId.value = tripId;
                editingLat.value = data.lat || '';
                editingLng.value = data.lng || '';
                modalTitle.textContent = 'ç·¨è¼¯è¡Œç¨‹';

                if (data.lat && data.lng) {
                    locationHint.innerHTML = `
                        <span>ğŸ“ å·²è¨˜éŒ„åº§æ¨™</span>
                        <span class="coord">${data.lat.toFixed(6)}, ${data.lng.toFixed(6)}</span>
                    `;
                } else {
                    locationHint.innerHTML = '<span>ğŸ“ é¸æ“‡åœ°é»å¾Œæœƒè‡ªå‹•è¨˜éŒ„åº§æ¨™</span>';
                }

                modal.style.display = 'flex';
                
                setTimeout(() => {
                    initAutocomplete();
                }, 300);

            } catch (error) {
                console.error('è®€å–è¡Œç¨‹éŒ¯èª¤:', error);
                showToast('è®€å–å¤±æ•—ï¼š' + error.message);
            }
        };

        // ========== åˆªé™¤è¡Œç¨‹ ==========
        window.deleteTrip = async (tripId) => {
            if (!currentUser || !currentGroupId) return;
            if (!confirm('ç¢ºå®šåˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ')) return;

            try {
                await db.collection('groups')
                    .doc(currentGroupId)
                    .collection('destinations')
                    .doc(tripId)
                    .delete();
                showToast('è¡Œç¨‹å·²åˆªé™¤');
                loadTrips();
            } catch (error) {
                console.error('åˆªé™¤è¡Œç¨‹éŒ¯èª¤:', error);
                showToast('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        };

        // ========== å·¥å…·å‡½å¼ ==========
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>